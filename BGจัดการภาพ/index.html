<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TR BG Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
/* ===================== VARIABLES ===================== */
:root{
  --bg:#0d1117;--surface:#161b22;--card:#21262d;--border:#30363d;
  --accent:#2f81f7;--accent-hover:#1f6feb;--accent-light:rgba(47,129,247,0.12);
  --success:#3fb950;--error:#f85149;--warning:#d29922;--purple:#bc8cff;--gold:#e3b341;
  --text:#e6edf3;--text-muted:#7d8590;--text-subtle:#484f58;
  --shadow:0 8px 24px rgba(1,4,9,0.4);--shadow-sm:0 2px 8px rgba(1,4,9,0.3);
  --radius:10px;--sidebar-w:220px;
  --topbar-h:52px;--bottomnav-h:64px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
button,input,select{font-family:'Sarabun',sans-serif}

/* ===================== LOGIN ===================== */
#loginScreen{
  position:fixed;inset:0;z-index:9999;
  background:linear-gradient(135deg,#0d1117 0%,#161b22 50%,#0d1117 100%);
  display:flex;align-items:center;justify-content:center;padding:20px;
}
.login-box{
  background:var(--surface);border:1px solid var(--border);border-radius:20px;
  padding:40px 36px;width:100%;max-width:400px;box-shadow:var(--shadow);
  text-align:center;position:relative;overflow:hidden;
}
.login-box::before{
  content:'';position:absolute;top:-60px;left:50%;transform:translateX(-50%);
  width:200px;height:200px;
  background:radial-gradient(circle,rgba(47,129,247,0.15) 0%,transparent 70%);
  pointer-events:none;
}
.login-logo{
  width:60px;height:60px;background:linear-gradient(135deg,var(--accent),var(--purple));
  border-radius:16px;display:inline-flex;align-items:center;justify-content:center;
  font-size:26px;margin-bottom:16px;box-shadow:0 8px 24px rgba(47,129,247,0.3);
}
.login-title{font-size:24px;font-weight:800;margin-bottom:4px}
.login-subtitle{color:var(--text-muted);font-size:13px;margin-bottom:24px}
.login-badge{
  display:flex;align-items:center;gap:6px;justify-content:center;
  background:rgba(63,185,80,0.1);border:1px solid rgba(63,185,80,0.25);
  color:var(--success);font-size:11px;font-weight:700;
  font-family:'JetBrains Mono',monospace;
  padding:5px 14px;border-radius:100px;margin-bottom:24px;
}
.api-dot{width:6px;height:6px;border-radius:50%;background:var(--success);animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.login-label{text-align:left;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.login-input-wrap{position:relative;margin-bottom:14px}
.login-input{
  width:100%;padding:12px 40px 12px 14px;background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:14px;
  outline:none;transition:border-color 0.2s,box-shadow 0.2s;letter-spacing:2px;
}
.login-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(47,129,247,0.15)}
.login-eye{
  position:absolute;right:10px;top:50%;transform:translateY(-50%);
  background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:15px;padding:4px;
}
.login-btn{
  width:100%;padding:13px;background:linear-gradient(135deg,var(--accent),#388bfd);
  border:none;border-radius:var(--radius);color:#fff;font-size:15px;font-weight:700;
  cursor:pointer;transition:all 0.2s;box-shadow:0 4px 16px rgba(47,129,247,0.3);
}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(47,129,247,0.4)}
.login-error{
  color:var(--error);font-size:13px;margin-top:10px;
  background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.2);
  padding:8px 12px;border-radius:8px;display:none;
}

/* ===================== APP SHELL ===================== */
#app{display:none;flex:1;overflow:hidden;flex-direction:column}
#app.visible{display:flex}

/* ===================== TOPBAR ===================== */
.topbar{
  height:var(--topbar-h);background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;flex-shrink:0;gap:0;
}
.topbar-logo{
  display:flex;align-items:center;gap:8px;text-decoration:none;flex-shrink:0;
}
.topbar-logo-icon{
  width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--purple));
  border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;
}
.topbar-logo-name{font-size:16px;font-weight:800;color:var(--text)}
.topbar-spacer{flex:1}
.topbar-user{display:flex;align-items:center;gap:8px}
.topbar-avatar{
  width:32px;height:32px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent),var(--purple));
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:800;color:#fff;cursor:pointer;
  border:2px solid var(--border);transition:border-color 0.2s;flex-shrink:0;
}
.topbar-avatar:hover{border-color:var(--accent)}
.topbar-avatar.admin{background:linear-gradient(135deg,var(--gold),var(--warning))}
.topbar-user-info{display:flex;flex-direction:column;align-items:flex-end}
.topbar-username{font-size:13px;font-weight:700;line-height:1.2}
.topbar-role{font-size:10px;color:var(--text-muted)}
.topbar-logout{
  background:none;border:none;color:var(--text-muted);cursor:pointer;
  font-size:18px;padding:6px;border-radius:6px;transition:all 0.15s;
}
.topbar-logout:hover{color:var(--error);background:rgba(248,81,73,0.1)}

/* API Status pill in topbar */
.topbar-api{
  display:flex;align-items:center;gap:5px;
  background:rgba(63,185,80,0.08);border:1px solid rgba(63,185,80,0.2);
  border-radius:100px;padding:4px 10px;
  font-size:10px;font-weight:700;color:var(--success);
  font-family:'JetBrains Mono',monospace;
  margin-right:10px;
}

/* ===================== BODY AREA ===================== */
.app-body{
  flex:1;display:flex;overflow:hidden;
  /* leave space for bottom nav on mobile */
}

/* ===================== SIDEBAR (desktop only) ===================== */
.sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;
}
.sidebar-section-title{
  font-size:10px;font-weight:700;color:var(--text-subtle);
  text-transform:uppercase;letter-spacing:1.5px;
  padding:12px 14px 4px;margin-top:4px;
}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;cursor:pointer;color:var(--text-muted);
  font-size:14px;font-weight:500;transition:all 0.15s;
  user-select:none;position:relative;
}
.nav-item:hover{background:var(--card);color:var(--text)}
.nav-item.active{
  background:var(--accent-light);color:var(--accent);font-weight:700;
}
.nav-item.active::before{
  content:'';position:absolute;left:0;top:4px;bottom:4px;
  width:3px;background:var(--accent);border-radius:0 3px 3px 0;
}
.nav-icon{font-size:18px;width:24px;text-align:center;flex-shrink:0}
.nav-badge{
  margin-left:auto;background:var(--accent);color:#fff;
  font-size:10px;font-weight:700;padding:2px 7px;
  border-radius:100px;min-width:20px;text-align:center;
}
.nav-badge.green{background:var(--success)}
.nav-badge.gold{background:var(--gold)}
.sidebar-footer{border-top:1px solid var(--border);padding:10px;margin-top:auto}

/* ===================== CONTENT ===================== */
.content-wrap{flex:1;overflow:hidden;display:flex;flex-direction:column}
.content{flex:1;overflow-y:auto;padding:20px}

/* Panel system */
.panel{display:none}
.panel.active{display:block}
.panel-fullh{height:100%}
#panel-pixel.active{display:flex;flex-direction:column;height:100%;overflow:hidden}

/* Section headers */
.page-header{margin-bottom:20px}
.page-title{font-size:20px;font-weight:800;margin-bottom:3px}
.page-sub{font-size:13px;color:var(--text-muted)}

/* ===================== CARDS ===================== */
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.card{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:18px;cursor:pointer;transition:all 0.2s;
}
.card:hover{border-color:var(--accent);box-shadow:var(--shadow-sm);transform:translateY(-2px)}
.card-icon{font-size:30px;margin-bottom:10px}
.card-title{font-size:15px;font-weight:700;margin-bottom:5px}
.card-desc{font-size:12px;color:var(--text-muted);line-height:1.5}

/* Action row */
.action-row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:18px}

/* ===================== BUTTONS ===================== */
.btn{
  padding:9px 16px;border:none;border-radius:8px;
  font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;
  display:inline-flex;align-items:center;gap:6px;text-decoration:none;
}
.btn-primary{background:linear-gradient(135deg,var(--accent),#388bfd);color:#fff;box-shadow:0 2px 8px rgba(47,129,247,0.25)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(47,129,247,0.35)}
.btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);background:var(--surface)}
.btn-success{background:var(--success);color:#fff}
.btn-success:hover{filter:brightness(1.1)}
.btn-danger{background:var(--error);color:#fff}
.btn-danger:hover{filter:brightness(1.1)}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-icon{padding:8px;width:36px;height:36px;justify-content:center}

/* ===================== FORMS ===================== */
.form-row{margin-bottom:14px}
.form-label{display:block;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px}
.form-input,.form-select{
  width:100%;padding:9px 11px;background:var(--card);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-size:14px;outline:none;
  transition:border-color 0.2s,box-shadow 0.2s;
}
.form-input:focus,.form-select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(47,129,247,0.1)}
.form-input[type="range"]{
  padding:0;height:5px;background:var(--border);border:none;border-radius:3px;appearance:none;
}
.form-input[type="range"]::-webkit-slider-thumb{
  appearance:none;width:16px;height:16px;background:var(--accent);border-radius:50%;cursor:pointer;
}

/* ===================== REMOVE BG PANEL ===================== */
.rmbg-layout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.preview-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px}
.preview-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted)}
.preview-img{
  width:100%;aspect-ratio:1;
  background:repeating-conic-gradient(var(--card) 0% 25%,var(--surface) 0% 50%) 0 0/18px 18px;
  border-radius:8px;display:flex;align-items:center;justify-content:center;
  position:relative;overflow:auto;
}
.preview-img img{max-width:100%;max-height:100%;object-fit:contain}
.preview-placeholder{color:var(--text-subtle);font-size:12px;text-align:center;padding:20px}

/* Manual edit toolbar */
.rmbg-toolbar{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;
}
.rmbg-tool-btn{
  display:flex;align-items:center;gap:5px;
  background:var(--card);border:1px solid var(--border);
  border-radius:7px;padding:6px 11px;
  cursor:pointer;font-size:12px;font-weight:600;
  transition:all 0.15s;color:var(--text-muted);white-space:nowrap;
}
.rmbg-tool-btn:hover{border-color:var(--accent);color:var(--text)}
.rmbg-tool-btn.active{background:var(--accent-light);border-color:var(--accent);color:var(--accent)}
.rmbg-divider{width:1px;height:24px;background:var(--border);flex-shrink:0}
.rmbg-canvas-wrap{
  width:100%;aspect-ratio:1;
  background:repeating-conic-gradient(var(--card) 0% 25%,var(--surface) 0% 50%) 0 0/18px 18px;
  border-radius:8px;overflow:auto;display:flex;align-items:center;justify-content:center;position:relative;
}
#rmbgResultCanvas{max-width:100%;max-height:100%;display:none;cursor:crosshair}

/* ‡∏ã‡∏π‡∏°‡∏õ‡∏∏‡πà‡∏° */
.zoom-wrap{position:relative;width:100%}
.zoom-controls{
  position:absolute;bottom:8px;right:8px;z-index:10;
  display:flex;align-items:center;gap:4px;
  background:rgba(13,17,23,0.75);backdrop-filter:blur(4px);
  border:1px solid var(--border);border-radius:8px;padding:4px 6px;
}
.zoom-btn{
  width:26px;height:26px;border:none;background:var(--card);
  border-radius:6px;color:var(--text);font-size:16px;font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all 0.15s;flex-shrink:0;
}
.zoom-btn:hover{background:var(--accent);color:#fff}
.zoom-pct{font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--text);min-width:36px;text-align:center}
.zoom-reset{font-size:10px;padding:0 6px}

/* container ‡∏ó‡∏µ‡πà scroll/pan ‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ zoom */
.zoomable-img{
  width:100%;height:100%;overflow:auto;
  display:flex;align-items:center;justify-content:center;
}
.zoomable-img img,.zoomable-canvas{
  transition:transform 0.2s;transform-origin:center center;
}

/* ===================== PIXEL EDITOR ===================== */
.px-start{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;padding:30px 20px;gap:20px;text-align:center;overflow-y:auto;
}
.px-start-title{font-size:20px;font-weight:800}
.px-start-sub{font-size:13px;color:var(--text-muted)}
.px-presets{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.px-preset{
  background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:8px 14px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.15s;
  display:flex;flex-direction:column;align-items:center;gap:2px;
}
.px-preset:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.px-preset span{font-size:10px;color:var(--text-muted)}
.px-preset:hover span{color:var(--accent)}
.px-divider{display:flex;align-items:center;gap:10px;width:100%;max-width:380px}
.px-divider::before,.px-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.px-divider span{font-size:11px;color:var(--text-muted)}
.px-custom-row{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;justify-content:center}
.px-custom-field{display:flex;flex-direction:column;gap:4px;align-items:center}
.px-custom-field label{font-size:11px;color:var(--text-muted);font-weight:700}
.px-custom-field input{
  width:76px;padding:8px;background:var(--card);border:1px solid var(--border);
  border-radius:6px;color:var(--text);font-size:15px;font-weight:700;text-align:center;outline:none;
}
.px-custom-field input:focus{border-color:var(--accent)}
.px-upload-area{
  display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;
  background:var(--surface);border:2px dashed var(--border);
  border-radius:12px;padding:18px 28px;transition:all 0.15s;width:100%;max-width:280px;
}
.px-upload-area:hover{border-color:var(--accent);background:var(--accent-light)}
.px-upload-icon{font-size:28px}
.px-upload-label{font-size:13px;font-weight:600}
.px-upload-sub{font-size:11px;color:var(--text-muted)}

/* Editor layout */
.px-editor{display:none;flex:1;gap:0;overflow:hidden;height:100%}
.px-editor.visible{display:flex}
.px-sidebar{
  width:260px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;
}
.px-viewport{
  flex:1;background:var(--card);overflow:auto;
  display:flex;align-items:center;justify-content:center;
  position:relative;
}
.px-canvas-wrap{display:inline-block;box-shadow:var(--shadow);border-radius:2px;overflow:hidden;position:relative}
#pxCanvasEl{display:block;image-rendering:pixelated;image-rendering:crisp-edges;cursor:crosshair}

.px-section{padding:12px 12px 10px;border-bottom:1px solid var(--border)}
.px-section-label{font-size:10px;font-weight:700;color:var(--text-subtle);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
.px-tool-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
.px-tool-btn{
  background:var(--card);border:1px solid var(--border);border-radius:6px;
  padding:8px 4px;font-size:18px;cursor:pointer;transition:all 0.15s;
  display:flex;flex-direction:column;align-items:center;gap:1px;position:relative;
}
.px-tool-btn .tlabel{font-size:8px;font-weight:700;color:var(--text-muted)}
.px-tool-btn .tkey{
  position:absolute;top:2px;right:3px;
  font-size:7px;font-family:'JetBrains Mono',monospace;
  color:var(--text-subtle);font-weight:700;
}
.px-tool-btn:hover{background:var(--surface);border-color:var(--accent)}
.px-tool-btn.active{background:var(--accent-light);border-color:var(--accent)}
.px-tool-btn.active .tlabel,.px-tool-btn.active .tkey{color:var(--accent)}

.px-color-display{
  display:flex;align-items:center;gap:8px;margin-bottom:8px;
  background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;
}
.px-color-box{width:36px;height:36px;border-radius:6px;border:2px solid var(--border);flex-shrink:0}
.px-color-hex{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700}
.px-color-label{font-size:9px;color:var(--text-muted);margin-bottom:1px}
.px-color-picker{width:100%;height:32px;border:1px solid var(--border);border-radius:6px;cursor:pointer;margin-bottom:6px}

.px-palette-grid{
  display:grid;grid-template-columns:repeat(8,1fr);gap:4px;
  max-height:120px;overflow-y:auto;padding:2px;margin-bottom:6px;
}
.px-color-swatch{
  width:100%;aspect-ratio:1;border-radius:3px;cursor:pointer;
  border:2px solid transparent;transition:all 0.15s;position:relative;
}
.px-color-swatch:hover{border-color:var(--text-muted);transform:scale(1.1)}
.px-color-swatch.active{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-light)}
.px-color-swatch .del{
  position:absolute;top:-3px;right:-3px;width:12px;height:12px;
  background:var(--error);border-radius:50%;
  display:none;align-items:center;justify-content:center;
  font-size:8px;color:#fff;cursor:pointer;z-index:1;
}
.px-color-swatch:hover .del{display:flex}

.px-info-row{display:flex;gap:6px}
.px-info-chip{
  flex:1;background:var(--card);border:1px solid var(--border);
  border-radius:6px;padding:6px;text-align:center;
}
.px-info-chip-label{font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.px-info-chip-value{font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace}
.px-zoom-row{display:flex;align-items:center;gap:6px;margin-top:8px}
.px-zoom-btn{
  width:28px;height:28px;background:var(--card);border:1px solid var(--border);
  border-radius:6px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:14px;transition:all 0.15s;flex-shrink:0;
}
.px-zoom-btn:hover{background:var(--surface);border-color:var(--accent)}
.px-zoom-label{flex:1;text-align:center;font-family:'JetBrains Mono',monospace;font-weight:700;font-size:12px}

/* Keyboard shortcut hints */
.px-shortcuts{
  background:rgba(47,129,247,0.05);border:1px solid rgba(47,129,247,0.15);
  border-radius:8px;padding:8px;
  display:grid;grid-template-columns:1fr 1fr;gap:3px;
}
.sc-item{display:flex;align-items:center;gap:5px;font-size:10px}
.sc-key{
  background:var(--card);border:1px solid var(--border);
  border-radius:4px;padding:1px 5px;
  font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:var(--text);
  white-space:nowrap;flex-shrink:0;
}
.sc-desc{color:var(--text-muted)}

/* ===================== GALLERY ===================== */
.gallery-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;
}
.gallery-item{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  overflow:hidden;transition:all 0.2s;cursor:pointer;
}
.gallery-item:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:var(--shadow)}
.gallery-thumb{
  width:100%;aspect-ratio:1;
  background:repeating-conic-gradient(var(--card) 0% 25%,var(--surface) 0% 50%) 0 0/18px 18px;
  display:flex;align-items:center;justify-content:center;overflow:hidden;
}
.gallery-thumb img{max-width:100%;max-height:100%;object-fit:contain}
.gallery-info{padding:10px}
.gallery-name{font-size:12px;font-weight:700;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gallery-date{font-size:10px;color:var(--text-muted);margin-bottom:6px}
.gallery-actions{display:flex;gap:5px}
.gallery-empty{text-align:center;padding:60px 20px;color:var(--text-muted)}

/* ===================== STATS ===================== */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center}
.stat-icon{font-size:26px;margin-bottom:6px}
.stat-value{font-size:26px;font-weight:800;font-family:'JetBrains Mono',monospace;margin-bottom:3px}
.stat-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}

/* ===================== LOGS ===================== */
.logs-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;max-height:500px;overflow-y:auto}
.log-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;font-size:12px;margin-bottom:4px;background:var(--card);animation:slideIn 0.3s ease}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.log-time{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-subtle);flex-shrink:0}
.log-icon{font-size:14px;flex-shrink:0}
.log-msg{flex:1;color:var(--text-muted)}
.log-item.success .log-icon{color:var(--success)}
.log-item.error .log-icon{color:var(--error)}
.log-item.info .log-icon{color:var(--accent)}

/* ===================== KEY MANAGEMENT ===================== */
.key-list{margin-top:16px}
.key-item{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:10px;
}
.key-icon{width:38px;height:38px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.key-details{flex:1}
.key-name{font-size:14px;font-weight:700;margin-bottom:3px}
.key-code{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--text-muted)}
.key-status{padding:3px 10px;border-radius:100px;font-size:10px;font-weight:700;background:var(--success);color:#fff}
.key-status.inactive{background:var(--text-subtle)}

/* ===================== MODALS ===================== */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;
  display:none;align-items:center;justify-content:center;padding:20px;
}
.modal-overlay.active{display:flex}
.modal{
  background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:24px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);
}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.modal-title{font-size:17px;font-weight:800}
.modal-close{
  background:none;border:none;color:var(--text-muted);font-size:22px;cursor:pointer;
  width:30px;height:30px;display:flex;align-items:center;justify-content:center;
  border-radius:6px;transition:all 0.15s;
}
.modal-close:hover{background:var(--card);color:var(--text)}

/* ===================== TOAST ===================== */
#toastContainer{position:fixed;top:60px;right:16px;z-index:10000;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:10px 14px;box-shadow:var(--shadow);display:flex;align-items:center;gap:8px;
  min-width:240px;animation:toastIn 0.3s ease;pointer-events:all;
}
@keyframes toastIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
.toast-icon{font-size:18px;flex-shrink:0}
.toast-msg{flex:1;font-size:12px;font-weight:500}
.toast.success{border-color:var(--success)}.toast.success .toast-icon{color:var(--success)}
.toast.error{border-color:var(--error)}.toast.error .toast-icon{color:var(--error)}
.toast.info{border-color:var(--accent)}.toast.info .toast-icon{color:var(--accent)}

/* ===================== BOTTOM NAV (mobile) ===================== */
.bottom-nav{
  display:none;height:var(--bottomnav-h);
  background:var(--surface);border-top:1px solid var(--border);
  flex-shrink:0;
}
.bottom-nav-inner{display:flex;height:100%}
.bnav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;cursor:pointer;color:var(--text-muted);transition:all 0.15s;
  font-size:11px;font-weight:600;user-select:none;position:relative;
  border:none;background:none;
}
.bnav-item:hover{color:var(--text)}
.bnav-item.active{color:var(--accent)}
.bnav-item.active::before{
  content:'';position:absolute;top:0;left:20%;right:20%;
  height:2px;background:var(--accent);border-radius:0 0 3px 3px;
}
.bnav-icon{font-size:22px;line-height:1}
.bnav-badge{
  position:absolute;top:8px;right:50%;margin-right:-22px;
  background:var(--accent);color:#fff;font-size:8px;font-weight:700;
  padding:1px 4px;border-radius:100px;min-width:14px;text-align:center;
}
.bnav-badge.green{background:var(--success)}

/* ===================== RESPONSIVE ===================== */
@media(max-width:768px){
  .sidebar{display:none}
  .bottom-nav{display:block}
  .app-body{flex-direction:column}
  .content{padding:14px}
  .rmbg-layout{grid-template-columns:1fr}
  .gallery-grid{grid-template-columns:repeat(2,1fr)}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .card-grid{grid-template-columns:1fr}
  .px-editor{flex-direction:column}
  .px-sidebar{width:100%;max-height:220px;border-right:none;border-bottom:1px solid var(--border)}
  .px-tool-grid{grid-template-columns:repeat(8,1fr)}
  .topbar-logo-name{display:none}
  .topbar-user-info{display:none}
  .topbar-api{display:none}
  /* make more room for content */
  .app-body{
    height:calc(100vh - var(--topbar-h) - var(--bottomnav-h));
    overflow:hidden;
  }
  /* pixel editor full height on mobile */
  #panel-pixel.active{height:calc(100vh - var(--topbar-h) - var(--bottomnav-h))}
}
@media(min-width:769px){
  .topbar-logout-mobile{display:none}
  #panel-pixel.active{height:calc(100vh - var(--topbar-h))}
  .app-body{height:calc(100vh - var(--topbar-h))}
}
@media(max-width:480px){
  .gallery-grid{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:1fr}
  .px-sidebar{max-height:180px}
}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text-subtle)}

/* Settings */
.settings-section{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px}
.settings-title{font-size:14px;font-weight:700;margin-bottom:12px}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
.settings-row:last-child{border-bottom:none;padding-bottom:0}
.settings-key{font-size:13px;font-weight:600}
.settings-val{font-size:12px;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
</style>
</head>
<body>

<!-- ===================== LOGIN ===================== -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">üé®</div>
    <div class="login-title">TR BG Studio</div>
    <div class="login-subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û</div>
    <div class="login-badge">
      <div class="api-dot"></div>
      <span>Key API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
    </div>
    <div class="login-label">üîë Access Key</div>
    <div class="login-input-wrap">
      <input type="password" id="loginKey" class="login-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
      <button class="login-eye" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
    </div>
    <button class="login-btn" onclick="attemptLogin()">üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div class="login-error" id="loginError">‚ùå Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>
  </div>
</div>

<!-- ===================== APP ===================== -->
<div id="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-logo">
      <div class="topbar-logo-icon">üé®</div>
      <div class="topbar-logo-name">TR BG Studio</div>
    </div>
    <div class="topbar-spacer"></div>
    <div class="topbar-api">
      <div class="api-dot"></div>
      <span>API SECURE</span>
    </div>
    <div class="topbar-user">
      <div class="topbar-user-info">
        <div class="topbar-username" id="userName">Member</div>
        <div class="topbar-role" id="userRole">Member</div>
      </div>
      <div class="topbar-avatar" id="userAvatar">M</div>
      <button class="topbar-logout" onclick="logout()" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">üö™</button>
    </div>
  </div>

  <!-- BODY -->
  <div class="app-body">
    <!-- SIDEBAR (desktop) -->
    <div class="sidebar">
      <div class="sidebar-section-title">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>
      <div class="nav-item active" onclick="showPanel('home',this)">
        <span class="nav-icon">üè†</span><span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
      </div>
      <div class="nav-item" onclick="showPanel('remove-bg',this)">
        <span class="nav-icon">‚úÇÔ∏è</span><span>‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</span>
        <span class="nav-badge green">AI</span>
      </div>
      <div class="nav-item" onclick="showPanel('pixel',this)">
        <span class="nav-icon">üéÆ</span><span>Pixel Art Editor</span>
      </div>
      <div class="nav-item" onclick="showPanel('gallery',this)">
        <span class="nav-icon">üñºÔ∏è</span><span>‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</span>
        <span class="nav-badge" id="galleryCount">0</span>
      </div>
      <div class="sidebar-section-title">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
      <div class="nav-item" onclick="showPanel('stats',this)">
        <span class="nav-icon">üìà</span><span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
      </div>
      <div class="nav-item" onclick="showPanel('logs',this)">
        <span class="nav-icon">üìã</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
      </div>
      <div class="sidebar-section-title" id="adminSection" style="display:none">üëë ADMIN</div>
      <div class="nav-item" id="adminKeysNav" style="display:none" onclick="showPanel('admin-keys',this)">
        <span class="nav-icon">üîë</span><span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå</span>
        <span class="nav-badge gold">ADMIN</span>
      </div>
      <div class="sidebar-section-title">‚öôÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
      <div class="nav-item" onclick="showPanel('settings',this)">
        <span class="nav-icon">‚öôÔ∏è</span><span>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
      </div>
      <div class="sidebar-footer">
        <div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--card);border-radius:8px">
          <div class="topbar-avatar" id="sidebarAvatar" style="width:28px;height:28px;font-size:11px">M</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="sidebarName">Member</div>
            <div style="font-size:10px;color:var(--text-muted)" id="sidebarRole">Member</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="content-wrap">
      <div class="content" id="contentArea">

        <!-- HOME -->
        <div id="panel-home" class="panel active">
          <div class="page-header">
            <div class="page-title">üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="welcomeName">Member</span>!</div>
            <div class="page-sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
          </div>
          <div class="card-grid">
            <div class="card" onclick="showPanel('remove-bg')">
              <div class="card-icon">‚úÇÔ∏è</div>
              <div class="card-title">‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
              <div class="card-desc">‡πÉ‡∏ä‡πâ AI ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ Manual Edit</div>
            </div>
            <div class="card" onclick="showPanel('pixel')">
              <div class="card-icon">üéÆ</div>
              <div class="card-title">Pixel Art Editor</div>
              <div class="card-desc">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Pixel Art ‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡∏£‡∏ö ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>
            </div>
            <div class="card" onclick="showPanel('gallery')">
              <div class="card-icon">üñºÔ∏è</div>
              <div class="card-title">‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</div>
              <div class="card-desc">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏†‡∏≤‡∏û‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏î‡πâ</div>
            </div>
            <div class="card" onclick="showPanel('stats')">
              <div class="card-icon">üìä</div>
              <div class="card-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
              <div class="card-desc">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Real-time</div>
            </div>
            <div class="card" onclick="showPanel('logs')">
              <div class="card-icon">üìã</div>
              <div class="card-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
              <div class="card-desc">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="card" id="homeAdminCard" style="display:none" onclick="showPanel('admin-keys')">
              <div class="card-icon">üîë</div>
              <div class="card-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå</div>
              <div class="card-desc">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</div>
            </div>
          </div>
        </div>

        <!-- REMOVE BG -->
        <div id="panel-remove-bg" class="panel">
          <div class="page-header">
            <div class="page-title">‚úÇÔ∏è ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
            <div class="page-sub">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ‚Üí AI ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‚Üí ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠ ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
          </div>
          <div class="action-row">
            <button class="btn btn-secondary" onclick="document.getElementById('bgInput').click()">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
            <button class="btn btn-primary" onclick="processRemoveBg()">üöÄ ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á AI</button>
            <button class="btn btn-success" onclick="downloadNoBg()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PNG</button>
          </div>
          <input type="file" id="bgInput" accept="image/*" style="display:none" onchange="loadImageForBg(this)">
          <!-- Manual toolbar -->
          <div class="rmbg-toolbar" id="rmbgToolbar" style="display:none;margin-bottom:14px">
            <span style="font-size:11px;font-weight:700;color:var(--text-muted);flex-shrink:0">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á:</span>
            <div class="rmbg-tool-btn active" id="rmbgToolErase" onclick="setRmbgTool('erase')">üßπ ‡∏•‡∏ö</div>
            <div class="rmbg-tool-btn" id="rmbgToolRestore" onclick="setRmbgTool('restore')">‚úÖ ‡∏Ñ‡∏∑‡∏ô</div>
            <div class="rmbg-tool-btn" id="rmbgToolMagic" onclick="setRmbgTool('magic')">ü™Ñ Magic</div>
            <div class="rmbg-divider"></div>
            <span style="font-size:11px;color:var(--text-muted);flex-shrink:0">‡∏Ç‡∏ô‡∏≤‡∏î</span>
            <input type="range" class="form-input" id="rmbgBrushSize" min="5" max="80" value="20" oninput="updateBrushSizeLabel(this.value)" style="width:80px;height:5px">
            <span id="rmbgBrushSizeLabel" style="font-size:11px;font-family:'JetBrains Mono',monospace;min-width:22px">20</span>
            <div class="rmbg-tolerance-wrap" id="rmbgToleranceWrap" style="display:none;align-items:center;gap:5px">
              <span style="font-size:11px;color:var(--text-muted)">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</span>
              <input type="range" class="form-input" id="rmbgTolerance" min="10" max="200" value="60" oninput="updateToleranceLabel(this.value)" style="width:80px;height:5px">
              <span id="rmbgToleranceLabel" style="font-size:11px;font-family:'JetBrains Mono',monospace;min-width:22px">60</span>
            </div>
            <div class="rmbg-divider"></div>
            <button class="btn btn-sm btn-secondary" onclick="rmbgUndo()">‚Ü©Ô∏è Undo</button>
            <button class="btn btn-sm btn-danger" onclick="rmbgReset()">üîÑ Reset</button>
          </div>
          <div class="rmbg-layout">
            <div class="preview-box">
              <div class="preview-title">üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</div>
              <div class="zoom-wrap">
                <div class="preview-img" id="originalPreview" style="overflow:auto">
                  <div class="preview-placeholder">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
                </div>
                <div class="zoom-controls">
                  <button class="zoom-btn" onclick="zoomImg('orig',-1)">‚àí</button>
                  <span class="zoom-pct" id="origZoomPct">100%</span>
                  <button class="zoom-btn" onclick="zoomImg('orig',1)">+</button>
                  <button class="zoom-btn zoom-reset" onclick="zoomImg('orig',0)" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï">‚Ü∫</button>
                </div>
              </div>
            </div>
            <div class="preview-box">
              <div class="preview-title">‚ú® ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå <span style="font-size:10px;color:var(--text-muted);font-weight:400">(‡∏ß‡∏≤‡∏î‡∏ö‡∏ô‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</span></div>
              <div class="zoom-wrap">
                <div class="rmbg-canvas-wrap" id="resultPreviewWrap">
                  <div class="preview-placeholder" id="resultPlaceholder">‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</div>
                  <canvas id="rmbgResultCanvas"></canvas>
                </div>
                <div class="zoom-controls">
                  <button class="zoom-btn" onclick="zoomImg('result',-1)">‚àí</button>
                  <span class="zoom-pct" id="resultZoomPct">100%</span>
                  <button class="zoom-btn" onclick="zoomImg('result',1)">+</button>
                  <button class="zoom-btn zoom-reset" onclick="zoomImg('result',0)" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï">‚Ü∫</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PIXEL ART EDITOR -->
        <div id="panel-pixel" class="panel">
          <!-- Start Screen -->
          <div id="pxStart" class="px-start">
            <div>
              <div style="font-size:44px;margin-bottom:12px">üéÆ</div>
              <div class="px-start-title">Pixel Art Editor</div>
              <div class="px-start-sub" style="margin-top:4px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
            </div>
            <div>
              <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
              <div class="px-presets">
                <div class="px-preset" onclick="pxQuickStart(8,8)">8√ó8<span>‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</span></div>
                <div class="px-preset" onclick="pxQuickStart(16,16)">16√ó16<span>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</span></div>
                <div class="px-preset" onclick="pxQuickStart(32,32)">32√ó32<span>‡∏™‡πÅ‡∏õ‡∏£‡∏ï‡πå</span></div>
                <div class="px-preset" onclick="pxQuickStart(64,64)">64√ó64<span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span></div>
                <div class="px-preset" onclick="pxQuickStart(128,128)">128√ó128<span>‡πÉ‡∏´‡∏ç‡πà</span></div>
              </div>
            </div>
            <div class="px-divider"><span>‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span></div>
            <div class="px-custom-row">
              <div class="px-custom-field">
                <label>‡∏Å‡∏ß‡πâ‡∏≤‡∏á (px)</label>
                <input type="number" id="pxW" value="32" min="4" max="256">
              </div>
              <span style="padding-bottom:10px;color:var(--text-muted);font-size:18px">√ó</span>
              <div class="px-custom-field">
                <label>‡∏™‡∏π‡∏á (px)</label>
                <input type="number" id="pxH" value="32" min="4" max="256">
              </div>
              <button class="btn btn-primary" onclick="pxCreateCanvas()" style="align-self:flex-end;padding:9px 18px">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
            </div>
            <div class="px-divider"><span>‡∏´‡∏£‡∏∑‡∏≠</span></div>
            <div class="px-upload-area" onclick="pxUploadImg()">
              <div class="px-upload-icon">üìÅ</div>
              <div class="px-upload-label">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
              <div class="px-upload-sub">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PNG, JPG, GIF</div>
            </div>
          </div>

          <!-- Editor -->
          <div id="pxEditor" class="px-editor">
            <!-- Sidebar tools -->
            <div class="px-sidebar">
              <!-- Canvas size -->
              <div class="px-section">
                <div class="px-section-label">üìê Canvas</div>
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
                  <input type="number" id="pxW2" class="form-input" value="32" min="4" max="256" style="padding:6px 8px;flex:1">
                  <span style="color:var(--text-muted);font-size:13px">√ó</span>
                  <input type="number" id="pxH2" class="form-input" value="32" min="4" max="256" style="padding:6px 8px;flex:1">
                  <button class="btn btn-sm btn-primary" onclick="pxResizeCanvas()" title="‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î">‚Ü©</button>
                </div>
                <button class="btn btn-sm btn-secondary" style="width:100%" onclick="pxBackToStart()">‚óÄ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Canvas</button>
              </div>

              <!-- Tools -->
              <div class="px-section">
                <div class="px-section-label">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>
                <div class="px-tool-grid">
                  <div class="px-tool-btn active" id="pxtPen" onclick="setPxTool('pen',this)">
                    ‚úèÔ∏è<div class="tlabel">‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤</div><div class="tkey">P</div>
                  </div>
                  <div class="px-tool-btn" id="pxtErase" onclick="setPxTool('erase',this)">
                    üßπ<div class="tlabel">‡∏¢‡∏≤‡∏á‡∏•‡∏ö</div><div class="tkey">E</div>
                  </div>
                  <div class="px-tool-btn" id="pxtFill" onclick="setPxTool('fill',this)">
                    ü™£<div class="tlabel">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏µ</div><div class="tkey">F</div>
                  </div>
                  <div class="px-tool-btn" id="pxtPick" onclick="setPxTool('pick',this)">
                    üíâ<div class="tlabel">‡∏î‡∏π‡∏î‡∏™‡∏µ</div><div class="tkey">K</div>
                  </div>
                  <div class="px-tool-btn" id="pxtLine" onclick="setPxTool('line',this)">
                    üìè<div class="tlabel">‡πÄ‡∏™‡πâ‡∏ô</div><div class="tkey">L</div>
                  </div>
                  <div class="px-tool-btn" id="pxtRect" onclick="setPxTool('rect',this)">
                    ‚¨ú<div class="tlabel">‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°</div><div class="tkey">R</div>
                  </div>
                  <div class="px-tool-btn" id="pxtCircle" onclick="setPxTool('circle',this)">
                    ‚≠ï<div class="tlabel">‡∏ß‡∏á‡∏Å‡∏•‡∏°</div><div class="tkey">C</div>
                  </div>
                  <div class="px-tool-btn" id="pxtMirror" onclick="toggleMirror()">
                    ü™û<div class="tlabel">‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô</div><div class="tkey">M</div>
                  </div>
                </div>
              </div>

              <!-- Color -->
              <div class="px-section">
                <div class="px-section-label">üé® ‡∏™‡∏µ</div>
                <div class="px-color-display">
                  <div class="px-color-box" id="pxCurColorBox" style="background:#000"></div>
                  <div>
                    <div class="px-color-label">HEX CODE</div>
                    <div class="px-color-hex" id="pxColorHex">#000000</div>
                  </div>
                </div>
                <input type="color" id="pxColorPicker" class="px-color-picker" value="#000000" onchange="setPxColor(this.value)">
              </div>

              <!-- Palette -->
              <div class="px-section">
                <div class="px-section-label">üé® ‡∏à‡∏≤‡∏ô‡∏™‡∏µ</div>
                <div class="px-palette-grid" id="pxPaletteGrid"></div>
                <div style="display:flex;gap:5px">
                  <button class="btn btn-sm btn-secondary" style="flex:1" onclick="addColorToPalette()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ</button>
                  <button class="btn btn-sm btn-secondary" style="flex:1" onclick="resetPalette()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                </div>
              </div>

              <!-- Info & Zoom -->
              <div class="px-section">
                <div class="px-section-label">‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                <div class="px-info-row" style="margin-bottom:6px">
                  <div class="px-info-chip">
                    <div class="px-info-chip-label">‡∏Ç‡∏ô‡∏≤‡∏î</div>
                    <div class="px-info-chip-value" id="pxInfoSize">-</div>
                  </div>
                  <div class="px-info-chip">
                    <div class="px-info-chip-label">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>
                    <div class="px-info-chip-value" id="pxInfoTool" style="font-size:11px">‚úèÔ∏è</div>
                  </div>
                </div>
                <div class="px-info-chip" style="margin-bottom:8px">
                  <div class="px-info-chip-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                  <div class="px-info-chip-value" id="pxCoordInfo" style="font-size:11px">-</div>
                </div>
                <div class="px-zoom-row">
                  <div class="px-zoom-btn" onclick="pxZoom(-1)">‚àí</div>
                  <div class="px-zoom-label" id="pxZoomLabel">√ó8</div>
                  <div class="px-zoom-btn" onclick="pxZoom(1)">+</div>
                </div>
              </div>

              <!-- Keyboard shortcuts -->
              <div class="px-section">
                <div class="px-section-label">‚å®Ô∏è ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î</div>
                <div class="px-shortcuts">
                  <div class="sc-item"><span class="sc-key">Ctrl+Z</span><span class="sc-desc">Undo</span></div>
                  <div class="sc-item"><span class="sc-key">Ctrl+Y</span><span class="sc-desc">Redo</span></div>
                  <div class="sc-item"><span class="sc-key">+/-</span><span class="sc-desc">‡∏ã‡∏π‡∏°</span></div>
                  <div class="sc-item"><span class="sc-key">P/E/F</span><span class="sc-desc">‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤/‡∏•‡∏ö/‡πÄ‡∏ó</span></div>
                  <div class="sc-item"><span class="sc-key">L/R/C</span><span class="sc-desc">‡πÄ‡∏™‡πâ‡∏ô/‡∏™‡∏µ‡πà/‡∏ß‡∏á</span></div>
                  <div class="sc-item"><span class="sc-key">K/M</span><span class="sc-desc">‡∏î‡∏π‡∏î‡∏™‡∏µ/‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô</span></div>
                </div>
              </div>

              <!-- Actions -->
              <div class="px-section">
                <div class="px-section-label">üíæ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
                <div style="display:flex;flex-direction:column;gap:5px">
                  <div style="display:flex;gap:5px">
                    <button class="btn btn-sm btn-secondary" style="flex:1" onclick="pxUndo()" title="Undo Ctrl+Z">‚Ü©Ô∏è Undo</button>
                    <button class="btn btn-sm btn-secondary" style="flex:1" onclick="pxRedo()" title="Redo Ctrl+Y">‚Ü™Ô∏è Redo</button>
                  </div>
                  <div style="display:flex;gap:5px">
                    <button class="btn btn-sm btn-secondary" style="flex:1" onclick="pxUploadImg()">üìÅ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
                    <button class="btn btn-sm btn-danger" style="flex:1" onclick="pxClear()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
                  </div>
                  <button class="btn btn-success" style="width:100%;font-size:13px" onclick="pxSave()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
                </div>
              </div>
            </div>

            <!-- Viewport -->
            <div class="px-viewport">
              <div class="px-canvas-wrap">
                <canvas id="pxCanvasEl"></canvas>
              </div>
            </div>
          </div>

          <input type="file" id="pxImgInput" accept="image/*" style="display:none" onchange="pxLoadImage(this)">
        </div>

        <!-- GALLERY -->
        <div id="panel-gallery" class="panel">
          <div class="page-header">
            <div class="page-title">üñºÔ∏è ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</div>
            <div class="page-sub">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 10 ‡∏†‡∏≤‡∏û</div>
          </div>
          <div class="gallery-grid" id="galleryGrid"></div>
          <div class="gallery-empty" id="galleryEmpty">
            <div style="font-size:56px;margin-bottom:12px;opacity:0.4">üñºÔ∏è</div>
            <div style="font-size:16px;font-weight:700;margin-bottom:6px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û</div>
            <div style="font-size:13px">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</div>
          </div>
        </div>

        <!-- STATS -->
        <div id="panel-stats" class="panel">
          <div class="page-header">
            <div class="page-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div class="page-sub">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-time</div>
          </div>
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-icon">üé®</div><div class="stat-value" id="statProcessed">0</div><div class="stat-label">‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</div></div>
            <div class="stat-card"><div class="stat-icon">üíæ</div><div class="stat-value" id="statDownloads">0</div><div class="stat-label">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</div></div>
            <div class="stat-card"><div class="stat-icon">‚ö°</div><div class="stat-value" id="statApiCalls">0</div><div class="stat-label">API Calls</div></div>
            <div class="stat-card"><div class="stat-icon">‚è±Ô∏è</div><div class="stat-value" id="statUptime">0h</div><div class="stat-label">Session Time</div></div>
          </div>
        </div>

        <!-- LOGS -->
        <div id="panel-logs" class="panel">
          <div class="page-header">
            <div class="page-title">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
            <div class="page-sub">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="logs-wrap" id="logsContainer"></div>
        </div>

        <!-- ADMIN KEYS -->
        <div id="panel-admin-keys" class="panel">
          <div class="page-header">
            <div class="page-title">üîë ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå</div>
            <div class="page-sub">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå</div>
          </div>
          <button class="btn btn-primary" onclick="openAddKeyModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà</button>
          <div class="key-list" id="keyList"></div>
        </div>

        <!-- SETTINGS -->
        <div id="panel-settings" class="panel">
          <div class="page-header">
            <div class="page-title">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
            <div class="page-sub">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
          </div>
          <div class="settings-section">
            <div class="settings-title">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
            <div class="settings-row"><span class="settings-key">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span><span class="settings-val" id="settingsUsername">-</span></div>
            <div class="settings-row"><span class="settings-key">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span><span class="settings-val" id="settingsRole">-</span></div>
            <div class="settings-row"><span class="settings-key">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span><span class="settings-val" id="settingsLoginTime">-</span></div>
          </div>
          <div class="settings-section">
            <div class="settings-title">üîê ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
            <div class="settings-row"><span class="settings-key">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™</span><span class="settings-val">SHA-256</span></div>
            <div class="settings-row"><span class="settings-key">Session timeout</span><span class="settings-val">24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></div>
          </div>
          <button class="btn btn-danger" onclick="logout()" style="margin-top:4px">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

      </div><!-- end content -->
    </div><!-- end content-wrap -->
  </div><!-- end app-body -->

  <!-- BOTTOM NAV (mobile) -->
  <div class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="bnav-item active" onclick="showPanel('home',this)" data-panel="home">
        <div class="bnav-icon">üè†</div>
        <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
      </button>
      <button class="bnav-item" onclick="showPanel('remove-bg',this)" data-panel="remove-bg">
        <div class="bnav-icon">‚úÇÔ∏è</div>
        <span>‡∏•‡∏ö BG</span>
      </button>
      <button class="bnav-item" onclick="showPanel('pixel',this)" data-panel="pixel">
        <div class="bnav-icon">üéÆ</div>
        <span>Pixel</span>
      </button>
      <button class="bnav-item" onclick="showPanel('gallery',this)" data-panel="gallery">
        <div class="bnav-icon">üñºÔ∏è</div>
        <span>‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</span>
        <span class="bnav-badge" id="bnavGalleryCount" style="display:none"></span>
      </button>
      <button class="bnav-item" onclick="showPanel('logs',this)" data-panel="logs">
        <div class="bnav-icon">üìã</div>
        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
      </button>
      <button class="bnav-item" onclick="showPanel('settings',this)" data-panel="settings">
        <div class="bnav-icon">‚öôÔ∏è</div>
        <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
      </button>
    </div>
  </div>

</div><!-- end app -->

<!-- MODALS -->
<div class="modal-overlay" id="addKeyModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà</div>
      <button class="modal-close" onclick="closeAddKeyModal()">√ó</button>
    </div>
    <div class="form-row">
      <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
      <input type="text" id="newKeyUsername" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô User01">
    </div>
    <div class="form-row">
      <label class="form-label">‡∏Ñ‡∏µ‡∏¢‡πå</label>
      <input type="text" id="newKeyCode" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô TR-user01">
    </div>
    <div class="form-row">
      <label class="form-label">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</label>
      <select id="newKeyRole" class="form-select">
        <option value="member">Member</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="addNewKey()">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå</button>
  </div>
</div>

<div class="modal-overlay" id="imageModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">üñºÔ∏è ‡∏î‡∏π‡∏†‡∏≤‡∏û</div>
      <button class="modal-close" onclick="closeImageModal()">√ó</button>
    </div>
    <div style="text-align:center">
      <img id="modalImage" style="max-width:100%;border-radius:8px;background:repeating-conic-gradient(#21262d 0% 25%,#161b22 0% 50%) 0 0/16px 16px">
      <div style="margin-top:14px;display:flex;gap:8px;justify-content:center">
        <button class="btn btn-primary" onclick="downloadModalImage()">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
        <button class="btn btn-danger" onclick="deleteModalImage()">üóëÔ∏è ‡∏•‡∏ö</button>
      </div>
    </div>
  </div>
</div>

<div id="toastContainer"></div>

<script>
// ============================================================
// SECURE KEY SYSTEM
// ============================================================
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function initKeys() {
  if (!localStorage.getItem('trStudioKeys')) {
    const defaultKeys = {
      'TaraRook':{username:'Admin',role:'admin',avatar:'A',active:true},
      'TR-user01':{username:'User01',role:'member',avatar:'U1',active:true},
      'TR-user02':{username:'User02',role:'member',avatar:'U2',active:true},
      'TR-user03':{username:'User03',role:'member',avatar:'U3',active:true}
    };
    localStorage.setItem('trStudioKeys', JSON.stringify(defaultKeys));
  }
}
function getKeys(){const d=localStorage.getItem('trStudioKeys');return d?JSON.parse(d):{}}
function saveKeys(k){localStorage.setItem('trStudioKeys',JSON.stringify(k))}

let currentUser=null, sessionStartTime=null, currentImageId=null;

function togglePasswordVisibility(){
  const inp=document.getElementById('loginKey');
  const btn=event.target;
  if(inp.type==='password'){inp.type='text';btn.textContent='üôà';}
  else{inp.type='password';btn.textContent='üëÅÔ∏è';}
}

async function attemptLogin(){
  const keyInput=document.getElementById('loginKey').value.trim();
  const errEl=document.getElementById('loginError');
  if(!keyInput){errEl.style.display='block';errEl.textContent='‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Key';return;}
  const keys=getKeys();
  if(keys[keyInput]&&keys[keyInput].active){
    const kd=keys[keyInput];
    currentUser={key:keyInput,...kd,loginTime:new Date().toISOString()};
    const hashedKey=await sha256(keyInput+Date.now());
    const sessionData=btoa(JSON.stringify({token:hashedKey,key:keyInput,timestamp:Date.now()}));
    localStorage.setItem('trStudioSession',sessionData);
    localStorage.setItem('trStudioSessionVerify',await sha256(sessionData));
    sessionStartTime=Date.now();
    updateUserUI();
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('app').style.display='flex';
    addLog('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: '+currentUser.username,'success');
    showToast('üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö '+currentUser.username+'!','success');
    startUptimeCounter(); loadGallery();
    if(currentUser.role==='admin'){
      document.getElementById('adminSection').style.display='block';
      document.getElementById('adminKeysNav').style.display='flex';
      document.getElementById('homeAdminCard').style.display='block';
      loadKeyList();
    }
    document.getElementById('loginKey').value='';
  }
}

function updateUserUI(){
  ['userName','sidebarName'].forEach(id=>document.getElementById(id).textContent=currentUser.username);
  document.getElementById('userRole').textContent=currentUser.role==='admin'?'Administrator':'Member';
  document.getElementById('sidebarRole').textContent=currentUser.role==='admin'?'Administrator':'Member';
  ['userAvatar','sidebarAvatar'].forEach(id=>{
    document.getElementById(id).textContent=currentUser.avatar;
    if(currentUser.role==='admin') document.getElementById(id).classList.add('admin');
  });
  document.getElementById('welcomeName').textContent=currentUser.username;
  document.getElementById('settingsUsername').textContent=currentUser.username;
  document.getElementById('settingsRole').textContent=currentUser.role==='admin'?'Administrator':'Member';
  document.getElementById('settingsLoginTime').textContent=new Date(currentUser.loginTime).toLocaleString('th-TH');
}

async function checkSession(){
  const sd=localStorage.getItem('trStudioSession');
  const sv=localStorage.getItem('trStudioSessionVerify');
  if(!sd||!sv) return false;
  const ch=await sha256(sd);
  if(ch!==sv){logout();showToast('‚ö†Ô∏è Session ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error');return false;}
  try{
    const s=JSON.parse(atob(sd));
    if(Date.now()-s.timestamp>24*60*60*1000){logout();showToast('‚è±Ô∏è Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏','info');return false;}
    const keys=getKeys();
    if(keys[s.key]&&keys[s.key].active){
      currentUser={key:s.key,...keys[s.key],loginTime:new Date(s.timestamp).toISOString()};
      sessionStartTime=s.timestamp;
      updateUserUI();
      document.getElementById('loginScreen').style.display='none';
      document.getElementById('app').style.display='flex';
      startUptimeCounter(); loadGallery();
      if(currentUser.role==='admin'){
        document.getElementById('adminSection').style.display='block';
        document.getElementById('adminKeysNav').style.display='flex';
        document.getElementById('homeAdminCard').style.display='block';
        loadKeyList();
      }
      return true;
    }
  }catch(e){logout();}
  return false;
}

function logout(){
  localStorage.removeItem('trStudioSession');
  localStorage.removeItem('trStudioSessionVerify');
  currentUser=null; sessionStartTime=null;
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('app').style.display='none';
  document.getElementById('loginKey').value='';
  document.getElementById('loginError').style.display='none';
  document.getElementById('adminSection').style.display='none';
  document.getElementById('adminKeysNav').style.display='none';
  document.getElementById('homeAdminCard').style.display='none';
  showToast('üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß','info');
}

document.addEventListener('DOMContentLoaded',function(){
  initKeys();
  document.getElementById('loginKey').addEventListener('keypress',function(e){if(e.key==='Enter')attemptLogin();});
  checkSession();
});

// ============================================================
// KEY MANAGEMENT
// ============================================================
function loadKeyList(){
  const keys=getKeys();
  const container=document.getElementById('keyList');
  container.innerHTML='';
  for(const[key,data] of Object.entries(keys)){
    const item=document.createElement('div');
    item.className='key-item';
    item.innerHTML=`
      <div class="key-icon">${data.avatar}</div>
      <div class="key-details"><div class="key-name">${data.username}</div><div class="key-code">${key}</div></div>
      <div class="key-status ${data.active?'':'inactive'}">${data.active?'Active':'Inactive'}</div>
      <button class="btn btn-sm btn-danger" onclick="deleteKey('${key}')">üóëÔ∏è</button>
    `;
    container.appendChild(item);
  }
}
function openAddKeyModal(){document.getElementById('addKeyModal').classList.add('active')}
function closeAddKeyModal(){document.getElementById('addKeyModal').classList.remove('active')}
function addNewKey(){
  const username=document.getElementById('newKeyUsername').value.trim();
  const keyCode=document.getElementById('newKeyCode').value.trim();
  const role=document.getElementById('newKeyRole').value;
  if(!username||!keyCode){showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error');return;}
  const keys=getKeys();
  if(keys[keyCode]){showToast('‚ùå ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß','error');return;}
  keys[keyCode]={username,role,avatar:username.substring(0,2).toUpperCase(),active:true};
  saveKeys(keys); loadKeyList(); closeAddKeyModal();
  document.getElementById('newKeyUsername').value='';
  document.getElementById('newKeyCode').value='';
  addLog('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå: '+keyCode,'success');
  showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!','success');
}
function deleteKey(key){
  if(key==='TaraRook'){showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå Admin ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ','error');return;}
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå '+key+' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  const keys=getKeys();
  delete keys[key]; saveKeys(keys); loadKeyList();
  addLog('‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå: '+key,'info'); showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß','info');
}

// ============================================================
// GALLERY
// ============================================================
function getGalleryKey(){return 'trGallery_'+(currentUser?currentUser.key:'guest')}
function getGallery(){const d=localStorage.getItem(getGalleryKey());return d?JSON.parse(d):[]}
function saveGallery(g){
  const key=getGalleryKey();
  // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ñ‡πâ‡∏≤ localStorage ‡πÄ‡∏ï‡πá‡∏° ‡∏•‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
  const trySave=()=>{
    try{
      localStorage.setItem(key,JSON.stringify(g));
      return true;
    }catch(e){
      if(g.length>1){
        g.pop(); // ‡∏•‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
        return trySave();
      }
      showToast('‚ö†Ô∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ','error');
      return false;
    }
  };
  trySave();
}

// ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: Compress ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î 70-80%
function compressImage(dataUrl, quality=0.25, maxW=800, maxH=800){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.width, h=img.height;
      if(w>maxW||h>maxH){
        const ratio=Math.min(maxW/w,maxH/h);
        w=Math.round(w*ratio); h=Math.round(h*ratio);
      }
      const canvas=document.createElement('canvas');
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      resolve(canvas.toDataURL('image/jpeg',quality));
    };
    img.onerror=()=>resolve(dataUrl); // fallback ‡∏ñ‡πâ‡∏≤ compress ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    img.src=dataUrl;
  });
}

async function addToGallery(imageData,name,type='pixel'){
  let g=getGallery();
  // Compress ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö
  const compressed=await compressImage(imageData);
  g.unshift({id:Date.now(),name,type,data:compressed,date:new Date().toISOString()});
  if(g.length>10) g=g.slice(0,10);
  saveGallery(g); loadGallery();
  addLog('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û: '+name,'success');
}
function loadGallery(){
  const g=getGallery();
  const container=document.getElementById('galleryGrid');
  const emptyEl=document.getElementById('galleryEmpty');
  const count=g.length;
  document.getElementById('galleryCount').textContent=count;
  const bnavCount=document.getElementById('bnavGalleryCount');
  if(count>0){bnavCount.textContent=count;bnavCount.style.display='block';}
  else{bnavCount.style.display='none';}
  if(count===0){container.style.display='none';emptyEl.style.display='block';return;}
  container.style.display='grid'; emptyEl.style.display='none';
  container.innerHTML='';
  g.forEach(img=>{
    const item=document.createElement('div');
    item.className='gallery-item';
    item.innerHTML=`
      <div class="gallery-thumb"><img src="${img.data}" alt="${img.name}"></div>
      <div class="gallery-info">
        <div class="gallery-name">${img.name}</div>
        <div class="gallery-date">${new Date(img.date).toLocaleString('th-TH')}</div>
        <div class="gallery-actions">
          <button class="btn btn-sm btn-secondary" onclick="viewImage(${img.id})">üëÅÔ∏è</button>
          <button class="btn btn-sm btn-primary" onclick="downloadImage(${img.id})">üíæ</button>
          <button class="btn btn-sm btn-danger" onclick="deleteImage(${img.id})">üóëÔ∏è</button>
        </div>
      </div>
    `;
    container.appendChild(item);
  });
}
function viewImage(id){
  const g=getGallery(); const img=g.find(i=>i.id===id); if(!img) return;
  currentImageId=id; document.getElementById('modalImage').src=img.data;
  document.getElementById('imageModal').classList.add('active');
}
function closeImageModal(){document.getElementById('imageModal').classList.remove('active');currentImageId=null;}
function downloadImage(id){
  const g=getGallery(); const img=g.find(i=>i.id===id); if(!img) return;
  const a=document.createElement('a'); a.href=img.data; a.download=img.name; a.click();
  statsDownloads++; updateStats(); addLog('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î: '+img.name,'success');
  showToast('üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
}
function downloadModalImage(){if(currentImageId)downloadImage(currentImageId);}
function deleteImage(id){
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  let g=getGallery(); const img=g.find(i=>i.id===id);
  g=g.filter(i=>i.id!==id); saveGallery(g); loadGallery();
  if(currentImageId===id) closeImageModal();
  addLog('‡∏•‡∏ö‡∏†‡∏≤‡∏û: '+(img?img.name:id),'info'); showToast('üóëÔ∏è ‡∏•‡∏ö‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß','info');
}
function deleteModalImage(){if(currentImageId)deleteImage(currentImageId);}

// ============================================================
// NAVIGATION
// ============================================================
let currentPanel='home';
let statsProcessed=0, statsDownloads=0, statsApiCalls=0;
let logs=[];

function showPanel(panelId, triggerEl){
  // Hide all panels
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+panelId).classList.add('active');

  // Sidebar active state
  document.querySelectorAll('.sidebar .nav-item').forEach(i=>i.classList.remove('active'));
  // Bottom nav active state
  document.querySelectorAll('.bnav-item').forEach(i=>i.classList.remove('active'));

  // Activate trigger or find by panel id
  if(triggerEl){
    const navItem=triggerEl.closest ? triggerEl.closest('.nav-item')||triggerEl : triggerEl;
    navItem.classList.add('active');
  }
  // Also sync other nav (sidebar ‚Üî bottom nav)
  document.querySelectorAll('.sidebar .nav-item').forEach(item=>{
    if(item.getAttribute('onclick')&&item.getAttribute('onclick').includes("'"+panelId+"'"))
      item.classList.add('active');
  });
  document.querySelectorAll('.bnav-item').forEach(item=>{
    if(item.dataset.panel===panelId) item.classList.add('active');
  });

  currentPanel=panelId;
  document.title='TR BG Studio ‚Äî '+{home:'‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å','remove-bg':'‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á',pixel:'Pixel Art',gallery:'‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà',stats:'‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥',logs:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','admin-keys':'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå',settings:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤'}[panelId];

  // Scroll content back to top
  document.getElementById('contentArea').scrollTop=0;
}

// ============================================================
// TOAST + LOG
// ============================================================
function showToast(message,type='info'){
  const container=document.getElementById('toastContainer');
  const toast=document.createElement('div');
  toast.className='toast '+type;
  const icons={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'};
  toast.innerHTML=`<div class="toast-icon">${icons[type]||'‚ÑπÔ∏è'}</div><div class="toast-msg">${message}</div>`;
  container.appendChild(toast);
  setTimeout(()=>{toast.style.animation='toastIn 0.3s ease reverse';setTimeout(()=>toast.remove(),300);},3000);
}
function addLog(message,type='info'){
  const time=new Date().toLocaleTimeString('th-TH');
  logs.unshift({time,message,type});
  if(logs.length>100) logs.pop();
  const container=document.getElementById('logsContainer');
  const icons={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'};
  const logEl=document.createElement('div');
  logEl.className='log-item '+type;
  logEl.innerHTML=`<div class="log-time">${time}</div><div class="log-icon">${icons[type]||'‚ÑπÔ∏è'}</div><div class="log-msg">${message}</div>`;
  container.insertBefore(logEl,container.firstChild);
}
function updateStats(){
  document.getElementById('statProcessed').textContent=statsProcessed;
  document.getElementById('statDownloads').textContent=statsDownloads;
  document.getElementById('statApiCalls').textContent=statsApiCalls;
}
function startUptimeCounter(){
  setInterval(()=>{
    if(!sessionStartTime) return;
    const h=Math.floor((Date.now()-sessionStartTime)/(1000*60*60));
    document.getElementById('statUptime').textContent=h+'h';
  },60000);
}

// ============================================================
// REMOVE BG
// ============================================================
let originalImage=null, resultImage=null;
let rmbgCurrentTool='erase', rmbgIsDrawing=false;
let rmbgHistory=[], rmbgCanvas=null, rmbgCtx=null;

function loadImageForBg(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    originalImage=e.target.result;
    const preview=document.getElementById('originalPreview');
    preview.innerHTML=`<img src="${originalImage}" alt="Original" style="max-width:100%;max-height:100%;object-fit:contain;">`;
    addLog('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: '+file.name,'success');
    showToast('üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
  };
  reader.readAsDataURL(file);
}

function processRemoveBg(){
  if(!originalImage){showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô','error');return;}
  showToast('üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...','info');
  statsApiCalls++; updateStats();
  const img=new Image();
  img.onload=function(){
    rmbgCanvas=document.getElementById('rmbgResultCanvas');
    rmbgCanvas.width=img.width; rmbgCanvas.height=img.height;
    rmbgCtx=rmbgCanvas.getContext('2d');
    rmbgCtx.drawImage(img,0,0);
    const imageData=rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height);
    simpleRemoveBg(imageData);
    rmbgCtx.putImageData(imageData,0,0);
    rmbgHistory=[rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height)];
    document.getElementById('resultPlaceholder').style.display='none';
    rmbgCanvas.style.display='block';
    document.getElementById('rmbgToolbar').style.display='flex';
    setupRmbgDrawing();
    resultImage=rmbgCanvas.toDataURL('image/png');
    statsProcessed++; updateStats();
    addLog('‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
    showToast('‚ú® ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏Ç‡∏ß‡∏≤','success');
  };
  img.src=originalImage;
}

function simpleRemoveBg(imageData){
  const data=imageData.data,w=imageData.width,h=imageData.height;
  function getPixel(x,y){const i=(y*w+x)*4;return[data[i],data[i+1],data[i+2],data[i+3]];}
  const corners=[getPixel(0,0),getPixel(w-1,0),getPixel(0,h-1),getPixel(w-1,h-1)];
  let bgR=0,bgG=0,bgB=0;
  corners.forEach(c=>{bgR+=c[0];bgG+=c[1];bgB+=c[2];});
  bgR=Math.round(bgR/4); bgG=Math.round(bgG/4); bgB=Math.round(bgB/4);
  for(let i=0;i<data.length;i+=4){
    if(Math.abs(data[i]-bgR)+Math.abs(data[i+1]-bgG)+Math.abs(data[i+2]-bgB)<180)
      data[i+3]=0;
  }
}

function setupRmbgDrawing(){
  if(!rmbgCanvas) return;
  rmbgCanvas.onmousedown=e=>{
    rmbgIsDrawing=true;
    rmbgHistory.push(rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height));
    if(rmbgHistory.length>20) rmbgHistory.shift();
    rmbgDraw(e);
  };
  rmbgCanvas.onmousemove=e=>{if(rmbgIsDrawing)rmbgDraw(e);};
  rmbgCanvas.onmouseup=()=>rmbgIsDrawing=false;
  rmbgCanvas.onmouseleave=()=>rmbgIsDrawing=false;
  rmbgCanvas.ontouchstart=e=>{e.preventDefault();rmbgIsDrawing=true;rmbgHistory.push(rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height));rmbgDraw(e.touches[0]);};
  rmbgCanvas.ontouchmove=e=>{e.preventDefault();if(rmbgIsDrawing)rmbgDraw(e.touches[0]);};
  rmbgCanvas.ontouchend=()=>rmbgIsDrawing=false;
}
function getRmbgPos(e){
  const rect=rmbgCanvas.getBoundingClientRect();
  return{x:(e.clientX-rect.left)*(rmbgCanvas.width/rect.width),y:(e.clientY-rect.top)*(rmbgCanvas.height/rect.height)};
}
function rmbgDraw(e){
  if(!rmbgCtx||!rmbgCanvas) return;
  const pos=getRmbgPos(e);
  const size=parseInt(document.getElementById('rmbgBrushSize').value)||20;
  const scale=rmbgCanvas.width/rmbgCanvas.getBoundingClientRect().width;
  const brushR=size/2*Math.max(scale||1,1);
  if(rmbgCurrentTool==='magic'){
    magicErase(Math.round(pos.x),Math.round(pos.y),parseInt(document.getElementById('rmbgTolerance').value)||60);
    return;
  }
  rmbgCtx.save();
  if(rmbgCurrentTool==='erase'){
    rmbgCtx.globalCompositeOperation='destination-out';
    rmbgCtx.fillStyle='rgba(0,0,0,1)';
  } else if(rmbgCurrentTool==='restore'){
    const orig=new Image(); orig.src=originalImage;
    rmbgCtx.globalCompositeOperation='source-over';
    rmbgCtx.beginPath(); rmbgCtx.arc(pos.x,pos.y,brushR,0,Math.PI*2); rmbgCtx.clip();
    rmbgCtx.drawImage(orig,0,0,rmbgCanvas.width,rmbgCanvas.height);
    rmbgCtx.restore(); return;
  } else {
    rmbgCtx.globalCompositeOperation='destination-out';
    rmbgCtx.fillStyle='rgba(0,0,0,1)';
  }
  rmbgCtx.beginPath(); rmbgCtx.arc(pos.x,pos.y,brushR,0,Math.PI*2); rmbgCtx.fill();
  rmbgCtx.restore();
}
function magicErase(sx,sy,tolerance){
  const id=rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height);
  const data=id.data,w=rmbgCanvas.width,h=rmbgCanvas.height;
  const si=(sy*w+sx)*4;
  const tR=data[si],tG=data[si+1],tB=data[si+2];
  const visited=new Uint8Array(w*h);
  const queue=[[sx,sy]]; visited[sy*w+sx]=1;
  while(queue.length){
    const[x,y]=queue.pop(); const i=(y*w+x)*4; data[i+3]=0;
    for(const[nx,ny] of[[x+1,y],[x-1,y],[x,y+1],[x,y-1]]){
      if(nx<0||ny<0||nx>=w||ny>=h||visited[ny*w+nx]) continue;
      visited[ny*w+nx]=1;
      const ni=(ny*w+nx)*4;
      if(data[ni+3]>0&&Math.abs(data[ni]-tR)+Math.abs(data[ni+1]-tG)+Math.abs(data[ni+2]-tB)<=tolerance*3)
        queue.push([nx,ny]);
    }
  }
  rmbgCtx.putImageData(id,0,0);
}
function setRmbgTool(tool){
  rmbgCurrentTool=tool;
  document.querySelectorAll('.rmbg-tool-btn').forEach(b=>b.classList.remove('active'));
  const map={brush:'rmbgToolBrush',erase:'rmbgToolErase',restore:'rmbgToolRestore',magic:'rmbgToolMagic'};
  if(map[tool]) document.getElementById(map[tool]).classList.add('active');
  document.getElementById('rmbgToleranceWrap').style.display=tool==='magic'?'flex':'none';
  if(rmbgCanvas) rmbgCanvas.style.cursor=tool==='magic'?'crosshair':'cell';
  showToast('üõ†Ô∏è '+{erase:'‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á',restore:'‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤',magic:'Magic Erase'}[tool],'info');
}
function updateBrushSizeLabel(v){document.getElementById('rmbgBrushSizeLabel').textContent=v;}
function updateToleranceLabel(v){document.getElementById('rmbgToleranceLabel').textContent=v;}
function rmbgUndo(){
  if(rmbgHistory.length<=1){showToast('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ Undo','info');return;}
  rmbgHistory.pop();
  rmbgCtx.putImageData(rmbgHistory[rmbgHistory.length-1],0,0);
  showToast('‚Ü©Ô∏è Undo','info');
}
function rmbgReset(){
  if(!rmbgHistory.length) return;
  const first=rmbgHistory[0];
  rmbgCtx.putImageData(first,0,0); rmbgHistory=[first];
  showToast('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß','info');
}
function getTRFilename(prefix){
  const now=new Date();
  const pad=n=>String(n).padStart(2,'0');
  const d=`${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}`;
  const t=`${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
  return `TR_${prefix}_${d}_${t}.png`;
}
function downloadNoBg(){
  const filename=getTRFilename('BG');
  if(rmbgCanvas&&rmbgCanvas.style.display!=='none'){
    rmbgCanvas.toBlob(blob=>{
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
      const reader=new FileReader();
      reader.onloadend=()=>addToGallery(reader.result,filename,'remove-bg');
      reader.readAsDataURL(blob);
    },'image/png');
  } else {
    if(!resultImage){showToast('‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå','error');return;}
    const a=document.createElement('a'); a.href=resultImage; a.download=filename; a.click();
    addToGallery(resultImage,filename,'remove-bg');
  }
  statsDownloads++; updateStats();
  addLog('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û','success'); showToast('üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
}

// ============================================================
// PIXEL ART EDITOR
// ============================================================
let pxCols=32, pxRows=32, pxPixels=[];
let pxCurrentColor='#000000', pxCurrentTool='pen', pxZoomLevel=8;
let pxCanvasReady=false, pxIsDrawing=false;
let pxLineStart=null, pxPreviewPixels=null;
let pxHistory=[], pxFuture=[], pxMirrorMode=false;
let draggedSwatch=null;
const DEFAULT_PALETTE=[
  '#000000','#FFFFFF','#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF',
  '#C0C0C0','#808080','#800000','#808000','#008000','#800080','#008080','#000080',
  '#FF6B6B','#FFA500','#FFD93D','#6BCB77','#4D96FF','#9D84B7','#F38181','#95E1D3'
];
let pxPalette=DEFAULT_PALETTE.slice();

function pxBackToStart(){
  document.getElementById('pxEditor').classList.remove('visible');
  document.getElementById('pxStart').style.display='flex';
}

function pxQuickStart(w,h){
  document.getElementById('pxW').value=w;
  document.getElementById('pxH').value=h;
  pxCreateCanvas();
}

function pxCreateCanvas(){
  pxCols=Math.max(4,Math.min(256,parseInt(document.getElementById('pxW').value)||32));
  pxRows=Math.max(4,Math.min(256,parseInt(document.getElementById('pxH').value)||32));
  document.getElementById('pxW2').value=pxCols;
  document.getElementById('pxH2').value=pxRows;
  _pxInitCanvas();
}

function pxResizeCanvas(){
  const newW=Math.max(4,Math.min(256,parseInt(document.getElementById('pxW2').value)||pxCols));
  const newH=Math.max(4,Math.min(256,parseInt(document.getElementById('pxH2').value)||pxRows));
  if(newW===pxCols&&newH===pxRows){showToast('‚ÑπÔ∏è ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°','info');return;}
  const newPixels=new Array(newW*newH).fill(null);
  for(let r=0;r<Math.min(pxRows,newH);r++)
    for(let c=0;c<Math.min(pxCols,newW);c++)
      newPixels[r*newW+c]=pxPixels[r*pxCols+c];
  pxCols=newW; pxRows=newH; pxPixels=newPixels;
  document.getElementById('pxW').value=pxCols;
  document.getElementById('pxH').value=pxRows;
  pxHistory=[]; pxFuture=[];
  const maxDim=Math.max(pxCols,pxRows);
  if(maxDim<=8)pxZoomLevel=40;else if(maxDim<=16)pxZoomLevel=24;
  else if(maxDim<=32)pxZoomLevel=14;else if(maxDim<=64)pxZoomLevel=8;
  else if(maxDim<=128)pxZoomLevel=4;else pxZoomLevel=2;
  pxRenderAll(); pxUpdateInfo();
  showToast('‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÅ‡∏•‡πâ‡∏ß','success');
}

function _pxInitCanvas(){
  const maxDim=Math.max(pxCols,pxRows);
  if(maxDim<=8)pxZoomLevel=40;else if(maxDim<=16)pxZoomLevel=24;
  else if(maxDim<=32)pxZoomLevel=14;else if(maxDim<=64)pxZoomLevel=8;
  else if(maxDim<=128)pxZoomLevel=4;else pxZoomLevel=2;
  pxPixels=new Array(pxCols*pxRows).fill(null);
  pxHistory=[]; pxFuture=[]; pxCanvasReady=true;
  document.getElementById('pxStart').style.display='none';
  document.getElementById('pxEditor').classList.add('visible');
  pxRenderAll(); pxUpdateInfo();
  addLog('‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas: '+pxCols+'√ó'+pxRows,'success');
  showToast('‚ú® Canvas ‡∏û‡∏£‡πâ‡∏≠‡∏°!','success');
}

function pxRenderAll(){
  if(!pxCanvasReady) return;
  const canvas=document.getElementById('pxCanvasEl');
  canvas.width=pxCols*pxZoomLevel; canvas.height=pxRows*pxZoomLevel;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  const pixels=pxPreviewPixels||pxPixels;
  for(let i=0;i<pixels.length;i++){
    if(!pixels[i]) continue;
    const c=i%pxCols, r=Math.floor(i/pxCols);
    ctx.fillStyle=pixels[i];
    ctx.fillRect(c*pxZoomLevel,r*pxZoomLevel,pxZoomLevel,pxZoomLevel);
  }
  if(pxZoomLevel>=4){
    ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.lineWidth=1;
    for(let c=0;c<=pxCols;c++){ctx.beginPath();ctx.moveTo(c*pxZoomLevel,0);ctx.lineTo(c*pxZoomLevel,canvas.height);ctx.stroke();}
    for(let r=0;r<=pxRows;r++){ctx.beginPath();ctx.moveTo(0,r*pxZoomLevel);ctx.lineTo(canvas.width,r*pxZoomLevel);ctx.stroke();}
  }
}

function pxGetCell(e){
  const canvas=document.getElementById('pxCanvasEl');
  const rect=canvas.getBoundingClientRect();
  let x,y;
  if(e.touches&&e.touches[0]){x=e.touches[0].clientX-rect.left;y=e.touches[0].clientY-rect.top;}
  else{x=e.clientX-rect.left;y=e.clientY-rect.top;}
  const c=Math.floor((x/rect.width)*pxCols);
  const r=Math.floor((y/rect.height)*pxRows);
  if(c<0||c>=pxCols||r<0||r>=pxRows) return null;
  return{c,r};
}
function pxDrawPixel(cell,color){
  pxPixels[cell.r*pxCols+cell.c]=color;
  if(pxMirrorMode) pxPixels[cell.r*pxCols+(pxCols-1-cell.c)]=color;
}
function pxSaveHistory(){pxHistory.push(pxPixels.slice());if(pxHistory.length>50)pxHistory.shift();pxFuture=[];}
function pxUndo(){if(!pxHistory.length)return;pxFuture.push(pxPixels.slice());pxPixels=pxHistory.pop();pxRenderAll();showToast('‚Ü©Ô∏è Undo','info');}
function pxRedo(){if(!pxFuture.length)return;pxHistory.push(pxPixels.slice());pxPixels=pxFuture.pop();pxRenderAll();showToast('‚Ü™Ô∏è Redo','info');}
function pxFill(sc,sr,tc,fc){
  if(tc===fc) return;
  const stack=[[sc,sr]];
  while(stack.length){
    const[c,r]=stack.pop();
    if(c<0||c>=pxCols||r<0||r>=pxRows) continue;
    const idx=r*pxCols+c; if(pxPixels[idx]!==tc) continue;
    pxPixels[idx]=fc; stack.push([c+1,r],[c-1,r],[c,r+1],[c,r-1]);
  }
}
function pxBresenham(x0,y0,x1,y1,arr,color){
  const dx=Math.abs(x1-x0),dy=Math.abs(y1-y0);
  const sx=x0<x1?1:-1,sy=y0<y1?1:-1;
  let err=dx-dy;
  while(true){arr[y0*pxCols+x0]=color;if(x0===x1&&y0===y1)break;const e2=2*err;if(e2>-dy){err-=dy;x0+=sx;}if(e2<dx){err+=dx;y0+=sy;}}
}
function pxBresenhamCircle(xc,yc,r,arr,color){
  let x=0,y=r,d=3-2*r;
  while(y>=x){
    [[xc+x,yc+y],[xc-x,yc+y],[xc+x,yc-y],[xc-x,yc-y],[xc+y,yc+x],[xc-y,yc+x],[xc+y,yc-x],[xc-y,yc-x]].forEach(([cx,cy])=>{
      if(cx>=0&&cx<pxCols&&cy>=0&&cy<pxRows) arr[cy*pxCols+cx]=color;
    });
    x++; if(d>0){y--;d=d+4*(x-y)+10;}else d=d+4*x+6;
  }
}
function pxBuildPreview(fn){pxPreviewPixels=pxPixels.slice();fn(pxPreviewPixels);}

// Mouse/touch handlers
document.addEventListener('DOMContentLoaded',function(){
  const canvas=document.getElementById('pxCanvasEl');
  if(!canvas) return;
  function onDown(e){
    e.preventDefault(); if(!pxCanvasReady) return;
    const cell=pxGetCell(e); if(!cell) return;
    pxIsDrawing=true;
    if(pxCurrentTool==='pen'){pxSaveHistory();pxDrawPixel(cell,pxCurrentColor);pxRenderAll();}
    else if(pxCurrentTool==='erase'){pxSaveHistory();pxDrawPixel(cell,null);pxRenderAll();}
    else if(pxCurrentTool==='fill'){pxSaveHistory();const tc=pxPixels[cell.r*pxCols+cell.c];pxFill(cell.c,cell.r,tc,pxCurrentColor);pxRenderAll();}
    else if(pxCurrentTool==='pick'){const color=pxPixels[cell.r*pxCols+cell.c];if(color){setPxColor(color);document.getElementById('pxColorPicker').value=color;showToast('üíâ '+color,'info');}}
    else if(['line','rect','circle'].includes(pxCurrentTool)){pxLineStart=cell;}
  }
  function onMove(e){
    e.preventDefault();
    const cell=pxGetCell(e);
    if(pxCanvasReady&&cell) document.getElementById('pxCoordInfo').textContent=`(${cell.c},${cell.r})`;
    if(!pxIsDrawing||!cell) return;
    if(pxCurrentTool==='pen'||pxCurrentTool==='erase'){pxDrawPixel(cell,pxCurrentTool==='erase'?null:pxCurrentColor);pxRenderAll();return;}
    if(!pxLineStart) return;
    if(pxCurrentTool==='line'){pxBuildPreview(p=>pxBresenham(pxLineStart.c,pxLineStart.r,cell.c,cell.r,p,pxCurrentColor));pxRenderAll();}
    if(pxCurrentTool==='rect'){
      pxBuildPreview(p=>{
        const minC=Math.min(pxLineStart.c,cell.c),maxC=Math.max(pxLineStart.c,cell.c);
        const minR=Math.min(pxLineStart.r,cell.r),maxR=Math.max(pxLineStart.r,cell.r);
        for(let rr=minR;rr<=maxR;rr++) for(let cc=minC;cc<=maxC;cc++)
          if(rr===minR||rr===maxR||cc===minC||cc===maxC) p[rr*pxCols+cc]=pxCurrentColor;
      }); pxRenderAll();
    }
    if(pxCurrentTool==='circle'){
      pxBuildPreview(p=>{const dx=cell.c-pxLineStart.c,dy=cell.r-pxLineStart.r;pxBresenhamCircle(pxLineStart.c,pxLineStart.r,Math.round(Math.sqrt(dx*dx+dy*dy)),p,pxCurrentColor);});
      pxRenderAll();
    }
  }
  function onUp(e){
    if(!pxIsDrawing) return; pxIsDrawing=false;
    if(pxLineStart){
      const cell=pxGetCell(e);
      if(cell){
        pxSaveHistory();
        if(pxCurrentTool==='line') pxBresenham(pxLineStart.c,pxLineStart.r,cell.c,cell.r,pxPixels,pxCurrentColor);
        if(pxCurrentTool==='rect'){
          const minC=Math.min(pxLineStart.c,cell.c),maxC=Math.max(pxLineStart.c,cell.c);
          const minR=Math.min(pxLineStart.r,cell.r),maxR=Math.max(pxLineStart.r,cell.r);
          for(let rr=minR;rr<=maxR;rr++) for(let cc=minC;cc<=maxC;cc++)
            if(rr===minR||rr===maxR||cc===minC||cc===maxC) pxPixels[rr*pxCols+cc]=pxCurrentColor;
        }
        if(pxCurrentTool==='circle'){
          const dx=cell.c-pxLineStart.c,dy=cell.r-pxLineStart.r;
          pxBresenhamCircle(pxLineStart.c,pxLineStart.r,Math.round(Math.sqrt(dx*dx+dy*dy)),pxPixels,pxCurrentColor);
        }
      }
      pxLineStart=null; pxPreviewPixels=null; pxRenderAll();
    }
  }
  function onLeave(e){if(pxCanvasReady) document.getElementById('pxCoordInfo').textContent='-';onUp(e);}
  canvas.addEventListener('mousedown',onDown);
  canvas.addEventListener('mousemove',onMove);
  canvas.addEventListener('mouseup',onUp);
  canvas.addEventListener('mouseleave',onLeave);
  canvas.addEventListener('touchstart',onDown,{passive:false});
  canvas.addEventListener('touchmove',onMove,{passive:false});
  canvas.addEventListener('touchend',onUp,{passive:false});

  // Keyboard shortcuts
  document.addEventListener('keydown',function(e){
    if(!pxCanvasReady) return;
    if(document.getElementById('panel-pixel').style.display==='none'||!document.getElementById('panel-pixel').classList.contains('active')) return;
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
    if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();pxUndo();}
    if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.shiftKey&&e.key==='z'))){e.preventDefault();pxRedo();}
    const k=e.key.toLowerCase();
    if(!e.ctrlKey&&!e.metaKey&&!e.altKey){
      if(k==='m'){toggleMirror();return;}
      if(k==='+'||k==='='){pxZoom(1);return;}
      if(k==='-'){pxZoom(-1);return;}
      const toolMap={p:['pen','pxtPen'],e:['erase','pxtErase'],f:['fill','pxtFill'],k:['pick','pxtPick'],l:['line','pxtLine'],r:['rect','pxtRect'],c:['circle','pxtCircle']};
      if(toolMap[k]){const[tool,btnId]=toolMap[k];setPxTool(tool,document.getElementById(btnId));}
    }
  });

  renderPalette();
  setPxColor('#000000');
});

function setPxTool(t,btn){
  pxCurrentTool=t;
  document.querySelectorAll('.px-tool-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const names={pen:'‚úèÔ∏è',erase:'üßπ',fill:'ü™£',pick:'üíâ',line:'üìè',rect:'‚¨ú',circle:'‚≠ï'};
  document.getElementById('pxInfoTool').textContent=names[t]||t;
}
function toggleMirror(){
  pxMirrorMode=!pxMirrorMode;
  const btn=document.getElementById('pxtMirror');
  btn.classList.toggle('active',pxMirrorMode);
  showToast(pxMirrorMode?'ü™û ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô':'ü™û ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô',pxMirrorMode?'success':'info');
}
function setPxColor(hex){
  pxCurrentColor=hex;
  document.getElementById('pxCurColorBox').style.background=hex;
  document.getElementById('pxColorHex').textContent=hex;
  document.querySelectorAll('.px-color-swatch').forEach(s=>s.classList.toggle('active',s.dataset.color===hex));
}
function pxZoom(dir){
  const steps=[1,2,3,4,5,6,8,10,12,14,16,20,24,32,40,48,64];
  let idx=steps.indexOf(pxZoomLevel);
  if(idx===-1){idx=0;for(let i=0;i<steps.length;i++){if(steps[i]>=pxZoomLevel){idx=i;break;}}}
  idx=Math.max(0,Math.min(steps.length-1,idx+dir));
  pxZoomLevel=steps[idx]; if(pxCanvasReady) pxRenderAll(); pxUpdateInfo();
}
function pxUpdateInfo(){
  document.getElementById('pxInfoSize').textContent=pxCols+'√ó'+pxRows;
  document.getElementById('pxZoomLabel').textContent='√ó'+pxZoomLevel;
}
function pxClear(){
  if(!pxCanvasReady) return;
  if(!confirm('‡∏•‡πâ‡∏≤‡∏á Canvas ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏´‡∏°?')) return;
  pxSaveHistory(); pxPixels=new Array(pxCols*pxRows).fill(null); pxRenderAll();
  showToast('üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á Canvas ‡πÅ‡∏•‡πâ‡∏ß','info');
}
function pxSave(){
  if(!pxCanvasReady||!pxPixels.length){showToast('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö','error');return;}
  const out=document.createElement('canvas');
  out.width=pxCols; out.height=pxRows;
  const ctx=out.getContext('2d');
  for(let i=0;i<pxPixels.length;i++){
    if(!pxPixels[i]) continue;
    ctx.fillStyle=pxPixels[i];
    ctx.fillRect(i%pxCols,Math.floor(i/pxCols),1,1);
  }
  out.toBlob(blob=>{
    const filename=getTRFilename('Pixel_'+pxCols+'x'+pxRows);
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    const reader=new FileReader();
    reader.onloadend=()=>addToGallery(reader.result,filename,'pixel');
    reader.readAsDataURL(blob);
    statsDownloads++; addLog('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Pixel Art '+pxCols+'√ó'+pxRows,'success'); updateStats();
    showToast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Pixel Art ‡πÅ‡∏•‡πâ‡∏ß!','success');
  },'image/png');
}
function pxUploadImg(){document.getElementById('pxImgInput').click();}
function pxLoadImage(input){
  const file=input.files[0]; if(!file) return;
  const img=new Image();
  img.onload=function(){
    pxCols=Math.min(256,img.width); pxRows=Math.min(256,img.height);
    document.getElementById('pxW').value=pxCols; document.getElementById('pxH').value=pxRows;
    document.getElementById('pxW2').value=pxCols; document.getElementById('pxH2').value=pxRows;
    const maxDim=Math.max(pxCols,pxRows);
    if(maxDim<=8)pxZoomLevel=40;else if(maxDim<=16)pxZoomLevel=24;
    else if(maxDim<=32)pxZoomLevel=14;else if(maxDim<=64)pxZoomLevel=8;
    else if(maxDim<=128)pxZoomLevel=4;else pxZoomLevel=2;
    const tmp=document.createElement('canvas'); tmp.width=pxCols; tmp.height=pxRows;
    tmp.getContext('2d').drawImage(img,0,0,pxCols,pxRows);
    const id=tmp.getContext('2d').getImageData(0,0,pxCols,pxRows);
    pxPixels=[];
    for(let i=0;i<pxCols*pxRows;i++){
      const r=id.data[i*4],g=id.data[i*4+1],b=id.data[i*4+2],a=id.data[i*4+3];
      pxPixels.push(a<30?null:'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''));
    }
    pxHistory=[]; pxFuture=[]; pxCanvasReady=true;
    document.getElementById('pxStart').style.display='none';
    document.getElementById('pxEditor').classList.add('visible');
    pxRenderAll(); pxUpdateInfo();
    addLog('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏π‡∏õ: '+file.name+' ‚Üí '+pxCols+'√ó'+pxRows,'success');
    showToast('‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏π‡∏õ '+pxCols+'√ó'+pxRows+' pixels','success');
  };
  img.src=URL.createObjectURL(file); input.value='';
}

function renderPalette(){
  const grid=document.getElementById('pxPaletteGrid'); if(!grid) return;
  grid.innerHTML='';
  pxPalette.forEach((color,index)=>{
    const sw=document.createElement('div');
    sw.className='px-color-swatch'; sw.style.background=color; sw.dataset.color=color; sw.title=color; sw.draggable=true;
    sw.onclick=e=>{if(e.target.classList.contains('del'))return;setPxColor(color);document.getElementById('pxColorPicker').value=color;};
    const del=document.createElement('div'); del.className='del'; del.textContent='√ó';
    del.onclick=e=>{e.stopPropagation();pxPalette.splice(index,1);renderPalette();showToast('üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏µ‡πÅ‡∏•‡πâ‡∏ß','info');};
    sw.appendChild(del);
    sw.addEventListener('dragstart',()=>{draggedSwatch=index;sw.style.opacity='0.5';});
    sw.addEventListener('dragend',()=>{sw.style.opacity='1';draggedSwatch=null;});
    sw.addEventListener('dragover',e=>{e.preventDefault();sw.style.transform='scale(1.1)';});
    sw.addEventListener('dragleave',()=>{sw.style.transform='scale(1)';});
    sw.addEventListener('drop',e=>{
      e.preventDefault(); sw.style.transform='scale(1)';
      if(draggedSwatch!==null&&draggedSwatch!==index){
        const temp=pxPalette[draggedSwatch]; pxPalette[draggedSwatch]=pxPalette[index]; pxPalette[index]=temp;
        renderPalette(); showToast('üîÑ ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà','info');
      }
    });
    grid.appendChild(sw);
  });
}
function addColorToPalette(){
  if(pxPalette.indexOf(pxCurrentColor)===-1){pxPalette.push(pxCurrentColor);renderPalette();showToast('‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡πÅ‡∏•‡πâ‡∏ß','success');}
  else showToast('‚ÑπÔ∏è ‡∏°‡∏µ‡∏™‡∏µ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß','info');
}
function resetPalette(){pxPalette=DEFAULT_PALETTE.slice();renderPalette();showToast('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏≤‡πÄ‡∏•‡∏ó','info');}

// ============================================================
// ZOOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
// ============================================================
const zoomState={orig:100, result:100};
const zoomSteps=[25,50,75,100,125,150,200,300,400];

function zoomImg(target, dir){
  if(dir===0){
    zoomState[target]=100;
  } else {
    const steps=zoomSteps;
    let idx=steps.findIndex(s=>s>=zoomState[target]);
    if(idx===-1) idx=steps.length-1;
    idx=Math.max(0,Math.min(steps.length-1, idx+dir));
    zoomState[target]=steps[idx];
  }
  const pct=zoomState[target];
  const label=pct+'%';

  if(target==='orig'){
    document.getElementById('origZoomPct').textContent=label;
    const img=document.querySelector('#originalPreview img');
    if(img){img.style.transform=`scale(${pct/100})`;img.style.transformOrigin='center center';}
  } else {
    document.getElementById('resultZoomPct').textContent=label;
    const canvas=document.getElementById('rmbgResultCanvas');
    if(canvas){canvas.style.transform=`scale(${pct/100})`;canvas.style.transformOrigin='center center';}
  }
}

addLog('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','success');
</script>
</body>
</html>
