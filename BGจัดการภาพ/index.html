<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TR BG Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
/* ===================== VARIABLES ===================== */
:root{
  --bg:#0d1117;--surface:#161b22;--card:#21262d;--border:#30363d;
  --accent:#2f81f7;--accent-hover:#1f6feb;--accent-light:rgba(47,129,247,0.12);
  --success:#3fb950;--error:#f85149;--warning:#d29922;--purple:#bc8cff;--gold:#e3b341;
  --text:#e6edf3;--text-muted:#7d8590;--text-subtle:#484f58;
  --shadow:0 8px 24px rgba(1,4,9,0.4);--shadow-sm:0 2px 8px rgba(1,4,9,0.3);
  --radius:10px;--sidebar-w:220px;
  --topbar-h:52px;--bottomnav-h:64px;
}
body.light-mode{
  --bg:#f6f8fa;--surface:#ffffff;--card:#f0f2f5;--border:#d0d7de;
  --text:#1f2328;--text-muted:#656d76;--text-subtle:#9198a1;
  --shadow:0 8px 24px rgba(0,0,0,0.12);--shadow-sm:0 2px 8px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
button,input,select{font-family:'Sarabun',sans-serif}

/* ===================== LOGIN ===================== */
#loginScreen{
  position:fixed;inset:0;z-index:9999;
  background:linear-gradient(135deg,#0d1117 0%,#161b22 50%,#0d1117 100%);
  display:flex;align-items:center;justify-content:center;padding:20px;
}
.login-box{
  background:var(--surface);border:1px solid var(--border);border-radius:20px;
  padding:40px 36px;width:100%;max-width:400px;box-shadow:var(--shadow);
  text-align:center;position:relative;overflow:hidden;
}
.login-box::before{
  content:'';position:absolute;top:-60px;left:50%;transform:translateX(-50%);
  width:200px;height:200px;
  background:radial-gradient(circle,rgba(47,129,247,0.15) 0%,transparent 70%);
  pointer-events:none;
}
.login-logo{
  width:60px;height:60px;background:linear-gradient(135deg,var(--accent),var(--purple));
  border-radius:16px;display:inline-flex;align-items:center;justify-content:center;
  font-size:26px;margin-bottom:16px;box-shadow:0 8px 24px rgba(47,129,247,0.3);
}
.login-title{font-size:24px;font-weight:800;margin-bottom:4px}
.login-subtitle{color:var(--text-muted);font-size:13px;margin-bottom:24px}
.login-badge{
  display:flex;align-items:center;gap:6px;justify-content:center;
  background:rgba(63,185,80,0.1);border:1px solid rgba(63,185,80,0.25);
  color:var(--success);font-size:11px;font-weight:700;
  font-family:'JetBrains Mono',monospace;
  padding:5px 14px;border-radius:100px;margin-bottom:24px;
}
.api-dot{width:6px;height:6px;border-radius:50%;background:var(--success);animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.login-label{text-align:left;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.login-input-wrap{position:relative;margin-bottom:14px}
.login-input{
  width:100%;padding:12px 40px 12px 14px;background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:14px;
  outline:none;transition:border-color 0.2s,box-shadow 0.2s;letter-spacing:2px;
}
.login-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(47,129,247,0.15)}
.login-eye{
  position:absolute;right:10px;top:50%;transform:translateY(-50%);
  background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:15px;padding:4px;
}
.login-btn{
  width:100%;padding:13px;background:linear-gradient(135deg,var(--accent),#388bfd);
  border:none;border-radius:var(--radius);color:#fff;font-size:15px;font-weight:700;
  cursor:pointer;transition:all 0.2s;box-shadow:0 4px 16px rgba(47,129,247,0.3);
}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(47,129,247,0.4)}
.login-error{
  color:var(--error);font-size:13px;margin-top:10px;
  background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.2);
  padding:8px 12px;border-radius:8px;display:none;
}

/* ===================== APP SHELL ===================== */
#app{display:none;flex:1;overflow:hidden;flex-direction:column}
#app.visible{display:flex}

/* ===================== TOPBAR ===================== */
.topbar{
  height:var(--topbar-h);background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;flex-shrink:0;gap:0;
}
.topbar-logo{
  display:flex;align-items:center;gap:8px;text-decoration:none;flex-shrink:0;
}
.topbar-logo-icon{
  width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--purple));
  border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;
}
.topbar-logo-name{font-size:16px;font-weight:800;color:var(--text)}
.topbar-spacer{flex:1}
.topbar-user{display:flex;align-items:center;gap:8px}
.topbar-avatar{
  width:32px;height:32px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent),var(--purple));
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:800;color:#fff;cursor:pointer;
  border:2px solid var(--border);transition:border-color 0.2s;flex-shrink:0;
}
.topbar-avatar:hover{border-color:var(--accent)}
.topbar-avatar.admin{background:linear-gradient(135deg,var(--gold),var(--warning))}
.topbar-user-info{display:flex;flex-direction:column;align-items:flex-end}
.topbar-username{font-size:13px;font-weight:700;line-height:1.2}
.topbar-role{font-size:10px;color:var(--text-muted)}
.topbar-logout{
  background:none;border:none;color:var(--text-muted);cursor:pointer;
  font-size:18px;padding:6px;border-radius:6px;transition:all 0.15s;
}
.topbar-logout:hover{color:var(--error);background:rgba(248,81,73,0.1)}

/* API Status pill in topbar */
.topbar-api{
  display:flex;align-items:center;gap:5px;
  background:rgba(63,185,80,0.08);border:1px solid rgba(63,185,80,0.2);
  border-radius:100px;padding:4px 10px;
  font-size:10px;font-weight:700;color:var(--success);
  font-family:'JetBrains Mono',monospace;
  margin-right:10px;
}

/* ===================== BODY AREA ===================== */
.app-body{
  flex:1;display:flex;overflow:hidden;
  /* leave space for bottom nav on mobile */
}

/* ===================== SIDEBAR (desktop only) ===================== */
.sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;
}
.sidebar-section-title{
  font-size:10px;font-weight:700;color:var(--text-subtle);
  text-transform:uppercase;letter-spacing:1.5px;
  padding:12px 14px 4px;margin-top:4px;
}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;cursor:pointer;color:var(--text-muted);
  font-size:14px;font-weight:500;transition:all 0.15s;
  user-select:none;position:relative;
}
.nav-item:hover{background:var(--card);color:var(--text)}
.nav-item.active{
  background:var(--accent-light);color:var(--accent);font-weight:700;
}
.nav-item.active::before{
  content:'';position:absolute;left:0;top:4px;bottom:4px;
  width:3px;background:var(--accent);border-radius:0 3px 3px 0;
}
.nav-icon{font-size:18px;width:24px;text-align:center;flex-shrink:0}
.nav-badge{
  margin-left:auto;background:var(--accent);color:#fff;
  font-size:10px;font-weight:700;padding:2px 7px;
  border-radius:100px;min-width:20px;text-align:center;
}
.nav-badge.green{background:var(--success)}
.nav-badge.gold{background:var(--gold)}
.sidebar-footer{border-top:1px solid var(--border);padding:10px;margin-top:auto}

/* ===================== CONTENT ===================== */
.content-wrap{flex:1;overflow:hidden;display:flex;flex-direction:column}
.content{flex:1;overflow-y:auto;padding:20px}

/* Panel system */
.panel{display:none}
.panel.active{display:block}
.panel-fullh{height:100%}
#panel-pixel.active{display:flex;flex-direction:column;height:100%;overflow:hidden}

/* Section headers */
.page-header{margin-bottom:20px}
.page-title{font-size:20px;font-weight:800;margin-bottom:3px}
.page-sub{font-size:13px;color:var(--text-muted)}

/* ===================== CARDS ===================== */
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.card{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:18px;cursor:pointer;transition:all 0.2s;
}
.card:hover{border-color:var(--accent);box-shadow:var(--shadow-sm);transform:translateY(-2px)}
.card-icon{font-size:30px;margin-bottom:10px}
.card-title{font-size:15px;font-weight:700;margin-bottom:5px}
.card-desc{font-size:12px;color:var(--text-muted);line-height:1.5}

/* Action row */
.action-row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:18px}

/* ===================== BUTTONS ===================== */
.btn{
  padding:9px 16px;border:none;border-radius:8px;
  font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;
  display:inline-flex;align-items:center;gap:6px;text-decoration:none;
}
.btn-primary{background:linear-gradient(135deg,var(--accent),#388bfd);color:#fff;box-shadow:0 2px 8px rgba(47,129,247,0.25)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(47,129,247,0.35)}
.btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);background:var(--surface)}
.btn-success{background:var(--success);color:#fff}
.btn-success:hover{filter:brightness(1.1)}
.btn-danger{background:var(--error);color:#fff}
.btn-danger:hover{filter:brightness(1.1)}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-icon{padding:8px;width:36px;height:36px;justify-content:center}

/* ===================== FORMS ===================== */
.form-row{margin-bottom:14px}
.form-label{display:block;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px}
.form-input,.form-select{
  width:100%;padding:9px 11px;background:var(--card);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-size:14px;outline:none;
  transition:border-color 0.2s,box-shadow 0.2s;
}
.form-input:focus,.form-select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(47,129,247,0.1)}
.form-input[type="range"]{
  padding:0;height:5px;background:var(--border);border:none;border-radius:3px;appearance:none;
}
.form-input[type="range"]::-webkit-slider-thumb{
  appearance:none;width:16px;height:16px;background:var(--accent);border-radius:50%;cursor:pointer;
}

/* ===================== REMOVE BG PANEL ===================== */
.rmbg-layout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.preview-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px}
.preview-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted)}
.preview-img{
  width:100%;aspect-ratio:1;
  background:repeating-conic-gradient(var(--card) 0% 25%,var(--surface) 0% 50%) 0 0/18px 18px;
  border-radius:8px;display:flex;align-items:flex-start;justify-content:flex-start;
  position:relative;overflow:auto;
}
.preview-img img{object-fit:unset;width:100%;height:auto;max-width:none;max-height:none;}
.preview-placeholder{color:var(--text-subtle);font-size:12px;text-align:center;padding:20px}

/* Manual edit toolbar */
.rmbg-toolbar{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;
}
.rmbg-tool-btn{
  display:flex;align-items:center;gap:5px;
  background:var(--card);border:1px solid var(--border);
  border-radius:7px;padding:6px 11px;
  cursor:pointer;font-size:12px;font-weight:600;
  transition:all 0.15s;color:var(--text-muted);white-space:nowrap;
}
.rmbg-tool-btn:hover{border-color:var(--accent);color:var(--text)}
.rmbg-tool-btn.active{background:var(--accent-light);border-color:var(--accent);color:var(--accent)}
.rmbg-divider{width:1px;height:24px;background:var(--border);flex-shrink:0}
.rmbg-canvas-wrap{
  width:100%;aspect-ratio:1;
  background:repeating-conic-gradient(var(--card) 0% 25%,var(--surface) 0% 50%) 0 0/18px 18px;
  border-radius:8px;overflow:auto;display:flex;align-items:flex-start;justify-content:flex-start;position:relative;
}
#rmbgResultCanvas{display:none;cursor:crosshair;width:100%;height:auto;max-width:none;max-height:none;}

/* ‡∏ã‡∏π‡∏°‡∏õ‡∏∏‡πà‡∏° */
.zoom-wrap{position:relative;width:100%}
.zoom-controls{
  position:absolute;bottom:8px;right:8px;z-index:10;
  display:flex;align-items:center;gap:4px;
  background:rgba(13,17,23,0.75);backdrop-filter:blur(4px);
  border:1px solid var(--border);border-radius:8px;padding:4px 6px;
}
.zoom-btn{
  width:26px;height:26px;border:none;background:var(--card);
  border-radius:6px;color:var(--text);font-size:16px;font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all 0.15s;flex-shrink:0;
}
.zoom-btn:hover{background:var(--accent);color:#fff}
.zoom-pct{font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--text);min-width:36px;text-align:center}
.zoom-reset{font-size:10px;padding:0 6px}

/* container ‡∏ó‡∏µ‡πà scroll/pan ‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ zoom */
.zoomable-img{
  width:100%;height:100%;overflow:auto;
  display:flex;align-items:center;justify-content:center;
}
.zoomable-img img,.zoomable-canvas{
  transition:transform 0.2s;transform-origin:center center;
}

/* ===================== PIXEL EDITOR ===================== */
.px-start{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;padding:30px 20px;gap:20px;text-align:center;overflow-y:auto;
}
.px-start-title{font-size:20px;font-weight:800}
.px-start-sub{font-size:13px;color:var(--text-muted)}
.px-presets{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.px-preset{
  background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:8px 14px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.15s;
  display:flex;flex-direction:column;align-items:center;gap:2px;
}
.px-preset:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.px-preset span{font-size:10px;color:var(--text-muted)}
.px-preset:hover span{color:var(--accent)}
.px-divider{display:flex;align-items:center;gap:10px;width:100%;max-width:380px}
.px-divider::before,.px-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.px-divider span{font-size:11px;color:var(--text-muted)}
.px-custom-row{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;justify-content:center}
.px-custom-field{display:flex;flex-direction:column;gap:4px;align-items:center}
.px-custom-field label{font-size:11px;color:var(--text-muted);font-weight:700}
.px-custom-field input{
  width:76px;padding:8px;background:var(--card);border:1px solid var(--border);
  border-radius:6px;color:var(--text);font-size:15px;font-weight:700;text-align:center;outline:none;
}
.px-custom-field input:focus{border-color:var(--accent)}
.px-upload-area{
  display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;
  background:var(--surface);border:2px dashed var(--border);
  border-radius:12px;padding:18px 28px;transition:all 0.15s;width:100%;max-width:280px;
}
.px-upload-area:hover{border-color:var(--accent);background:var(--accent-light)}
.px-upload-icon{font-size:28px}
.px-upload-label{font-size:13px;font-weight:600}
.px-upload-sub{font-size:11px;color:var(--text-muted)}

/* Editor layout */
.px-editor{display:none;flex:1;flex-direction:column;gap:0;overflow:hidden;height:100%}
.px-editor.visible{display:flex}
.px-sidebar{
  display:none;
}
.px-viewport{
  flex:1;background:var(--card);overflow:auto;
  display:block;
  position:relative;
  padding-top:52px;
  padding-bottom:70px;
}
.px-viewport-inner{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:100%;
  min-height:100%;
  padding:20px;
  box-sizing:border-box;
}
.px-canvas-wrap{display:inline-block;box-shadow:var(--shadow);border-radius:2px;overflow:hidden;position:relative}
#pxCanvasEl{display:block;image-rendering:pixelated;image-rendering:crisp-edges;cursor:crosshair}

/* Top Bar */
.px-topbar{
  position:fixed;top:0;left:0;right:0;height:52px;
  background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;padding:0 16px;z-index:100;
}
.px-topbar-title{flex:1;font-weight:700;font-size:14px;color:var(--text)}
.px-topbar-btn{
  background:var(--card);border:1px solid var(--border);color:var(--text);
  width:40px;height:40px;border-radius:6px;cursor:pointer;font-size:18px;
  display:flex;align-items:center;justify-content:center;transition:all 0.15s;
}
.px-topbar-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff}

/* Bottom Bar */
.px-bottombar{
  position:fixed;bottom:0;left:0;right:0;height:70px;
  background:var(--surface);border-top:1px solid var(--border);
  display:flex;align-items:center;gap:6px;padding:8px;z-index:100;
  overflow-x:auto;
}

.tool-icon{
  width:44px;height:44px;min-width:44px;
  border-radius:8px;font-size:20px;cursor:pointer;
  border:1px solid var(--border);background:var(--card);
  display:flex;align-items:center;justify-content:center;
  transition:all 0.15s;
}
.tool-icon:hover{background:var(--surface);border-color:var(--accent)}
.tool-icon.active{background:var(--accent);color:#fff;border-color:var(--accent)}

.color-picker-inline{
  width:44px;height:44px;cursor:pointer;border:1px solid var(--border);border-radius:8px;
  padding:2px;
}

.tab-btn{
  width:44px;height:44px;min-width:44px;font-size:18px;
  background:var(--card);border:1px solid var(--border);color:var(--text);
  border-radius:8px;cursor:pointer;transition:all 0.15s;
}
.tab-btn:hover{background:var(--surface);border-color:var(--accent)}
.tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Pop-up Panels */
.px-popup-panel{
  position:fixed;bottom:70px;left:0;right:0;
  background:var(--surface);border-top:1px solid var(--border);
  max-height:50vh;overflow-y:auto;z-index:99;
  display:none;animation:slideUp 0.3s ease-out;
}
.px-popup-panel.visible{display:block}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

.px-popup-content{padding:12px}
.px-popup-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px;border-bottom:1px solid var(--border);font-weight:700;
}
.px-popup-close{background:none;border:none;cursor:pointer;font-size:20px;color:var(--text)}

/* Adjust sections for pop-up */
.px-section{padding:12px 12px 10px;border-bottom:1px solid var(--border)}

.px-section{padding:12px 12px 10px;border-bottom:1px solid var(--border)}
.px-section-label{font-size:10px;font-weight:700;color:var(--text-subtle);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
.px-tool-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
.px-tool-btn{
  background:var(--card);border:1px solid var(--border);border-radius:6px;
  padding:8px 4px;font-size:18px;cursor:pointer;transition:all 0.15s;
  display:flex;flex-direction:column;align-items:center;gap:1px;position:relative;
}
.px-tool-btn .tlabel{font-size:8px;font-weight:700;color:var(--text-muted)}
.px-tool-btn .tkey{
  position:absolute;top:2px;right:3px;
  font-size:7px;font-family:'JetBrains Mono',monospace;
  color:var(--text-subtle);font-weight:700;
}
.px-tool-btn .tkey-mobile{
  display:none;
  position:absolute;top:2px;right:3px;
  font-size:7px;font-family:'JetBrains Mono',monospace;
  color:var(--text-subtle);font-weight:700;
}
@media(max-width:768px){
  .px-tool-btn .tkey-mobile{display:block}
}
.px-tool-btn:hover{background:var(--surface);border-color:var(--accent)}
.px-tool-btn.active{background:var(--accent-light);border-color:var(--accent)}
.px-tool-btn.active .tlabel,.px-tool-btn.active .tkey,.px-tool-btn.active .tkey-mobile{color:var(--accent)}

/* Floating Toolbar */
.floating-tool-btn{
  background:var(--card);border:1px solid var(--border);color:var(--text);
  padding:8px 6px;border-radius:6px;cursor:pointer;font-size:16px;
  display:flex;flex-direction:column;align-items:center;gap:2px;
  transition:all 0.15s;font-weight:600;
}
.floating-tool-btn:hover{background:var(--surface);border-color:var(--accent)}
.floating-tool-btn.active{background:var(--accent-light);border-color:var(--accent);color:var(--accent)}

.px-color-display{
  display:flex;align-items:center;gap:8px;margin-bottom:8px;
  background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;
}
.px-color-box{width:36px;height:36px;border-radius:6px;border:2px solid var(--border);flex-shrink:0}
.px-color-hex{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700}
.px-color-label{font-size:9px;color:var(--text-muted);margin-bottom:1px}
.px-color-picker{width:100%;height:32px;border:1px solid var(--border);border-radius:6px;cursor:pointer;margin-bottom:6px}

.px-palette-grid{
  display:grid;grid-template-columns:repeat(8,1fr);gap:4px;
  max-height:120px;overflow-y:auto;padding:2px;margin-bottom:6px;
}
.px-color-swatch{
  width:100%;aspect-ratio:1;border-radius:3px;cursor:pointer;
  border:2px solid transparent;transition:all 0.15s;position:relative;
}
.px-color-swatch:hover{border-color:var(--text-muted);transform:scale(1.1)}
.px-color-swatch.active{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-light)}
.px-color-swatch .del{
  position:absolute;top:-3px;right:-3px;width:12px;height:12px;
  background:var(--error);border-radius:50%;
  display:none;align-items:center;justify-content:center;
  font-size:8px;color:#fff;cursor:pointer;z-index:1;
}
.px-color-swatch:hover .del{display:flex}

.px-info-row{display:flex;gap:6px}
.px-info-chip{
  flex:1;background:var(--card);border:1px solid var(--border);
  border-radius:6px;padding:6px;text-align:center;
}
.px-info-chip-label{font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.px-info-chip-value{font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace}
.px-zoom-row{display:flex;align-items:center;gap:6px;margin-top:8px}
.px-zoom-btn{
  width:28px;height:28px;background:var(--card);border:1px solid var(--border);
  border-radius:6px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:14px;transition:all 0.15s;flex-shrink:0;
}
.px-zoom-btn:hover{background:var(--surface);border-color:var(--accent)}
.px-zoom-label{flex:1;text-align:center;font-family:'JetBrains Mono',monospace;font-weight:700;font-size:12px}

/* Tooltip for keyboard shortcuts */
.tool-icon{position:relative;}
.tool-icon .kbd-tip{
  display:none;position:absolute;bottom:110%;left:50%;transform:translateX(-50%);
  background:var(--card);border:1px solid var(--border);border-radius:6px;
  padding:4px 8px;font-size:10px;white-space:nowrap;color:var(--text);z-index:200;
  pointer-events:none;font-family:'JetBrains Mono',monospace;
}
.tool-icon .kbd-tip::after{
  content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);
  border:4px solid transparent;border-top-color:var(--border);
}
.tool-icon:hover .kbd-tip{display:block;}

/* Key badge ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
.kbd-badge{
  position:absolute;
  top:3px;right:3px;
  font-size:8px;font-family:'JetBrains Mono',monospace;font-weight:800;
  color:var(--text-subtle);
  line-height:1;
  pointer-events:none;
  letter-spacing:0;
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:3px;
  padding:1px 3px;
  opacity:0.85;
  transition:opacity 0.15s;
}
.tool-icon:hover .kbd-badge{opacity:1;color:var(--accent);border-color:var(--accent);}
.tool-icon.active .kbd-badge{color:#fff;border-color:rgba(255,255,255,0.4);background:rgba(0,0,0,0.2);opacity:1;}
/* Pan mode indicator */
.pan-mode-bar{
  display:none;position:absolute;top:52px;left:0;right:0;z-index:110;
  background:rgba(47,129,247,0.15);border-bottom:2px solid var(--accent);
  padding:5px 14px;font-size:12px;font-weight:700;color:var(--accent);
  text-align:center;letter-spacing:0.5px;
}
.pan-mode-bar.visible{display:block;}

/* Keyboard shortcut hints */
.px-shortcuts{
  background:rgba(47,129,247,0.05);border:1px solid rgba(47,129,247,0.15);
  border-radius:8px;padding:8px;
  display:grid;grid-template-columns:1fr 1fr;gap:3px;
}
.sc-item{display:flex;align-items:center;gap:5px;font-size:10px}
.sc-key{
  background:var(--card);border:1px solid var(--border);
  border-radius:4px;padding:1px 5px;
  font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:var(--text);
  white-space:nowrap;flex-shrink:0;
}
.sc-desc{color:var(--text-muted)}

/* ===================== GALLERY ===================== */
.gallery-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;
}
.gallery-item{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  overflow:hidden;transition:all 0.2s;cursor:pointer;
}
.gallery-item:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:var(--shadow)}
.gallery-thumb{
  width:100%;aspect-ratio:1;
  background:repeating-conic-gradient(var(--card) 0% 25%,var(--surface) 0% 50%) 0 0/18px 18px;
  display:flex;align-items:center;justify-content:center;overflow:hidden;
}
.gallery-thumb img{max-width:100%;max-height:100%;object-fit:contain}
.gallery-info{padding:10px}
.gallery-name{font-size:12px;font-weight:700;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gallery-date{font-size:10px;color:var(--text-muted);margin-bottom:6px}
.gallery-actions{display:flex;gap:5px}
.gallery-empty{text-align:center;padding:60px 20px;color:var(--text-muted)}

/* ===================== STATS ===================== */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center}
.stat-icon{font-size:26px;margin-bottom:6px}
.stat-value{font-size:26px;font-weight:800;font-family:'JetBrains Mono',monospace;margin-bottom:3px}
.stat-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}

/* ===================== LOGS ===================== */
.logs-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;max-height:500px;overflow-y:auto}
.log-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;font-size:12px;margin-bottom:4px;background:var(--card);animation:slideIn 0.3s ease}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.log-time{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-subtle);flex-shrink:0}
.log-icon{font-size:14px;flex-shrink:0}
.log-msg{flex:1;color:var(--text-muted)}
.log-item.success .log-icon{color:var(--success)}
.log-item.error .log-icon{color:var(--error)}
.log-item.info .log-icon{color:var(--accent)}

/* ===================== KEY MANAGEMENT ===================== */
.key-list{margin-top:16px}
.key-item{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:10px;
}
.key-icon{width:38px;height:38px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.key-details{flex:1}
.key-name{font-size:14px;font-weight:700;margin-bottom:3px}
.key-code{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--text-muted)}
.key-status{padding:3px 10px;border-radius:100px;font-size:10px;font-weight:700;background:var(--success);color:#fff}
.key-status.inactive{background:var(--text-subtle)}

/* ===================== MODALS ===================== */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;
  display:none;align-items:center;justify-content:center;padding:20px;
}
.modal-overlay.active{display:flex}
.modal{
  background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:24px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);
}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.modal-title{font-size:17px;font-weight:800}
.modal-close{
  background:none;border:none;color:var(--text-muted);font-size:22px;cursor:pointer;
  width:30px;height:30px;display:flex;align-items:center;justify-content:center;
  border-radius:6px;transition:all 0.15s;
}
.modal-close:hover{background:var(--card);color:var(--text)}

/* ===================== TOAST ===================== */
#toastContainer{position:fixed;top:60px;right:16px;z-index:10000;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:10px 14px;box-shadow:var(--shadow);display:flex;align-items:center;gap:8px;
  min-width:240px;animation:toastIn 0.3s ease;pointer-events:all;
}
@keyframes toastIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
.toast-icon{font-size:18px;flex-shrink:0}
.toast-msg{flex:1;font-size:12px;font-weight:500}
.toast.success{border-color:var(--success)}.toast.success .toast-icon{color:var(--success)}
.toast.error{border-color:var(--error)}.toast.error .toast-icon{color:var(--error)}
.toast.info{border-color:var(--accent)}.toast.info .toast-icon{color:var(--accent)}

/* ===================== BOTTOM NAV (mobile) ===================== */
.bottom-nav{
  display:none;height:var(--bottomnav-h);
  background:var(--surface);border-top:1px solid var(--border);
  flex-shrink:0;
}
.bottom-nav-inner{display:flex;height:100%}
.bnav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;cursor:pointer;color:var(--text-muted);transition:all 0.15s;
  font-size:11px;font-weight:600;user-select:none;position:relative;
  border:none;background:none;
}
.bnav-item:hover{color:var(--text)}
.bnav-item.active{color:var(--accent)}
.bnav-item.active::before{
  content:'';position:absolute;top:0;left:20%;right:20%;
  height:2px;background:var(--accent);border-radius:0 0 3px 3px;
}
.bnav-icon{font-size:22px;line-height:1}
.bnav-badge{
  position:absolute;top:8px;right:50%;margin-right:-22px;
  background:var(--accent);color:#fff;font-size:8px;font-weight:700;
  padding:1px 4px;border-radius:100px;min-width:14px;text-align:center;
}
.bnav-badge.green{background:var(--success)}

/* ===================== RESPONSIVE ===================== */
@media(max-width:768px){
  .sidebar{display:none}
  .bottom-nav{display:block}
  .app-body{flex-direction:column}
  .content{padding:14px}
  .rmbg-layout{grid-template-columns:1fr}
  .gallery-grid{grid-template-columns:repeat(2,1fr)}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .card-grid{grid-template-columns:1fr}
  .px-editor{flex-direction:column}
  .px-sidebar{width:100%;max-height:220px;border-right:none;border-bottom:1px solid var(--border)}
  .px-tool-grid{grid-template-columns:repeat(8,1fr)}
  .topbar-logo-name{display:none}
  .topbar-user-info{display:none}
  .topbar-api{display:none}
  /* make more room for content */
  .app-body{
    height:calc(100vh - var(--topbar-h) - var(--bottomnav-h));
    overflow:hidden;
  }
  /* pixel editor full height on mobile */
  #panel-pixel.active{height:calc(100vh - var(--topbar-h) - var(--bottomnav-h))}
}
@media(min-width:769px){
  .topbar-logout-mobile{display:none}
  #panel-pixel.active{height:calc(100vh - var(--topbar-h))}
  .app-body{height:calc(100vh - var(--topbar-h))}
}
@media(max-width:480px){
  .gallery-grid{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:1fr}
  .px-sidebar{max-height:180px}
}

/* Pan cursor when pan tool active */
.px-viewport.panning{cursor:grabbing!important;}
.px-viewport.panning *{cursor:grabbing!important;}

/* Fullscreen fallback */
.px-editor-fullscreen{
  position:fixed!important;inset:0!important;z-index:9000!important;
  background:var(--bg)!important;
}
.px-editor-fullscreen .px-topbar{
  position:fixed!important;top:0!important;left:0!important;right:0!important;z-index:9001!important;
}
.px-editor-fullscreen .px-bottombar{
  position:fixed!important;bottom:0!important;left:0!important;right:0!important;z-index:9001!important;
}

::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text-subtle)}

/* Settings */
.settings-section{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px}
.settings-title{font-size:14px;font-weight:700;margin-bottom:12px}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
.settings-row:last-child{border-bottom:none;padding-bottom:0}
.settings-key{font-size:13px;font-weight:600}
.settings-val{font-size:12px;color:var(--text-muted);font-family:'JetBrains Mono',monospace}

/* ===== DRAG DROP OVERLAY ===== */
.drop-overlay{
  position:fixed;inset:0;z-index:8000;
  background:rgba(47,129,247,0.15);
  border:3px dashed var(--accent);
  display:none;align-items:center;justify-content:center;
  pointer-events:none;
}
.drop-overlay.active{display:flex;}
.drop-overlay-inner{
  background:var(--surface);border:2px solid var(--accent);
  border-radius:20px;padding:40px 60px;text-align:center;
  box-shadow:0 0 60px rgba(47,129,247,0.3);
}
.drop-overlay-icon{font-size:48px;margin-bottom:12px}
.drop-overlay-text{font-size:18px;font-weight:700;color:var(--accent)}
.drop-overlay-sub{font-size:13px;color:var(--text-muted);margin-top:6px}

/* ===== ANIMATION FRAMES ===== */
.anim-frame-strip{display:flex;gap:6px;overflow-x:auto;padding:6px 0;min-height:64px;align-items:center;}
.anim-frame-thumb{
  width:52px;height:52px;flex-shrink:0;border-radius:6px;cursor:pointer;
  border:2px solid var(--border);
  background:repeating-conic-gradient(var(--card) 0% 25%,var(--surface) 0% 50%) 0 0/8px 8px;
  position:relative;image-rendering:pixelated;
}
.anim-frame-thumb.active{border-color:var(--accent);}
.anim-frame-thumb .frame-num{
  position:absolute;bottom:2px;right:3px;
  font-size:8px;font-weight:700;color:#fff;
  text-shadow:0 0 3px #000;
}
.anim-frame-add{
  width:52px;height:52px;flex-shrink:0;border-radius:6px;cursor:pointer;
  border:2px dashed var(--border);background:none;
  display:flex;align-items:center;justify-content:center;
  font-size:22px;color:var(--text-muted);transition:all 0.15s;
}
.anim-frame-add:hover{border-color:var(--accent);color:var(--accent);}
.anim-preview-wrap{
  display:none;position:fixed;inset:0;z-index:7000;
  background:rgba(0,0,0,0.7);align-items:center;justify-content:center;
}
.anim-preview-wrap.show{display:flex;}
.anim-preview-box{
  background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:24px;text-align:center;max-width:400px;width:90%;
}
.anim-preview-canvas{
  image-rendering:pixelated;max-width:280px;max-height:280px;
  border-radius:8px;
  background:repeating-conic-gradient(var(--card) 0% 25%,var(--surface) 0% 50%) 0 0/12px 12px;
}
</style>
</head>
<body>

<!-- ===================== LOGIN ===================== -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">üé®</div>
    <div class="login-title">TR BG Studio</div>
    <div class="login-subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û</div>
    <div class="login-badge">
      <div class="api-dot"></div>
      <span>Key API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
    </div>
    <div class="login-label">üîë Access Key</div>
    <div class="login-input-wrap">
      <input type="password" id="loginKey" class="login-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
      <button class="login-eye" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
    </div>
    <button class="login-btn" onclick="attemptLogin()">üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div class="login-error" id="loginError">‚ùå Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>
  </div>
</div>

<!-- ===================== APP ===================== -->
<div id="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-logo">
      <div class="topbar-logo-icon">üé®</div>
      <div class="topbar-logo-name">TR BG Studio</div>
    </div>
    <div class="topbar-spacer"></div>
    <div class="topbar-api">
      <div class="api-dot"></div>
      <span>API SECURE</span>
    </div>
    <div class="topbar-user">
      <button id="themeToggleBtn" onclick="toggleTheme()" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°" style="background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-size:16px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">üåô</button>
      <div class="topbar-user-info">
        <div class="topbar-username" id="userName">Member</div>
        <div class="topbar-role" id="userRole">Member</div>
      </div>
      <div class="topbar-avatar" id="userAvatar">M</div>
      <button class="topbar-logout" onclick="logout()" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">üö™</button>
    </div>
  </div>

  <!-- BODY -->
  <div class="app-body">
    <!-- SIDEBAR (desktop) -->
    <div class="sidebar">
      <div class="sidebar-section-title">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>
      <div class="nav-item active" onclick="showPanel('home',this)">
        <span class="nav-icon">üè†</span><span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
      </div>
      <div class="nav-item" onclick="showPanel('remove-bg',this)">
        <span class="nav-icon">‚úÇÔ∏è</span><span>‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</span>
        <span class="nav-badge green">AI</span>
      </div>
      <div class="nav-item" onclick="showPanel('pixel',this)">
        <span class="nav-icon">üéÆ</span><span>Pixel Art Editor</span>
      </div>
      <div class="nav-item" onclick="showPanel('gallery',this)">
        <span class="nav-icon">üñºÔ∏è</span><span>‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</span>
        <span class="nav-badge" id="galleryCount">0</span>
      </div>
      <div class="sidebar-section-title">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
      <div class="nav-item" onclick="showPanel('stats',this)">
        <span class="nav-icon">üìà</span><span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
      </div>
      <div class="nav-item" onclick="showPanel('logs',this)">
        <span class="nav-icon">üìã</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
      </div>
      <div class="sidebar-section-title" id="adminSection" style="display:none">üëë ADMIN</div>
      <div class="nav-item" id="adminKeysNav" style="display:none" onclick="showPanel('admin-keys',this)">
        <span class="nav-icon">üîë</span><span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå</span>
        <span class="nav-badge gold">ADMIN</span>
      </div>
      <div class="sidebar-section-title">‚öôÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
      <div class="nav-item" onclick="showPanel('settings',this)">
        <span class="nav-icon">‚öôÔ∏è</span><span>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
      </div>
      <div class="sidebar-footer">
        <div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--card);border-radius:8px">
          <div class="topbar-avatar" id="sidebarAvatar" style="width:28px;height:28px;font-size:11px">M</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="sidebarName">Member</div>
            <div style="font-size:10px;color:var(--text-muted)" id="sidebarRole">Member</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="content-wrap">
      <div class="content" id="contentArea">

        <!-- HOME -->
        <div id="panel-home" class="panel active">
          <div class="page-header">
            <div class="page-title">üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="welcomeName">Member</span>!</div>
            <div class="page-sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
          </div>
          <div class="card-grid">
            <div class="card" onclick="showPanel('remove-bg')">
              <div class="card-icon">‚úÇÔ∏è</div>
              <div class="card-title">‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
              <div class="card-desc">‡πÉ‡∏ä‡πâ AI ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ Manual Edit</div>
            </div>
            <div class="card" onclick="showPanel('pixel')">
              <div class="card-icon">üéÆ</div>
              <div class="card-title">Pixel Art Editor</div>
              <div class="card-desc">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Pixel Art ‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡∏£‡∏ö ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>
            </div>
            <div class="card" onclick="showPanel('gallery')">
              <div class="card-icon">üñºÔ∏è</div>
              <div class="card-title">‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</div>
              <div class="card-desc">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏†‡∏≤‡∏û‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏î‡πâ</div>
            </div>
            <div class="card" onclick="showPanel('stats')">
              <div class="card-icon">üìä</div>
              <div class="card-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
              <div class="card-desc">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Real-time</div>
            </div>
            <div class="card" onclick="showPanel('logs')">
              <div class="card-icon">üìã</div>
              <div class="card-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
              <div class="card-desc">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="card" id="homeAdminCard" style="display:none" onclick="showPanel('admin-keys')">
              <div class="card-icon">üîë</div>
              <div class="card-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå</div>
              <div class="card-desc">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</div>
            </div>
          </div>
        </div>

        <!-- REMOVE BG -->
        <div id="panel-remove-bg" class="panel">
          <div class="page-header">
            <div class="page-title">‚úÇÔ∏è ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
            <div class="page-sub">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ‚Üí AI ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‚Üí ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠ ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
          </div>
          <div class="action-row">
            <button class="btn btn-secondary" onclick="document.getElementById('bgInput').click()">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
            <button class="btn btn-primary" onclick="processRemoveBg()">üöÄ ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á AI</button>
            <button class="btn btn-success" onclick="downloadNoBg()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PNG</button>
          </div>
          <input type="file" id="bgInput" accept="image/*" style="display:none" onchange="loadImageForBg(this)">
          <!-- Manual toolbar -->
          <div class="rmbg-toolbar" id="rmbgToolbar" style="display:none;margin-bottom:14px">
            <span style="font-size:11px;font-weight:700;color:var(--text-muted);flex-shrink:0">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á:</span>
            <div class="rmbg-tool-btn active" id="rmbgToolErase" onclick="setRmbgTool('erase')">üßπ ‡∏•‡∏ö</div>
            <div class="rmbg-tool-btn" id="rmbgToolRestore" onclick="setRmbgTool('restore')">‚úÖ ‡∏Ñ‡∏∑‡∏ô</div>
            <div class="rmbg-tool-btn" id="rmbgToolMagic" onclick="setRmbgTool('magic')">ü™Ñ Magic</div>
            <div class="rmbg-tool-btn" id="rmbgToolSmartEdge" onclick="setRmbgTool('smartedge')" title="‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ ‚Äî ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ">üéØ Smart Edge</div>
            <div class="rmbg-divider"></div>
            <span style="font-size:11px;color:var(--text-muted);flex-shrink:0">‡∏Ç‡∏ô‡∏≤‡∏î</span>
            <input type="range" class="form-input" id="rmbgBrushSize" min="5" max="80" value="20" oninput="updateBrushSizeLabel(this.value)" style="width:80px;height:5px">
            <span id="rmbgBrushSizeLabel" style="font-size:11px;font-family:'JetBrains Mono',monospace;min-width:22px">20</span>
            <div class="rmbg-tolerance-wrap" id="rmbgToleranceWrap" style="display:none;align-items:center;gap:5px">
              <span style="font-size:11px;color:var(--text-muted)">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</span>
              <input type="range" class="form-input" id="rmbgTolerance" min="10" max="200" value="60" oninput="updateToleranceLabel(this.value)" style="width:80px;height:5px">
              <span id="rmbgToleranceLabel" style="font-size:11px;font-family:'JetBrains Mono',monospace;min-width:22px">60</span>
            </div>
            <!-- Smart Edge controls -->
            <div id="rmbgSmartEdgeWrap" style="display:none;align-items:center;gap:5px">
              <span style="font-size:11px;color:var(--text-muted)">‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ</span>
              <input type="range" class="form-input" id="rmbgEdgeSensitivity" min="5" max="100" value="30" oninput="updateEdgeLabel(this.value)" style="width:80px;height:5px">
              <span id="rmbgEdgeLabel" style="font-size:11px;font-family:'JetBrains Mono',monospace;min-width:22px">30</span>
            </div>
            <div class="rmbg-divider"></div>
            <button class="btn btn-sm btn-secondary" onclick="rmbgUndo()">‚Ü©Ô∏è Undo</button>
            <button class="btn btn-sm btn-danger" onclick="rmbgReset()">üîÑ Reset</button>
          </div>
          <div class="rmbg-layout">
            <div class="preview-box">
              <div class="preview-title">üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</div>
              <div class="zoom-wrap">
                <div class="preview-img" id="originalPreview" style="overflow:auto">
                  <div class="preview-placeholder">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
                </div>
                <div class="zoom-controls">
                  <button class="zoom-btn" onclick="zoomImg('orig',-1)">‚àí</button>
                  <span class="zoom-pct" id="origZoomPct">100%</span>
                  <button class="zoom-btn" onclick="zoomImg('orig',1)">+</button>
                  <button class="zoom-btn zoom-reset" onclick="zoomImg('orig',0)" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï">‚Ü∫</button>
                </div>
              </div>
            </div>
            <div class="preview-box">
              <div class="preview-title">‚ú® ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå <span style="font-size:10px;color:var(--text-muted);font-weight:400">(‡∏ß‡∏≤‡∏î‡∏ö‡∏ô‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</span></div>
              <div class="zoom-wrap">
                <div class="rmbg-canvas-wrap" id="resultPreviewWrap">
                  <div class="preview-placeholder" id="resultPlaceholder">‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</div>
                  <canvas id="rmbgResultCanvas"></canvas>
                </div>
                <div class="zoom-controls">
                  <button class="zoom-btn" onclick="zoomImg('result',-1)">‚àí</button>
                  <span class="zoom-pct" id="resultZoomPct">100%</span>
                  <button class="zoom-btn" onclick="zoomImg('result',1)">+</button>
                  <button class="zoom-btn zoom-reset" onclick="zoomImg('result',0)" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï">‚Ü∫</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PIXEL ART EDITOR -->
        <div id="panel-pixel" class="panel">
          <!-- Start Screen -->
          <div id="pxStart" class="px-start">
            <div>
              <div style="font-size:44px;margin-bottom:12px">üéÆ</div>
              <div class="px-start-title">Pixel Art Editor</div>
              <div class="px-start-sub" style="margin-top:4px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
            </div>
            <div>
              <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
              <div class="px-presets">
                <div class="px-preset" onclick="pxQuickStart(8,8)">8√ó8<span>‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</span></div>
                <div class="px-preset" onclick="pxQuickStart(16,16)">16√ó16<span>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</span></div>
                <div class="px-preset" onclick="pxQuickStart(32,32)">32√ó32<span>‡∏™‡πÅ‡∏õ‡∏£‡∏ï‡πå</span></div>
                <div class="px-preset" onclick="pxQuickStart(64,64)">64√ó64<span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span></div>
                <div class="px-preset" onclick="pxQuickStart(128,128)">128√ó128<span>‡πÉ‡∏´‡∏ç‡πà</span></div>
              </div>
            </div>
            <div class="px-divider"><span>‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span></div>
            <div class="px-custom-row">
              <div class="px-custom-field">
                <label>‡∏Å‡∏ß‡πâ‡∏≤‡∏á (px)</label>
                <input type="number" id="pxW" value="32" min="4" max="256">
              </div>
              <span style="padding-bottom:10px;color:var(--text-muted);font-size:18px">√ó</span>
              <div class="px-custom-field">
                <label>‡∏™‡∏π‡∏á (px)</label>
                <input type="number" id="pxH" value="32" min="4" max="256">
              </div>
              <button class="btn btn-primary" onclick="pxCreateCanvas()" style="align-self:flex-end;padding:9px 18px">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
            </div>
            <div class="px-divider"><span>‡∏´‡∏£‡∏∑‡∏≠</span></div>
            <div class="px-upload-area" onclick="pxUploadImg()">
              <div class="px-upload-icon">üìÅ</div>
              <div class="px-upload-label">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
              <div class="px-upload-sub">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PNG, JPG, GIF</div>
            </div>
          </div>

          <!-- Editor -->
          <div id="pxEditor" class="px-editor">
            <!-- Top Bar (Fixed) -->
            <div class="px-topbar">
              <div class="px-topbar-title">üìÑ Pixel Art</div>
              <!-- Layer indicator -->
              <div id="pxLayerIndicator" style="display:none;align-items:center;gap:5px;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:11px;font-weight:700;cursor:pointer;flex-shrink:0;" onclick="showBottomTab('layers')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Layers">
                <span style="color:var(--text-muted)">üìë</span>
                <span id="pxLayerIndicatorName" style="color:var(--text);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Layer 1</span>
                <span id="pxLayerIndicatorNum" style="color:var(--text-muted);font-size:9px;"></span>
              </div>
              <button class="px-topbar-btn" onclick="pxToggleFullscreen()" title="‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠" id="btnFullscreen">‚õ∂</button>
              <button class="px-topbar-btn" onclick="pxSave()" title="Save PNG">üíæ</button>
            </div>
            <!-- Sidebar tools -->
            <div class="px-sidebar">
              <!-- Canvas size -->
              <div class="px-section">
                <div class="px-section-label">üìê Canvas</div>
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
                  <input type="number" id="pxW2" class="form-input" value="32" min="4" max="256" style="padding:6px 8px;flex:1">
                  <span style="color:var(--text-muted);font-size:13px">√ó</span>
                  <input type="number" id="pxH2" class="form-input" value="32" min="4" max="256" style="padding:6px 8px;flex:1">
                  <button class="btn btn-sm btn-primary" onclick="pxResizeCanvas()" title="‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î">‚Ü©</button>
                </div>
                <button class="btn btn-sm btn-secondary" style="width:100%" onclick="pxBackToStart()">‚óÄ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Canvas</button>
              </div>


              <!-- Mirror toggle only (rest in floating toolbar) -->
              <div class="px-section">
                <div class="px-section-label">üõ†Ô∏è ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</div>
                <div style="display:flex;gap:4px">
                  <button class="btn btn-sm btn-secondary" style="flex:1" id="pxToolbarToggle" onclick="toggleFloatingToolbar()">üìã ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</button>
                  <button class="btn btn-sm btn-secondary" style="flex:1" onclick="toggleMirror()" title="M">ü™û ‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô</button>
                </div>
              </div>

              <!-- Animation Frames -->
              <div class="px-section">
                <div class="px-section-label">üéûÔ∏è ‡πÄ‡∏ü‡∏£‡∏° Animation</div>
                <div class="anim-frame-strip" id="animFrameStrip"></div>
                <div style="display:flex;gap:4px;margin-top:6px">
                  <button class="btn btn-sm btn-secondary" style="flex:1" onclick="animAddFrame()">‚ûï ‡πÄ‡∏ü‡∏£‡∏°</button>
                  <button class="btn btn-sm btn-danger" style="flex:1" onclick="animDeleteFrame()">üóëÔ∏è ‡∏•‡∏ö</button>
                  <button class="btn btn-sm btn-primary" style="flex:1" onclick="openAnimPreview()">‚ñ∂ Preview</button>
                </div>
              </div>
              <!-- Layers -->
              <div class="px-section">
                <div class="px-section-label">üìë ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå</div>
                <div id="pxLayerList" style="display:flex;flex-direction:column;gap:4px;max-height:200px;overflow-y:auto;margin-bottom:8px"></div>
                <div style="display:flex;gap:4px">
                  <button class="btn btn-sm btn-secondary" style="flex:1" onclick="pxAddLayer()">‚ûï ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</button>
                  <button class="btn btn-sm btn-danger" style="flex:1" onclick="pxDeleteLayer()">üóëÔ∏è ‡∏•‡∏ö</button>
                </div>
              </div>

              <!-- Color -->
              <div class="px-section">
                <div class="px-section-label">üé® ‡∏™‡∏µ</div>
                <div class="px-color-display">
                  <div class="px-color-box" id="pxCurColorBox" style="background:#000"></div>
                  <div>
                    <div class="px-color-label">HEX CODE</div>
                    <div class="px-color-hex" id="pxColorHex">#000000</div>
                  </div>
                </div>
                <input type="color" id="pxColorPicker" class="px-color-picker" value="#000000" onchange="setPxColor(this.value)">
              </div>

              <!-- Palette -->
              <div class="px-section">
                <div class="px-section-label">üé® ‡∏à‡∏≤‡∏ô‡∏™‡∏µ</div>
                <div class="px-palette-grid" id="pxPaletteGrid"></div>
                <div style="display:flex;gap:5px">
                  <button class="btn btn-sm btn-secondary" style="flex:1" onclick="addColorToPalette()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ</button>
                  <button class="btn btn-sm btn-secondary" style="flex:1" onclick="resetPalette()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                </div>
              </div>

              <!-- Info & Zoom -->
              <div class="px-section">
                <div class="px-section-label">‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                <div class="px-info-row" style="margin-bottom:6px">
                  <div class="px-info-chip">
                    <div class="px-info-chip-label">‡∏Ç‡∏ô‡∏≤‡∏î</div>
                    <div class="px-info-chip-value" id="pxInfoSize">-</div>
                  </div>
                  <div class="px-info-chip">
                    <div class="px-info-chip-label">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>
                    <div class="px-info-chip-value" id="pxInfoTool" style="font-size:11px">‚úèÔ∏è</div>
                  </div>
                </div>
                <div class="px-info-chip" style="margin-bottom:8px">
                  <div class="px-info-chip-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                  <div class="px-info-chip-value" id="pxCoordInfo" style="font-size:11px">-</div>
                </div>
              </div>

              <!-- Actions -->
              <div class="px-section">
                <div class="px-section-label">üíæ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
                <div style="display:flex;flex-direction:column;gap:5px">
                  <div style="display:flex;gap:5px">
                    <button class="btn btn-sm btn-secondary" style="flex:1" onclick="pxUndo()">‚Ü©Ô∏è Undo</button>
                    <button class="btn btn-sm btn-secondary" style="flex:1" onclick="pxRedo()">‚Ü™Ô∏è Redo</button>
                  </div>
                  <div style="display:flex;gap:5px">
                    <button class="btn btn-sm btn-secondary" style="flex:1" onclick="pxUploadImg()">üìÅ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
                    <button class="btn btn-sm btn-danger" style="flex:1" onclick="pxClear()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
                  </div>
                  <button class="btn btn-success" style="width:100%;font-size:13px" onclick="pxSave()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
                </div>
              </div>
            </div>

            <!-- Viewport -->
            <div class="px-viewport">
              <div class="px-viewport-inner">
                <div class="px-canvas-wrap">
                  <canvas id="pxCanvasEl"></canvas>
                </div>
              </div>
            </div>
            
            <!-- Pan Mode Indicator -->
            <div class="pan-mode-bar" id="panModeBar">‚úã ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (Pan Mode) ‚Äî ‡∏Å‡∏î Space ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠ P/E/F/K ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</div>

            <!-- Bottom Bar (Fixed) -->
            <div class="px-bottombar" style="flex-wrap:wrap;min-height:70px;height:auto;">
              <!-- Row: Tools + all controls -->
              <div style="display:flex;align-items:center;gap:5px;width:100%;flex-wrap:nowrap;overflow-x:auto;">
                <!-- Undo/Redo with state -->
                <button id="btnUndo" class="px-topbar-btn" style="width:36px;height:36px;font-size:15px;opacity:0.4;cursor:default;" onclick="pxUndo()" title="Undo (Ctrl+Z)">‚Ü©Ô∏è</button>
                <button id="btnRedo" class="px-topbar-btn" style="width:36px;height:36px;font-size:15px;opacity:0.4;cursor:default;" onclick="pxRedo()" title="Redo (Ctrl+Y)">‚Ü™Ô∏è</button>

                <div style="width:1px;height:28px;background:var(--border);flex-shrink:0;margin:0 2px;"></div>

                <!-- Tools with kbd tooltips ‚Äî ‡∏ß‡∏≤‡∏î/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
                <button class="tool-icon active" id="toolPen" onclick="setPxTool('pen')" title="Pen [P]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><span class="kbd-tip">‚úèÔ∏è Pen [P]</span><span class="kbd-badge">P</span></button>
                <button class="tool-icon" id="toolErase" onclick="setPxTool('erase')" title="Erase [E]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16l10-10 7 7-3.5 3.5"/><path d="M6.0001 11 13 18"/></svg><span class="kbd-tip">üßπ Erase [E]</span><span class="kbd-badge">E</span></button>
                <button class="tool-icon" id="toolFill" onclick="setPxTool('fill')" title="Fill [F]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m19 11-8-8-8.5 8.5a5.5 5.5 0 0 0 7.78 7.78L19 11Z"/><path d="m5 2 5 5"/><path d="M2 13h15"/><path d="M22 20a2 2 0 1 1-4 0c0-1.6 1.7-2.4 2-4 .3 1.6 2 2.4 2 4Z"/></svg><span class="kbd-tip">ü™£ Fill [F]</span><span class="kbd-badge">F</span></button>
                <button class="tool-icon" id="toolGradient" onclick="setPxTool('gradient')" title="Gradient Fill [G]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><defs><linearGradient id="gi" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="currentColor" stop-opacity="0.2"/><stop offset="100%" stop-color="currentColor"/></linearGradient></defs><rect x="3" y="3" width="18" height="18" rx="2" fill="url(#gi)" stroke="currentColor"/></svg><span class="kbd-tip">Gradient [G]</span><span class="kbd-badge">G</span></button>
                <button class="tool-icon" id="toolLine" onclick="setPxTool('line')" title="‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á [L]"><svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="19" x2="19" y2="5"/></svg><span class="kbd-tip">üìè Line [L]</span><span class="kbd-badge">L</span></button>
                <button class="tool-icon" id="toolRect" onclick="setPxTool('rect')" title="‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° [R]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="1"/></svg><span class="kbd-tip">‚ñ≠ Rect [R]</span><span class="kbd-badge">R</span></button>
                <button class="tool-icon" id="toolCircle" onclick="setPxTool('circle')" title="‡∏ß‡∏á‡∏Å‡∏•‡∏° [C]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg><span class="kbd-tip">‚≠ï Circle [C]</span><span class="kbd-badge">C</span></button>
                <button class="tool-icon" id="toolPick" onclick="setPxTool('pick')" title="Eyedropper [K]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 22l1-1h3l9-9"/><path d="M3 21v-3l9-9"/><path d="m15 6 3.4-3.4a2.1 2.1 0 1 1 3 3L18 9l.4.4a2.1 2.1 0 1 1-3 3l-3.8-3.8Z"/></svg><span class="kbd-tip">Eyedropper [K]</span><span class="kbd-badge">K</span></button>
                <button class="tool-icon" id="toolDither" onclick="setPxTool('dither')" title="Dither [D]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="4" height="4" fill="currentColor" stroke="none" rx="1"/><rect x="11" y="3" width="4" height="4" fill="currentColor" stroke="none" rx="1"/><rect x="3" y="11" width="4" height="4" fill="currentColor" stroke="none" rx="1"/><rect x="11" y="11" width="4" height="4" fill="currentColor" stroke="none" rx="1"/><rect x="7" y="7" width="4" height="4" opacity="0.4" fill="currentColor" stroke="none" rx="1"/><rect x="15" y="7" width="4" height="4" opacity="0.4" fill="currentColor" stroke="none" rx="1"/><rect x="7" y="15" width="4" height="4" opacity="0.4" fill="currentColor" stroke="none" rx="1"/><rect x="15" y="15" width="4" height="4" opacity="0.4" fill="currentColor" stroke="none" rx="1"/></svg><span class="kbd-tip">Dither [D]</span><span class="kbd-badge">D</span></button>

                <div style="width:1px;height:28px;background:var(--border);flex-shrink:0;margin:0 4px;"></div>

                <!-- ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô + ‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô -->
                <button class="tool-icon" id="toolPan" onclick="setPxTool('pan')" title="Pan [Space]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 11V6a2 2 0 0 0-2-2 2 2 0 0 0-2 2"/><path d="M14 10V4a2 2 0 0 0-2-2 2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2 2 2 0 0 0-2 2v8"/><path d="M18 11a2 2 0 1 1 4 0v3a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg><span class="kbd-tip">‚úã Pan [Space]</span><span class="kbd-badge">SPC</span></button>
                <button class="tool-icon" id="toolMirror" onclick="toggleMirror()" title="Mirror [M]"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18"/><path d="m8 7-4 5 4 5"/><path d="m16 7 4 5-4 5"/></svg><span class="kbd-tip">Mirror [M]</span><span class="kbd-badge">M</span></button>

                <div style="width:1px;height:28px;background:var(--border);flex-shrink:0;margin:0 2px;"></div>

                <!-- Color preview + picker -->
                <div style="display:flex;align-items:center;gap:4px;flex-shrink:0;cursor:pointer;" onclick="document.getElementById('pxColorPicker').click()" title="‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)">
                  <div id="pxCurColorBoxBar" style="width:28px;height:28px;border-radius:6px;border:2px solid var(--border);background:#000;flex-shrink:0;"></div>
                  <span id="pxColorHexBar" style="font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:var(--text);min-width:54px;">#000000</span>
                </div>
                <input type="color" id="pxColorPicker" class="color-picker-inline" value="#000000" onchange="setPxColor(this.value)" style="width:0;height:0;opacity:0;position:absolute;" title="Color">
                <!-- Color2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Gradient -->
                <div id="color2Wrap" style="display:flex;align-items:center;gap:3px;flex-shrink:0;opacity:0.4;transition:opacity 0.2s;pointer-events:none;" title="‡∏™‡∏µ‡∏ó‡∏µ‡πà 2 (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Gradient)">
                  <span style="font-size:9px;color:var(--text-muted);font-weight:700;">‚Üí</span>
                  <div style="cursor:pointer;position:relative;" onclick="document.getElementById('pxColor2Picker').click()">
                    <div id="pxColor2Box" style="width:24px;height:24px;border-radius:5px;border:2px solid var(--border);background:#ffffff;flex-shrink:0;"></div>
                  </div>
                  <span id="pxColor2Hex" style="font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:var(--text-muted);min-width:48px;">#ffffff</span>
                </div>
                <input type="color" id="pxColor2Picker" value="#ffffff" onchange="setPxColor2(this.value)" style="width:0;height:0;opacity:0;position:absolute;" title="Color2">

                <div style="width:1px;height:28px;background:var(--border);flex-shrink:0;margin:0 2px;"></div>

                <!-- Brush size -->
                <span style="font-size:14px;flex-shrink:0;">üñä</span>
                <button onclick="changeBrushSize(-1)" style="width:24px;height:24px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">‚àí</button>
                <span id="brushSizeLabel" style="font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:700;min-width:18px;text-align:center;color:var(--text);">1</span>
                <button onclick="changeBrushSize(1)" style="width:24px;height:24px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">+</button>

                <div style="width:1px;height:28px;background:var(--border);flex-shrink:0;margin:0 2px;"></div>

                <!-- Zoom quick access -->
                <button onclick="pxZoom(-1)" style="width:28px;height:28px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;font-weight:700;flex-shrink:0;">‚àí</button>
                <span id="pxZoomLabel" style="min-width:38px;text-align:center;color:var(--text);font-weight:700;font-family:'JetBrains Mono',monospace;font-size:11px;flex-shrink:0;">√ó8</span>
                <button onclick="pxZoom(1)" style="width:28px;height:28px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;font-weight:700;flex-shrink:0;">+</button>

                <div style="width:1px;height:28px;background:var(--border);flex-shrink:0;margin:0 2px;"></div>

                <!-- Grid toggle -->
                <button id="btnGrid" onclick="toggleGrid()" style="background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text-muted);cursor:pointer;font-size:11px;padding:4px 8px;white-space:nowrap;height:32px;flex-shrink:0;" title="Toggle Grid">‚äû Grid</button>
                <!-- Rect fill mode (shown always, relevant when rect active) -->
                <button id="btnRectFill" onclick="toggleRectFill()" style="background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text-muted);cursor:pointer;font-size:11px;padding:4px 8px;white-space:nowrap;height:32px;flex-shrink:0;" title="Rect: Outline / Fill">‚ñ≠ Outline</button>

                <!-- Layer quick actions -->
                <button onclick="pxMoveLayerUp()" style="background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text-muted);cursor:pointer;font-size:14px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;flex-shrink:0;" title="Layer ‡∏Ç‡∏∂‡πâ‡∏ô">‚¨ÜÔ∏è</button>
                <button onclick="pxMoveLayerDown()" style="background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text-muted);cursor:pointer;font-size:14px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;flex-shrink:0;" title="Layer ‡∏•‡∏á">‚¨áÔ∏è</button>

                <div style="flex:1;min-width:4px;"></div>

                <!-- Tab Buttons -->
                <button class="tab-btn" id="tabLayers" onclick="showBottomTab('layers')" title="Layers" style="width:36px;height:36px;font-size:16px;">üìë</button>
                <button class="tab-btn" id="tabSettings" onclick="showBottomTab('settings')" title="Settings" style="width:36px;height:36px;font-size:16px;">‚öôÔ∏è</button>
              </div>
            </div>
            
            <!-- Pop-up: Layers Panel -->
            <div class="px-popup-panel" id="panelLayers">
              <div class="px-popup-header">
                <span>üìë Layers</span>
                <button class="px-popup-close" onclick="closeBottomPanel()">‚úï</button>
              </div>
              <div class="px-popup-content">
                <div id="pxLayerList" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px"></div>
                <div style="display:flex;gap:4px">
                  <button class="btn btn-sm btn-secondary" style="flex:1" onclick="pxAddLayer()">‚ûï New</button>
                  <button class="btn btn-sm btn-danger" style="flex:1" onclick="pxDeleteLayer()">üóëÔ∏è</button>
                </div>
              </div>
            </div>
            
            <!-- Pop-up: Settings Panel -->
            <div class="px-popup-panel" id="panelSettings">
              <div class="px-popup-header">
                <span>‚öôÔ∏è Settings</span>
                <button class="px-popup-close" onclick="closeBottomPanel()">‚úï</button>
              </div>
              <div class="px-popup-content">
                <!-- Canvas size -->
                <div style="margin-bottom:12px">
                  <div style="font-size:12px;font-weight:700;margin-bottom:6px">Canvas Size</div>
                  <div style="display:flex;align-items:center;gap:6px">
                    <input type="number" id="pxW2" class="form-input" value="32" min="4" max="256" style="padding:6px 8px;flex:1">
                    <span style="color:var(--text-muted);font-size:13px">√ó</span>
                    <input type="number" id="pxH2" class="form-input" value="32" min="4" max="256" style="padding:6px 8px;flex:1">
                    <button class="btn btn-sm btn-primary" onclick="pxResizeCanvas()">‚Ü©</button>
                  </div>
                </div>
                
                <!-- Color Palette -->
                <div style="margin-bottom:12px">
                  <div style="font-size:12px;font-weight:700;margin-bottom:6px">üé® Palette</div>
                  <div class="px-palette-grid" id="pxPaletteGrid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:4px;margin-bottom:8px"></div>
                  <div style="display:flex;gap:4px">
                    <button class="btn btn-sm btn-secondary" style="flex:1" onclick="addColorToPalette()">‚ûï Add</button>
                    <button class="btn btn-sm btn-secondary" style="flex:1" onclick="resetPalette()" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏≤‡πÄ‡∏•‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                  </div>
                </div>
                
                <!-- Clear & Back -->
                <div style="display:flex;gap:4px">
                  <button class="btn btn-sm btn-secondary" style="flex:1" onclick="pxUploadImg()">üìÅ Import</button>
                  <button class="btn btn-sm btn-danger" style="flex:1" onclick="pxClear()">üóëÔ∏è Clear</button>
                </div>
                <button class="btn btn-sm btn-secondary" style="width:100%;margin-top:8px" onclick="pxBackToStart()">‚óÄ Back</button>
              </div>
            </div>
          </div>

          <input type="file" id="pxImgInput" accept="image/*" style="display:none" onchange="pxLoadImage(this)">
        </div>

        <!-- GALLERY -->
        <div id="panel-gallery" class="panel">
          <div class="page-header">
            <div class="page-title">üñºÔ∏è ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</div>
            <div class="page-sub">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 10 ‡∏†‡∏≤‡∏û</div>
          </div>
          <div class="gallery-grid" id="galleryGrid"></div>
          <div class="gallery-empty" id="galleryEmpty">
            <div style="font-size:56px;margin-bottom:12px;opacity:0.4">üñºÔ∏è</div>
            <div style="font-size:16px;font-weight:700;margin-bottom:6px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û</div>
            <div style="font-size:13px">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</div>
          </div>
        </div>

        <!-- STATS -->
        <div id="panel-stats" class="panel">
          <div class="page-header">
            <div class="page-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div class="page-sub">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-time</div>
          </div>
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-icon">üé®</div><div class="stat-value" id="statProcessed">0</div><div class="stat-label">‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</div></div>
            <div class="stat-card"><div class="stat-icon">üíæ</div><div class="stat-value" id="statDownloads">0</div><div class="stat-label">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</div></div>
            <div class="stat-card"><div class="stat-icon">‚ö°</div><div class="stat-value" id="statApiCalls">0</div><div class="stat-label">API Calls</div></div>
            <div class="stat-card"><div class="stat-icon">‚è±Ô∏è</div><div class="stat-value" id="statUptime">0h</div><div class="stat-label">Session Time</div></div>
          </div>
        </div>

        <!-- LOGS -->
        <div id="panel-logs" class="panel">
          <div class="page-header">
            <div class="page-title">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
            <div class="page-sub">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="logs-wrap" id="logsContainer"></div>
        </div>

        <!-- ADMIN KEYS -->
        <div id="panel-admin-keys" class="panel">
          <div class="page-header">
            <div class="page-title">üîë ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå</div>
            <div class="page-sub">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå</div>
          </div>
          <button class="btn btn-primary" onclick="openAddKeyModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà</button>
          <div class="key-list" id="keyList"></div>
        </div>

        <!-- SETTINGS -->
        <div id="panel-settings" class="panel">
          <div class="page-header">
            <div class="page-title">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
            <div class="page-sub">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
          </div>
          <div class="settings-section">
            <div class="settings-title">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
            <div class="settings-row"><span class="settings-key">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span><span class="settings-val" id="settingsUsername">-</span></div>
            <div class="settings-row"><span class="settings-key">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span><span class="settings-val" id="settingsRole">-</span></div>
            <div class="settings-row"><span class="settings-key">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span><span class="settings-val" id="settingsLoginTime">-</span></div>
          </div>
          <div class="settings-section">
            <div class="settings-title">üîê ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
            <div class="settings-row"><span class="settings-key">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™</span><span class="settings-val">SHA-256</span></div>
            <div class="settings-row"><span class="settings-key">Session timeout</span><span class="settings-val">24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></div>
          </div>
          <button class="btn btn-danger" onclick="logout()" style="margin-top:4px">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

      </div><!-- end content -->
    </div><!-- end content-wrap -->
  </div><!-- end app-body -->

  <!-- BOTTOM NAV (mobile) -->
  <div class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="bnav-item active" onclick="showPanel('home',this)" data-panel="home">
        <div class="bnav-icon">üè†</div>
        <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
      </button>
      <button class="bnav-item" onclick="showPanel('remove-bg',this)" data-panel="remove-bg">
        <div class="bnav-icon">‚úÇÔ∏è</div>
        <span>‡∏•‡∏ö BG</span>
      </button>
      <button class="bnav-item" onclick="showPanel('pixel',this)" data-panel="pixel">
        <div class="bnav-icon">üéÆ</div>
        <span>Pixel</span>
      </button>
      <button class="bnav-item" onclick="showPanel('gallery',this)" data-panel="gallery">
        <div class="bnav-icon">üñºÔ∏è</div>
        <span>‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</span>
        <span class="bnav-badge" id="bnavGalleryCount" style="display:none"></span>
      </button>
      <button class="bnav-item" onclick="showPanel('logs',this)" data-panel="logs">
        <div class="bnav-icon">üìã</div>
        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
      </button>
      <button class="bnav-item" onclick="showPanel('settings',this)" data-panel="settings">
        <div class="bnav-icon">‚öôÔ∏è</div>
        <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
      </button>
    </div>
  </div>

</div><!-- end app -->

<!-- MODALS -->
<div class="modal-overlay" id="addKeyModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà</div>
      <button class="modal-close" onclick="closeAddKeyModal()">√ó</button>
    </div>
    <div class="form-row">
      <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
      <input type="text" id="newKeyUsername" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô User01">
    </div>
    <div class="form-row">
      <label class="form-label">‡∏Ñ‡∏µ‡∏¢‡πå</label>
      <input type="text" id="newKeyCode" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô TR-user01">
    </div>
    <div class="form-row">
      <label class="form-label">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</label>
      <select id="newKeyRole" class="form-select">
        <option value="member">Member</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="addNewKey()">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå</button>
  </div>
</div>

<div class="modal-overlay" id="imageModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">üñºÔ∏è ‡∏î‡∏π‡∏†‡∏≤‡∏û</div>
      <button class="modal-close" onclick="closeImageModal()">√ó</button>
    </div>
    <div style="text-align:center">
      <img id="modalImage" style="max-width:100%;border-radius:8px;background:repeating-conic-gradient(#21262d 0% 25%,#161b22 0% 50%) 0 0/16px 16px">
      <div style="margin-top:14px;display:flex;gap:8px;justify-content:center">
        <button class="btn btn-primary" onclick="downloadModalImage()">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
        <button class="btn btn-danger" onclick="deleteModalImage()">üóëÔ∏è ‡∏•‡∏ö</button>
      </div>
    </div>
  </div>
</div>

<div id="toastContainer"></div>

<!-- DROP OVERLAY -->
<div class="drop-overlay" id="dropOverlay">
  <div class="drop-overlay-inner">
    <div class="drop-overlay-icon">üìÇ</div>
    <div class="drop-overlay-text">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</div>
    <div class="drop-overlay-sub" id="dropOverlaySub">‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>
  </div>
</div>

<!-- ANIMATION PREVIEW MODAL -->
<div class="anim-preview-wrap" id="animPreviewModal">
  <div class="anim-preview-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div style="font-weight:700;font-size:15px">üéûÔ∏è Animation Preview</div>
      <button onclick="closeAnimPreview()" style="background:none;border:none;cursor:pointer;font-size:20px;color:var(--text-muted)">‚úï</button>
    </div>
    <canvas class="anim-preview-canvas" id="animPreviewCanvas"></canvas>
    <div style="margin-top:12px;display:flex;gap:6px;align-items:center;justify-content:center;flex-wrap:wrap;">
      <label style="font-size:12px;color:var(--text-muted)">FPS:</label>
      <input type="range" id="animFpsSlider" min="1" max="24" value="6" oninput="updateAnimFps(this.value)" style="width:80px">
      <span id="animFpsLabel" style="font-size:12px;font-weight:700;min-width:28px">6</span>
      <button class="btn btn-secondary btn-sm" onclick="toggleAnimPlay()">‚è∏Ô∏è</button>
    </div>
    <div style="margin-top:14px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="saveAnimAs('gif')">üéûÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å GIF</button>
      <button class="btn btn-secondary" onclick="saveAnimAs('png')">üñºÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PNG</button>
      <button class="btn btn-danger btn-sm" onclick="closeAnimPreview()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// SECURE KEY SYSTEM
// ============================================================
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function initKeys() {
  if (!localStorage.getItem('trStudioKeys')) {
    const defaultKeys = {
      'TaraRook':{username:'Admin',role:'admin',avatar:'A',active:true},
      'TR-user01':{username:'User01',role:'member',avatar:'U1',active:true},
      'TR-user02':{username:'User02',role:'member',avatar:'U2',active:true},
      'TR-user03':{username:'User03',role:'member',avatar:'U3',active:true}
    };
    localStorage.setItem('trStudioKeys', JSON.stringify(defaultKeys));
  }
}
function getKeys(){const d=localStorage.getItem('trStudioKeys');return d?JSON.parse(d):{}}
function saveKeys(k){localStorage.setItem('trStudioKeys',JSON.stringify(k))}

let currentUser=null, sessionStartTime=null, currentImageId=null;

function togglePasswordVisibility(){
  const inp=document.getElementById('loginKey');
  const btn=event.target;
  if(inp.type==='password'){inp.type='text';btn.textContent='üôà';}
  else{inp.type='password';btn.textContent='üëÅÔ∏è';}
}

async function attemptLogin(){
  const keyInput=document.getElementById('loginKey').value.trim();
  const errEl=document.getElementById('loginError');
  if(!keyInput){errEl.style.display='block';errEl.textContent='‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Key';return;}
  const keys=getKeys();
  if(keys[keyInput]&&keys[keyInput].active){
    const kd=keys[keyInput];
    currentUser={key:keyInput,...kd,loginTime:new Date().toISOString()};
    const hashedKey=await sha256(keyInput+Date.now());
    const sessionData=btoa(JSON.stringify({token:hashedKey,key:keyInput,timestamp:Date.now()}));
    localStorage.setItem('trStudioSession',sessionData);
    localStorage.setItem('trStudioSessionVerify',await sha256(sessionData));
    sessionStartTime=Date.now();
    updateUserUI();
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('app').style.display='flex';
    addLog('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: '+currentUser.username,'success');
    showToast('üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö '+currentUser.username+'!','success');
    startUptimeCounter(); loadGallery();
    if(currentUser.role==='admin'){
      document.getElementById('adminSection').style.display='block';
      document.getElementById('adminKeysNav').style.display='flex';
      document.getElementById('homeAdminCard').style.display='block';
      loadKeyList();
    }
    document.getElementById('loginKey').value='';
  }
}

function updateUserUI(){
  ['userName','sidebarName'].forEach(id=>document.getElementById(id).textContent=currentUser.username);
  document.getElementById('userRole').textContent=currentUser.role==='admin'?'Administrator':'Member';
  document.getElementById('sidebarRole').textContent=currentUser.role==='admin'?'Administrator':'Member';
  ['userAvatar','sidebarAvatar'].forEach(id=>{
    document.getElementById(id).textContent=currentUser.avatar;
    if(currentUser.role==='admin') document.getElementById(id).classList.add('admin');
  });
  document.getElementById('welcomeName').textContent=currentUser.username;
  document.getElementById('settingsUsername').textContent=currentUser.username;
  document.getElementById('settingsRole').textContent=currentUser.role==='admin'?'Administrator':'Member';
  document.getElementById('settingsLoginTime').textContent=new Date(currentUser.loginTime).toLocaleString('th-TH');
}

async function checkSession(){
  const sd=localStorage.getItem('trStudioSession');
  const sv=localStorage.getItem('trStudioSessionVerify');
  if(!sd||!sv) return false;
  const ch=await sha256(sd);
  if(ch!==sv){logout();showToast('‚ö†Ô∏è Session ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error');return false;}
  try{
    const s=JSON.parse(atob(sd));
    if(Date.now()-s.timestamp>24*60*60*1000){logout();showToast('‚è±Ô∏è Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏','info');return false;}
    const keys=getKeys();
    if(keys[s.key]&&keys[s.key].active){
      currentUser={key:s.key,...keys[s.key],loginTime:new Date(s.timestamp).toISOString()};
      sessionStartTime=s.timestamp;
      updateUserUI();
      document.getElementById('loginScreen').style.display='none';
      document.getElementById('app').style.display='flex';
      startUptimeCounter(); loadGallery();
      if(currentUser.role==='admin'){
        document.getElementById('adminSection').style.display='block';
        document.getElementById('adminKeysNav').style.display='flex';
        document.getElementById('homeAdminCard').style.display='block';
        loadKeyList();
      }
      return true;
    }
  }catch(e){logout();}
  return false;
}

function logout(){
  localStorage.removeItem('trStudioSession');
  localStorage.removeItem('trStudioSessionVerify');
  currentUser=null; sessionStartTime=null;
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('app').style.display='none';
  document.getElementById('loginKey').value='';
  document.getElementById('loginError').style.display='none';
  document.getElementById('adminSection').style.display='none';
  document.getElementById('adminKeysNav').style.display='none';
  document.getElementById('homeAdminCard').style.display='none';
  showToast('üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß','info');
}

document.addEventListener('DOMContentLoaded',function(){
  initKeys();
  document.getElementById('loginKey').addEventListener('keypress',function(e){if(e.key==='Enter')attemptLogin();});
  checkSession();
});

// ============================================================
// KEY MANAGEMENT
// ============================================================
function loadKeyList(){
  const keys=getKeys();
  const container=document.getElementById('keyList');
  container.innerHTML='';
  for(const[key,data] of Object.entries(keys)){
    const item=document.createElement('div');
    item.className='key-item';
    item.innerHTML=`
      <div class="key-icon">${data.avatar}</div>
      <div class="key-details"><div class="key-name">${data.username}</div><div class="key-code">${key}</div></div>
      <div class="key-status ${data.active?'':'inactive'}">${data.active?'Active':'Inactive'}</div>
      <button class="btn btn-sm btn-danger" onclick="deleteKey('${key}')">üóëÔ∏è</button>
    `;
    container.appendChild(item);
  }
}
function openAddKeyModal(){document.getElementById('addKeyModal').classList.add('active')}
function closeAddKeyModal(){document.getElementById('addKeyModal').classList.remove('active')}
function addNewKey(){
  const username=document.getElementById('newKeyUsername').value.trim();
  const keyCode=document.getElementById('newKeyCode').value.trim();
  const role=document.getElementById('newKeyRole').value;
  if(!username||!keyCode){showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error');return;}
  const keys=getKeys();
  if(keys[keyCode]){showToast('‚ùå ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß','error');return;}
  keys[keyCode]={username,role,avatar:username.substring(0,2).toUpperCase(),active:true};
  saveKeys(keys); loadKeyList(); closeAddKeyModal();
  document.getElementById('newKeyUsername').value='';
  document.getElementById('newKeyCode').value='';
  addLog('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå: '+keyCode,'success');
  showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!','success');
}
function deleteKey(key){
  if(key==='TaraRook'){showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå Admin ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ','error');return;}
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå '+key+' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  const keys=getKeys();
  delete keys[key]; saveKeys(keys); loadKeyList();
  addLog('‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå: '+key,'info'); showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß','info');
}

// ============================================================
// GALLERY
// ============================================================
function getGalleryKey(){return 'trGallery_'+(currentUser?currentUser.key:'guest')}
function getGallery(){const d=localStorage.getItem(getGalleryKey());return d?JSON.parse(d):[]}
function saveGallery(g){
  const key=getGalleryKey();
  // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ñ‡πâ‡∏≤ localStorage ‡πÄ‡∏ï‡πá‡∏° ‡∏•‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
  const trySave=()=>{
    try{
      localStorage.setItem(key,JSON.stringify(g));
      return true;
    }catch(e){
      if(g.length>1){
        g.pop(); // ‡∏•‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
        return trySave();
      }
      showToast('‚ö†Ô∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ','error');
      return false;
    }
  };
  trySave();
}

// ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: Compress ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î 70-80%
function compressImage(dataUrl, quality=0.25, maxW=800, maxH=800){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.width, h=img.height;
      if(w>maxW||h>maxH){
        const ratio=Math.min(maxW/w,maxH/h);
        w=Math.round(w*ratio); h=Math.round(h*ratio);
      }
      const canvas=document.createElement('canvas');
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      resolve(canvas.toDataURL('image/jpeg',quality));
    };
    img.onerror=()=>resolve(dataUrl); // fallback ‡∏ñ‡πâ‡∏≤ compress ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    img.src=dataUrl;
  });
}

async function addToGallery(imageData,name,type='pixel'){
  let g=getGallery();
  // Compress ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö
  const compressed=await compressImage(imageData);
  g.unshift({id:Date.now(),name,type,data:compressed,date:new Date().toISOString()});
  if(g.length>10) g=g.slice(0,10);
  saveGallery(g); loadGallery();
  addLog('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û: '+name,'success');
}
function loadGallery(){
  const g=getGallery();
  const container=document.getElementById('galleryGrid');
  const emptyEl=document.getElementById('galleryEmpty');
  const count=g.length;
  document.getElementById('galleryCount').textContent=count;
  const bnavCount=document.getElementById('bnavGalleryCount');
  if(count>0){bnavCount.textContent=count;bnavCount.style.display='block';}
  else{bnavCount.style.display='none';}
  if(count===0){container.style.display='none';emptyEl.style.display='block';return;}
  container.style.display='grid'; emptyEl.style.display='none';
  container.innerHTML='';
  g.forEach(img=>{
    const item=document.createElement('div');
    item.className='gallery-item';
    item.innerHTML=`
      <div class="gallery-thumb"><img src="${img.data}" alt="${img.name}"></div>
      <div class="gallery-info">
        <div class="gallery-name">${img.name}</div>
        <div class="gallery-date">${new Date(img.date).toLocaleString('th-TH')}</div>
        <div class="gallery-actions">
          <button class="btn btn-sm btn-secondary" onclick="viewImage(${img.id})">üëÅÔ∏è</button>
          <button class="btn btn-sm btn-primary" onclick="downloadImage(${img.id})">üíæ</button>
          <button class="btn btn-sm btn-danger" onclick="deleteImage(${img.id})">üóëÔ∏è</button>
        </div>
      </div>
    `;
    container.appendChild(item);
  });
}
function viewImage(id){
  const g=getGallery(); const img=g.find(i=>i.id===id); if(!img) return;
  currentImageId=id; document.getElementById('modalImage').src=img.data;
  document.getElementById('imageModal').classList.add('active');
}
function closeImageModal(){document.getElementById('imageModal').classList.remove('active');currentImageId=null;}
function downloadImage(id){
  const g=getGallery(); const img=g.find(i=>i.id===id); if(!img) return;
  const a=document.createElement('a'); a.href=img.data; a.download=img.name; a.click();
  statsDownloads++; updateStats(); addLog('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î: '+img.name,'success');
  showToast('üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
}
function downloadModalImage(){if(currentImageId)downloadImage(currentImageId);}
function deleteImage(id){
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  let g=getGallery(); const img=g.find(i=>i.id===id);
  g=g.filter(i=>i.id!==id); saveGallery(g); loadGallery();
  if(currentImageId===id) closeImageModal();
  addLog('‡∏•‡∏ö‡∏†‡∏≤‡∏û: '+(img?img.name:id),'info'); showToast('üóëÔ∏è ‡∏•‡∏ö‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß','info');
}
function deleteModalImage(){if(currentImageId)deleteImage(currentImageId);}

// ============================================================
// NAVIGATION
// ============================================================
let currentPanel='home';
let statsProcessed=0, statsDownloads=0, statsApiCalls=0;
let logs=[];

function showPanel(panelId, triggerEl){
  // Hide all panels
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+panelId).classList.add('active');

  // Sidebar active state
  document.querySelectorAll('.sidebar .nav-item').forEach(i=>i.classList.remove('active'));
  // Bottom nav active state
  document.querySelectorAll('.bnav-item').forEach(i=>i.classList.remove('active'));

  // Activate trigger or find by panel id
  if(triggerEl){
    const navItem=triggerEl.closest ? triggerEl.closest('.nav-item')||triggerEl : triggerEl;
    navItem.classList.add('active');
  }
  // Also sync other nav (sidebar ‚Üî bottom nav)
  document.querySelectorAll('.sidebar .nav-item').forEach(item=>{
    if(item.getAttribute('onclick')&&item.getAttribute('onclick').includes("'"+panelId+"'"))
      item.classList.add('active');
  });
  document.querySelectorAll('.bnav-item').forEach(item=>{
    if(item.dataset.panel===panelId) item.classList.add('active');
  });

  currentPanel=panelId;
  document.title='TR BG Studio ‚Äî '+{home:'‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å','remove-bg':'‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á',pixel:'Pixel Art',gallery:'‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà',stats:'‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥',logs:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','admin-keys':'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå',settings:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤'}[panelId];

  // Scroll content back to top
  document.getElementById('contentArea').scrollTop=0;
}

// ============================================================
// TOAST + LOG
// ============================================================
function showToast(message,type='info'){
  const container=document.getElementById('toastContainer');
  const toast=document.createElement('div');
  toast.className='toast '+type;
  const icons={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'};
  toast.innerHTML=`<div class="toast-icon">${icons[type]||'‚ÑπÔ∏è'}</div><div class="toast-msg">${message}</div>`;
  container.appendChild(toast);
  setTimeout(()=>{toast.style.animation='toastIn 0.3s ease reverse';setTimeout(()=>toast.remove(),300);},3000);
}
function addLog(message,type='info'){
  const time=new Date().toLocaleTimeString('th-TH');
  logs.unshift({time,message,type});
  if(logs.length>100) logs.pop();
  const container=document.getElementById('logsContainer');
  const icons={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'};
  const logEl=document.createElement('div');
  logEl.className='log-item '+type;
  logEl.innerHTML=`<div class="log-time">${time}</div><div class="log-icon">${icons[type]||'‚ÑπÔ∏è'}</div><div class="log-msg">${message}</div>`;
  container.insertBefore(logEl,container.firstChild);
}
function updateStats(){
  document.getElementById('statProcessed').textContent=statsProcessed;
  document.getElementById('statDownloads').textContent=statsDownloads;
  document.getElementById('statApiCalls').textContent=statsApiCalls;
}
function startUptimeCounter(){
  setInterval(()=>{
    if(!sessionStartTime) return;
    const h=Math.floor((Date.now()-sessionStartTime)/(1000*60*60));
    document.getElementById('statUptime').textContent=h+'h';
  },60000);
}

// ============================================================
// REMOVE BG
// ============================================================
let originalImage=null, resultImage=null;
let rmbgCurrentTool='erase', rmbgIsDrawing=false;
let rmbgHistory=[], rmbgCanvas=null, rmbgCtx=null;

function loadImageForBg(input){
  const file=input.files[0]; if(!file) return;
  // Reset zoom
  zoomState.orig=100; zoomState.result=100;
  document.getElementById('origZoomPct').textContent='100%';
  document.getElementById('resultZoomPct').textContent='100%';
  const reader=new FileReader();
  reader.onload=function(e){
    originalImage=e.target.result;
    const preview=document.getElementById('originalPreview');
    preview.innerHTML=`<img src="${originalImage}" alt="Original" style="width:100%;height:auto;max-width:none;max-height:none;">`;
    addLog('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: '+file.name,'success');
    showToast('üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
  };
  reader.readAsDataURL(file);
}

function processRemoveBg(){
  if(!originalImage){showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô','error');return;}
  showToast('üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...','info');
  statsApiCalls++; updateStats();
  const img=new Image();
  img.onload=function(){
    rmbgCanvas=document.getElementById('rmbgResultCanvas');
    rmbgCanvas.width=img.width; rmbgCanvas.height=img.height;
    rmbgCtx=rmbgCanvas.getContext('2d');
    rmbgCtx.drawImage(img,0,0);
    const imageData=rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height);
    simpleRemoveBg(imageData);
    rmbgCtx.putImageData(imageData,0,0);
    rmbgHistory=[rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height)];
    document.getElementById('resultPlaceholder').style.display='none';
    rmbgCanvas.style.display='block';
    document.getElementById('rmbgToolbar').style.display='flex';
    setupRmbgDrawing();
    resultImage=rmbgCanvas.toDataURL('image/png');
    statsProcessed++; updateStats();
    addLog('‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
    showToast('‚ú® ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏Ç‡∏ß‡∏≤','success');
  };
  img.src=originalImage;
}

function simpleRemoveBg(imageData){
  const data=imageData.data,w=imageData.width,h=imageData.height;
  function getPixel(x,y){const i=(y*w+x)*4;return[data[i],data[i+1],data[i+2],data[i+3]];}
  const corners=[getPixel(0,0),getPixel(w-1,0),getPixel(0,h-1),getPixel(w-1,h-1)];
  let bgR=0,bgG=0,bgB=0;
  corners.forEach(c=>{bgR+=c[0];bgG+=c[1];bgB+=c[2];});
  bgR=Math.round(bgR/4); bgG=Math.round(bgG/4); bgB=Math.round(bgB/4);
  for(let i=0;i<data.length;i+=4){
    if(Math.abs(data[i]-bgR)+Math.abs(data[i+1]-bgG)+Math.abs(data[i+2]-bgB)<180)
      data[i+3]=0;
  }
}

function setupRmbgDrawing(){
  if(!rmbgCanvas) return;
  rmbgCanvas.onmousedown=e=>{
    rmbgIsDrawing=true;
    rmbgHistory.push(rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height));
    if(rmbgHistory.length>20) rmbgHistory.shift();
    rmbgDraw(e);
  };
  rmbgCanvas.onmousemove=e=>{if(rmbgIsDrawing)rmbgDraw(e);};
  rmbgCanvas.onmouseup=()=>rmbgIsDrawing=false;
  rmbgCanvas.onmouseleave=()=>rmbgIsDrawing=false;
  rmbgCanvas.ontouchstart=e=>{e.preventDefault();rmbgIsDrawing=true;rmbgHistory.push(rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height));rmbgDraw(e.touches[0]);};
  rmbgCanvas.ontouchmove=e=>{e.preventDefault();if(rmbgIsDrawing)rmbgDraw(e.touches[0]);};
  rmbgCanvas.ontouchend=()=>rmbgIsDrawing=false;
}
function getRmbgPos(e){
  const rect=rmbgCanvas.getBoundingClientRect();
  return{x:(e.clientX-rect.left)*(rmbgCanvas.width/rect.width),y:(e.clientY-rect.top)*(rmbgCanvas.height/rect.height)};
}
function rmbgDraw(e){
  if(!rmbgCtx||!rmbgCanvas) return;
  const pos=getRmbgPos(e);
  const size=parseInt(document.getElementById('rmbgBrushSize').value)||20;
  const scale=rmbgCanvas.width/rmbgCanvas.getBoundingClientRect().width;
  const brushR=size/2*Math.max(scale||1,1);
  if(rmbgCurrentTool==='magic'){
    magicErase(Math.round(pos.x),Math.round(pos.y),parseInt(document.getElementById('rmbgTolerance').value)||60);
    return;
  }
  if(rmbgCurrentTool==='smartedge'){
    rmbgHistory.push(rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height));
    if(rmbgHistory.length>20) rmbgHistory.shift();
    smartEdgeErase(Math.round(pos.x),Math.round(pos.y));
    return;
  }
  rmbgCtx.save();
  if(rmbgCurrentTool==='erase'){
    rmbgCtx.globalCompositeOperation='destination-out';
    rmbgCtx.fillStyle='rgba(0,0,0,1)';
  } else if(rmbgCurrentTool==='restore'){
    const orig=new Image(); orig.src=originalImage;
    rmbgCtx.globalCompositeOperation='source-over';
    rmbgCtx.beginPath(); rmbgCtx.arc(pos.x,pos.y,brushR,0,Math.PI*2); rmbgCtx.clip();
    rmbgCtx.drawImage(orig,0,0,rmbgCanvas.width,rmbgCanvas.height);
    rmbgCtx.restore(); return;
  } else {
    rmbgCtx.globalCompositeOperation='destination-out';
    rmbgCtx.fillStyle='rgba(0,0,0,1)';
  }
  rmbgCtx.beginPath(); rmbgCtx.arc(pos.x,pos.y,brushR,0,Math.PI*2); rmbgCtx.fill();
  rmbgCtx.restore();
}
function magicErase(sx,sy,tolerance){
  const id=rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height);
  const data=id.data,w=rmbgCanvas.width,h=rmbgCanvas.height;
  const si=(sy*w+sx)*4;
  const tR=data[si],tG=data[si+1],tB=data[si+2];
  const visited=new Uint8Array(w*h);
  const queue=[[sx,sy]]; visited[sy*w+sx]=1;
  while(queue.length){
    const[x,y]=queue.pop(); const i=(y*w+x)*4; data[i+3]=0;
    for(const[nx,ny] of[[x+1,y],[x-1,y],[x,y+1],[x,y-1]]){
      if(nx<0||ny<0||nx>=w||ny>=h||visited[ny*w+nx]) continue;
      visited[ny*w+nx]=1;
      const ni=(ny*w+nx)*4;
      if(data[ni+3]>0&&Math.abs(data[ni]-tR)+Math.abs(data[ni+1]-tG)+Math.abs(data[ni+2]-tB)<=tolerance*3)
        queue.push([nx,ny]);
    }
  }
  rmbgCtx.putImageData(id,0,0);
}
function setRmbgTool(tool){
  rmbgCurrentTool=tool;
  document.querySelectorAll('.rmbg-tool-btn').forEach(b=>b.classList.remove('active'));
  const map={brush:'rmbgToolBrush',erase:'rmbgToolErase',restore:'rmbgToolRestore',magic:'rmbgToolMagic',smartedge:'rmbgToolSmartEdge'};
  if(map[tool]) document.getElementById(map[tool]).classList.add('active');
  // tolerance wrap
  document.getElementById('rmbgToleranceWrap').style.display=tool==='magic'?'flex':'none';
  // smart edge wrap
  const edgeWrap=document.getElementById('rmbgSmartEdgeWrap');
  if(edgeWrap) edgeWrap.style.display=tool==='smartedge'?'flex':'none';
  if(rmbgCanvas) rmbgCanvas.style.cursor=(tool==='magic'||tool==='smartedge')?'crosshair':'cell';
  showToast('üõ†Ô∏è '+{erase:'‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á',restore:'‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤',magic:'Magic Erase',smartedge:'Smart Edge'}[tool],'info');
}
function updateBrushSizeLabel(v){document.getElementById('rmbgBrushSizeLabel').textContent=v;}
function updateToleranceLabel(v){document.getElementById('rmbgToleranceLabel').textContent=v;}
function rmbgUndo(){
  if(rmbgHistory.length<=1){showToast('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ Undo','info');return;}
  rmbgHistory.pop();
  rmbgCtx.putImageData(rmbgHistory[rmbgHistory.length-1],0,0);
  showToast('‚Ü©Ô∏è Undo','info');
}
function rmbgReset(){
  if(!rmbgHistory.length) return;
  const first=rmbgHistory[0];
  rmbgCtx.putImageData(first,0,0); rmbgHistory=[first];
  showToast('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß','info');
}
function getTRFilename(prefix){
  const now=new Date();
  const pad=n=>String(n).padStart(2,'0');
  const d=`${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}`;
  const t=`${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
  return `TR_${prefix}_${d}_${t}.png`;
}
function downloadNoBg(){
  const filename=getTRFilename('BG');
  if(rmbgCanvas&&rmbgCanvas.style.display!=='none'){
    rmbgCanvas.toBlob(blob=>{
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
      const reader=new FileReader();
      reader.onloadend=()=>addToGallery(reader.result,filename,'remove-bg');
      reader.readAsDataURL(blob);
    },'image/png');
  } else {
    if(!resultImage){showToast('‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå','error');return;}
    const a=document.createElement('a'); a.href=resultImage; a.download=filename; a.click();
    addToGallery(resultImage,filename,'remove-bg');
  }
  statsDownloads++; updateStats();
  addLog('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û','success'); showToast('üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
}

// ============================================================
// PIXEL ART EDITOR
// ============================================================
let pxCols=32, pxRows=32, pxPixels=[];
let pxCurrentColor='#000000', pxCurrentTool='pen', pxZoomLevel=8;
let pxCanvasReady=false, pxIsDrawing=false;
let pxPreviewPixels=null, pxMouseCell=null;
let pxMirrorMode=false;
let draggedSwatch=null;
let pxPanStartX=0, pxPanStartY=0;
let pxIsFullscreen=false;
// Line tool state (global so pxRenderAll can access)
let lineStartCell=null;
let linePreviewSnapshot=null;
// Circle tool state
let circleStartCell=null;
let circlePreviewSnapshot=null;
// Rect tool state
let rectStartCell=null;
let rectPreviewSnapshot=null;
// Gradient + second color
let pxColor2='#ffffff';
// Rect fill mode toggle (outline vs filled)
let rectFillMode=false;

// Layer Management
let pxLayers=[];
let pxCurrentLayerIndex=0;
let pxLayerOffscreenCanvases=[];
let pxHistory=[], pxFuture=[];
let pxHistoryMaxSize=50;

// Layer object structure: {name, visible, opacity, pixels}
class PxLayer{
  constructor(cols,rows,name='Layer'){
    this.name=name;
    this.visible=true;
    this.opacity=1.0;
    this.pixels=new Array(cols*rows).fill(null);
  }
}

const DEFAULT_PALETTE=[
  '#000000','#FFFFFF','#FF0000','#00FF00','#0000FF','#FFFF00','#FF00FF','#00FFFF',
  '#C0C0C0','#808080','#800000','#808000','#008000','#800080','#008080','#000080',
  '#FF6B6B','#FFA500','#FFD93D','#6BCB77','#4D96FF','#9D84B7','#F38181','#95E1D3'
];
let pxPalette=DEFAULT_PALETTE.slice();

function pxBackToStart(){
  document.getElementById('pxEditor').classList.remove('visible');
  document.getElementById('pxStart').style.display='flex';
}

function pxQuickStart(w,h){
  document.getElementById('pxW').value=w;
  document.getElementById('pxH').value=h;
  pxCreateCanvas();
}

function pxCreateCanvas(){
  pxCols=Math.max(4,Math.min(256,parseInt(document.getElementById('pxW').value)||32));
  pxRows=Math.max(4,Math.min(256,parseInt(document.getElementById('pxH').value)||32));
  document.getElementById('pxW2').value=pxCols;
  document.getElementById('pxH2').value=pxRows;
  _pxInitCanvas();
  // init animation frames
  setTimeout(()=>{
    animFrames=[animSnapshotLayers()];
    animCurrentFrame=0;
    animRenderStrip();
  },50);
}

function pxResizeCanvas(){
  const newW=Math.max(4,Math.min(256,parseInt(document.getElementById('pxW2').value)||pxCols));
  const newH=Math.max(4,Math.min(256,parseInt(document.getElementById('pxH2').value)||pxRows));
  if(newW===pxCols&&newH===pxRows){showToast('‚ÑπÔ∏è ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°','info');return;}
  const newPixels=new Array(newW*newH).fill(null);
  for(let r=0;r<Math.min(pxRows,newH);r++)
    for(let c=0;c<Math.min(pxCols,newW);c++)
      newPixels[r*newW+c]=pxPixels[r*pxCols+c];
  pxCols=newW; pxRows=newH; pxPixels=newPixels;
  document.getElementById('pxW').value=pxCols;
  document.getElementById('pxH').value=pxRows;
  pxHistory=[]; pxFuture=[];
  const maxDim=Math.max(pxCols,pxRows);
  if(maxDim<=8)pxZoomLevel=40;else if(maxDim<=16)pxZoomLevel=24;
  else if(maxDim<=32)pxZoomLevel=14;else if(maxDim<=64)pxZoomLevel=8;
  else if(maxDim<=128)pxZoomLevel=4;else pxZoomLevel=2;
  pxRenderAll(); pxUpdateInfo();
  showToast('‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÅ‡∏•‡πâ‡∏ß','success');
}

function _pxInitCanvas(){
  const maxDim=Math.max(pxCols,pxRows);
  if(maxDim<=8)pxZoomLevel=40;else if(maxDim<=16)pxZoomLevel=24;
  else if(maxDim<=32)pxZoomLevel=14;else if(maxDim<=64)pxZoomLevel=8;
  else if(maxDim<=128)pxZoomLevel=4;else pxZoomLevel=2;
  
  // Initialize layers instead of pxPixels
  pxLayers=[];
  pxLayerOffscreenCanvases=[];
  const firstLayer=new PxLayer(pxCols,pxRows,'Layer 1');
  pxLayers.push(firstLayer);
  pxCurrentLayerIndex=0;
  
  // Create offscreen canvas for first layer
  const offscreenCanvas=document.createElement('canvas');
  offscreenCanvas.width=pxCols;
  offscreenCanvas.height=pxRows;
  pxLayerOffscreenCanvases.push(offscreenCanvas);
  
  pxHistory=[]; pxFuture=[]; pxCanvasReady=true;
  document.getElementById('pxStart').style.display='none';
  document.getElementById('pxEditor').classList.add('visible');
  pxRenderAll(); pxUpdateInfo(); pxRenderLayerList();
  addLog('‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas: '+pxCols+'√ó'+pxRows,'success');
  showToast('‚ú® Canvas ‡∏û‡∏£‡πâ‡∏≠‡∏°!','success');
}

// hex color parse cache ‚Äî ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ parseInt ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
const _hexCache={};
function _parseHex(hex){
  if(_hexCache[hex]) return _hexCache[hex];
  const v=[parseInt(hex.slice(1,3),16),parseInt(hex.slice(3,5),16),parseInt(hex.slice(5,7),16)];
  _hexCache[hex]=v; return v;
}

// offscreen composite canvas (1x pixel size) ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥
let _pxCompositeCanvas=null;
let _pxCompositeCtx=null;
let _pxLastZoom=-1;
let _pxLastCols=-1;
let _pxLastRows=-1;

function pxRenderAll(){
  if(!pxCanvasReady) return;
  const canvas=document.getElementById('pxCanvasEl');
  const scaledW=pxCols*pxZoomLevel;
  const scaledH=pxRows*pxZoomLevel;

  // Resize main canvas only when zoom/size actually changes
  if(canvas.width!==scaledW||canvas.height!==scaledH){
    canvas.width=scaledW; canvas.height=scaledH;
  }
  const ctx=canvas.getContext('2d');

  // Rebuild composite offscreen only when dims change
  if(!_pxCompositeCanvas||_pxLastCols!==pxCols||_pxLastRows!==pxRows){
    _pxCompositeCanvas=document.createElement('canvas');
    _pxCompositeCanvas.width=pxCols; _pxCompositeCanvas.height=pxRows;
    _pxCompositeCtx=_pxCompositeCanvas.getContext('2d');
    _pxLastCols=pxCols; _pxLastRows=pxRows;
  }

  // Draw checkerboard background (transparent indicator) into composite
  const cc=_pxCompositeCtx;
  cc.clearRect(0,0,pxCols,pxRows);

  // Build ImageData for all layers combined ‚Äî single pass
  const imgData=cc.createImageData(pxCols,pxRows);
  const d=imgData.data;

  // White base
  for(let i=0;i<d.length;i+=4){d[i]=255;d[i+1]=255;d[i+2]=255;d[i+3]=255;}

  for(let layerIdx=0;layerIdx<pxLayers.length;layerIdx++){
    const layer=pxLayers[layerIdx];
    if(!layer.visible) continue;
    const alpha=layer.opacity;
    const pixels=layer.pixels;
    for(let i=0;i<pixels.length;i++){
      const col=pixels[i];
      if(!col) continue;
      // Parse hex color once
      const [r,g,b]=_parseHex(col);
      const base=i*4;
      // Alpha blend over existing
      const a=alpha;
      d[base]  =Math.round(d[base]  *(1-a)+r*a);
      d[base+1]=Math.round(d[base+1]*(1-a)+g*a);
      d[base+2]=Math.round(d[base+2]*(1-a)+b*a);
      d[base+3]=255;
    }
  }
  cc.putImageData(imgData,0,0);

  // Scale composite to main canvas ‚Äî pixel-perfect
  ctx.imageSmoothingEnabled=false;
  ctx.drawImage(_pxCompositeCanvas,0,0,scaledW,scaledH);

  // Draw grid ‚Äî single path per axis
  if(pxShowGrid&&pxZoomLevel>=4){
    ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.lineWidth=1;
    ctx.beginPath();
    for(let c=0;c<=pxCols;c++){ctx.moveTo(c*pxZoomLevel,0);ctx.lineTo(c*pxZoomLevel,scaledH);}
    for(let r=0;r<=pxRows;r++){ctx.moveTo(0,r*pxZoomLevel);ctx.lineTo(scaledW,r*pxZoomLevel);}
    ctx.stroke();
  }

  // Brush cursor outline
  if(pxZoomLevel>=6&&(pxCurrentTool==='pen'||pxCurrentTool==='erase'||pxCurrentTool==='dither')&&pxMouseCell){
    const half=Math.floor(pxBrushSize/2);
    const px=(pxMouseCell.c-half)*pxZoomLevel;
    const py=(pxMouseCell.r-half)*pxZoomLevel;
    const pw=(pxBrushSize)*pxZoomLevel;
    ctx.strokeStyle='rgba(255,255,255,0.9)';ctx.lineWidth=2;
    ctx.strokeRect(px,py,pw,pw);
    ctx.strokeStyle='rgba(0,0,0,0.6)';ctx.lineWidth=1;
    ctx.strokeRect(px,py,pw,pw);
  }

  // Line tool start marker
  if(pxCurrentTool==='line'&&pxIsDrawing&&lineStartCell){
    const sx=(lineStartCell.c+0.5)*pxZoomLevel;
    const sy=(lineStartCell.r+0.5)*pxZoomLevel;
    ctx.strokeStyle='rgba(47,129,247,0.8)';ctx.lineWidth=Math.max(1,pxZoomLevel/6);
    ctx.beginPath();const r=Math.max(3,pxZoomLevel*0.4);
    ctx.moveTo(sx-r,sy-r);ctx.lineTo(sx+r,sy+r);ctx.moveTo(sx+r,sy-r);ctx.lineTo(sx-r,sy+r);ctx.stroke();
  }
  // Circle tool center marker
  if(pxCurrentTool==='circle'&&pxIsDrawing&&circleStartCell&&pxMouseCell){
    const cx=(circleStartCell.c+0.5)*pxZoomLevel,cy=(circleStartCell.r+0.5)*pxZoomLevel;
    const mx=(pxMouseCell.c+0.5)*pxZoomLevel,my=(pxMouseCell.r+0.5)*pxZoomLevel;
    ctx.strokeStyle='rgba(47,129,247,0.6)';ctx.lineWidth=1;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(mx,my);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle='rgba(47,129,247,0.9)';ctx.beginPath();ctx.arc(cx,cy,Math.max(2,pxZoomLevel/4),0,Math.PI*2);ctx.fill();
  }
  // Rect start marker
  if(pxCurrentTool==='rect'&&pxIsDrawing&&rectStartCell){
    const sx=(rectStartCell.c+0.5)*pxZoomLevel,sy=(rectStartCell.r+0.5)*pxZoomLevel;
    ctx.fillStyle='rgba(47,129,247,0.9)';ctx.beginPath();ctx.arc(sx,sy,Math.max(2,pxZoomLevel/4),0,Math.PI*2);ctx.fill();
  }
}

function pxGetCell(e){
  const canvas=document.getElementById('pxCanvasEl');
  const rect=canvas.getBoundingClientRect();
  let x,y;
  if(e.touches&&e.touches[0]){x=e.touches[0].clientX-rect.left;y=e.touches[0].clientY-rect.top;}
  else{x=e.clientX-rect.left;y=e.clientY-rect.top;}
  const c=Math.floor((x/rect.width)*pxCols);
  const r=Math.floor((y/rect.height)*pxRows);
  if(c<0||c>=pxCols||r<0||r>=pxRows) return null;
  return{c,r};
}
function pxDrawPixel(cell,color){
  const layer=pxLayers[pxCurrentLayerIndex];
  const half=Math.floor(pxBrushSize/2);
  for(let dr=-half;dr<=half;dr++){
    for(let dc=-half;dc<=half;dc++){
      const nc=cell.c+dc, nr=cell.r+dr;
      if(nc<0||nc>=pxCols||nr<0||nr>=pxRows) continue;
      layer.pixels[nr*pxCols+nc]=color;
      if(pxMirrorMode) layer.pixels[nr*pxCols+(pxCols-1-nc)]=color;
    }
  }
  // Soft erase: only for brush size 1
  if(color===null&&pxCurrentTool==='erase'&&pxBrushSize===1){
    const dirs=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];
    for(let d of dirs){
      const nc=cell.c+d[0], nr=cell.r+d[1];
      if(nc>=0&&nc<pxCols&&nr>=0&&nr<pxRows){
        const idx=nr*pxCols+nc;
        const existing=layer.pixels[idx];
        if(existing&&existing!==null){
          const r1=parseInt(existing.substr(1,2),16);
          const g1=parseInt(existing.substr(3,2),16);
          const b1=parseInt(existing.substr(5,2),16);
          const blended='#'+[Math.round(r1*0.7),Math.round(g1*0.7),Math.round(b1*0.7)].map(v=>v.toString(16).padStart(2,'0')).join('');
          layer.pixels[idx]=blended;
          if(pxMirrorMode){
            const mirrNC=pxCols-1-nc;
            layer.pixels[nr*pxCols+mirrNC]=blended;
          }
        }
      }
    }
  }
}

function pxSaveHistory(){
  const layerSnapshot=pxLayers.map(l=>({...l,pixels:l.pixels.slice()}));
  pxHistory.push(layerSnapshot);
  if(pxHistory.length>pxHistoryMaxSize)pxHistory.shift();
  pxFuture=[];
  updateUndoRedoState();
}

function pxUndo(){
  if(!pxHistory.length)return;
  const currentSnapshot=pxLayers.map(l=>({...l,pixels:l.pixels.slice()}));
  pxFuture.push(currentSnapshot);
  const snapshot=pxHistory.pop();
  pxLayers=snapshot.map(l=>({...l,pixels:l.pixels.slice()}));
  pxRenderAll();
  updateUndoRedoState();
  showToast('‚Ü©Ô∏è Undo','info');
}

function pxRedo(){
  if(!pxFuture.length)return;
  const currentSnapshot=pxLayers.map(l=>({...l,pixels:l.pixels.slice()}));
  pxHistory.push(currentSnapshot);
  const snapshot=pxFuture.pop();
  pxLayers=snapshot.map(l=>({...l,pixels:l.pixels.slice()}));
  pxRenderAll();
  updateUndoRedoState();
  showToast('‚Ü™Ô∏è Redo','info');
}

function pxFill(sc,sr,tc,fc){
  const layer=pxLayers[pxCurrentLayerIndex];
  if(tc===fc) return;
  const stack=[[sc,sr]];
  while(stack.length){
    const[c,r]=stack.pop();
    if(c<0||c>=pxCols||r<0||r>=pxRows) continue;
    const idx=r*pxCols+c; if(layer.pixels[idx]!==tc) continue;
    layer.pixels[idx]=fc; stack.push([c+1,r],[c-1,r],[c,r+1],[c,r-1]);
  }
}
function pxBresenham(x0,y0,x1,y1,arr,color){
  const dx=Math.abs(x1-x0),dy=Math.abs(y1-y0);
  const sx=x0<x1?1:-1,sy=y0<y1?1:-1;
  let err=dx-dy;
  while(true){arr[y0*pxCols+x0]=color;if(x0===x1&&y0===y1)break;const e2=2*err;if(e2>-dy){err-=dy;x0+=sx;}if(e2<dx){err+=dx;y0+=sy;}}
}
function pxBresenhamWithMirror(x0,y0,x1,y1,arr,color){
  const dx=Math.abs(x1-x0),dy=Math.abs(y1-y0);
  const sx=x0<x1?1:-1,sy=y0<y1?1:-1;
  let err=dx-dy;
  while(true){
    arr[y0*pxCols+x0]=color;
    if(pxMirrorMode){
      const mx=pxCols-1-x0;
      arr[y0*pxCols+mx]=color;
    }
    if(x0===x1&&y0===y1)break;
    const e2=2*err;
    if(e2>-dy){err-=dy;x0+=sx;}
    if(e2<dx){err+=dx;y0+=sy;}
  }
}
function pxBresenhamCircle(xc,yc,r,arr,color){
  let x=0,y=r,d=3-2*r;
  while(y>=x){
    [[xc+x,yc+y],[xc-x,yc+y],[xc+x,yc-y],[xc-x,yc-y],[xc+y,yc+x],[xc-y,yc+x],[xc+y,yc-x],[xc-y,yc-x]].forEach(([cx,cy])=>{
      if(cx>=0&&cx<pxCols&&cy>=0&&cy<pxRows) arr[cy*pxCols+cx]=color;
    });
    x++; if(d>0){y--;d=d+4*(x-y)+10;}else d=d+4*x+6;
  }
}
function pxBresenhamCircleWithMirror(xc,yc,r,arr,color){
  let x=0,y=r,d=3-2*r;
  while(y>=x){
    [[xc+x,yc+y],[xc-x,yc+y],[xc+x,yc-y],[xc-x,yc-y],[xc+y,yc+x],[xc-y,yc+x],[xc+y,yc-x],[xc-y,yc-x]].forEach(([cx,cy])=>{
      if(cx>=0&&cx<pxCols&&cy>=0&&cy<pxRows) arr[cy*pxCols+cx]=color;
      if(pxMirrorMode){
        const mcx=pxCols-1-cx;
        if(mcx>=0&&mcx<pxCols&&cy>=0&&cy<pxRows) arr[cy*pxCols+mcx]=color;
      }
    });
    x++; if(d>0){y--;d=d+4*(x-y)+10;}else d=d+4*x+6;
  }
}
function pxBuildPreview(fn){pxPreviewPixels=pxPixels.slice();fn(pxPreviewPixels);}

// ‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢ brush block ‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á
function pxEraseBlock(cell){
  const layer=pxLayers[pxCurrentLayerIndex];
  const half=Math.floor(pxBrushSize/2);
  for(let dr=-half;dr<=half;dr++){
    for(let dc=-half;dc<=half;dc++){
      const nc=cell.c+dc, nr=cell.r+dr;
      if(nc<0||nc>=pxCols||nr<0||nr>=pxRows) continue;
      layer.pixels[nr*pxCols+nc]=null;
      if(pxMirrorMode) layer.pixels[nr*pxCols+(pxCols-1-nc)]=null;
    }
  }
}

// ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ brush block (pen)
function pxBresenhamLineWithBrush(x0,y0,x1,y1,color){
  const layer=pxLayers[pxCurrentLayerIndex];
  const half=Math.floor(pxBrushSize/2);
  const dx=Math.abs(x1-x0),dy=Math.abs(y1-y0);
  const sx=x0<x1?1:-1,sy=y0<y1?1:-1;
  let err=dx-dy, x=x0, y=y0;
  while(true){
    for(let dr=-half;dr<=half;dr++){
      for(let dc=-half;dc<=half;dc++){
        const nc=x+dc, nr=y+dr;
        if(nc>=0&&nc<pxCols&&nr>=0&&nr<pxRows){
          layer.pixels[nr*pxCols+nc]=color;
          if(pxMirrorMode) layer.pixels[nr*pxCols+(pxCols-1-nc)]=color;
        }
      }
    }
    if(x===x1&&y===y1) break;
    const e2=2*err;
    if(e2>-dy){err-=dy;x+=sx;}
    if(e2<dx){err+=dx;y+=sy;}
  }
}

// ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ brush block (erase)
function pxBresenhamLineErase(x0,y0,x1,y1){
  const layer=pxLayers[pxCurrentLayerIndex];
  const half=Math.floor(pxBrushSize/2);
  const dx=Math.abs(x1-x0),dy=Math.abs(y1-y0);
  const sx=x0<x1?1:-1,sy=y0<y1?1:-1;
  let err=dx-dy, x=x0, y=y0;
  while(true){
    for(let dr=-half;dr<=half;dr++){
      for(let dc=-half;dc<=half;dc++){
        const nc=x+dc, nr=y+dr;
        if(nc>=0&&nc<pxCols&&nr>=0&&nr<pxRows){
          layer.pixels[nr*pxCols+nc]=null;
          if(pxMirrorMode) layer.pixels[nr*pxCols+(pxCols-1-nc)]=null;
        }
      }
    }
    if(x===x1&&y===y1) break;
    const e2=2*err;
    if(e2>-dy){err-=dy;x+=sx;}
    if(e2<dx){err+=dx;y+=sy;}
  }
}

// Gap-free drawing: Bresenham's line algorithm on layer pixels
function pxBresenhamLine(x0,y0,x1,y1,color){
  const layer=pxLayers[pxCurrentLayerIndex];
  pxBresenhamLineOnPixels(layer.pixels,x0,y0,x1,y1,color);
  if(pxMirrorMode){
    pxBresenhamLineOnPixels(layer.pixels,pxCols-1-x0,y0,pxCols-1-x1,y1,color);
  }
}

// Draw Bresenham line directly on a pixels array (for preview and commit)
function pxBresenhamLineOnPixels(pixels,x0,y0,x1,y1,color){
  const dx=Math.abs(x1-x0), dy=Math.abs(y1-y0);
  const sx=x0<x1?1:-1, sy=y0<y1?1:-1;
  let err=dx-dy;
  let x=x0, y=y0;
  while(true){
    if(x>=0&&x<pxCols&&y>=0&&y<pxRows){
      pixels[y*pxCols+x]=color;
    }
    if(x===x1&&y===y1) break;
    const e2=2*err;
    if(e2>-dy){err-=dy;x+=sx;}
    if(e2<dx){err+=dx;y+=sy;}
  }
}

// Draw circle outline on pixels array using Midpoint Circle Algorithm
function pxDrawCircleOnPixels(pixels, xc, yc, r, color){
  const half=Math.floor(pxBrushSize/2);
  function setBlock(bx,by){
    for(let dr=-half;dr<=half;dr++){
      for(let dc=-half;dc<=half;dc++){
        const nx=bx+dc, ny=by+dr;
        if(nx>=0&&nx<pxCols&&ny>=0&&ny<pxRows) pixels[ny*pxCols+nx]=color;
      }
    }
  }
  if(r<=0){setBlock(xc,yc);return;}
  let x=0, y=r, d=3-2*r;
  while(y>=x){
    setBlock(xc+x,yc+y); setBlock(xc-x,yc+y);
    setBlock(xc+x,yc-y); setBlock(xc-x,yc-y);
    setBlock(xc+y,yc+x); setBlock(xc-y,yc+x);
    setBlock(xc+y,yc-x); setBlock(xc-y,yc-x);
    x++;
    if(d>0){y--;d=d+4*(x-y)+10;}
    else d=d+4*x+6;
  }
}

// Draw rectangle (outline or filled) on pixels array
function pxDrawRectOnPixels(pixels, x0, y0, x1, y1, color, filled){
  const minX=Math.max(0,Math.min(x0,x1));
  const maxX=Math.min(pxCols-1,Math.max(x0,x1));
  const minY=Math.max(0,Math.min(y0,y1));
  const maxY=Math.min(pxRows-1,Math.max(y0,y1));
  const half=Math.floor(pxBrushSize/2);
  function setBlock(bx,by){
    for(let dr=-half;dr<=half;dr++){
      for(let dc=-half;dc<=half;dc++){
        const nx=bx+dc, ny=by+dr;
        if(nx>=0&&nx<pxCols&&ny>=0&&ny<pxRows) pixels[ny*pxCols+nx]=color;
      }
    }
  }
  for(let y=minY;y<=maxY;y++){
    for(let x=minX;x<=maxX;x++){
      if(filled) pixels[y*pxCols+x]=color;
      else if(x===minX||x===maxX||y===minY||y===maxY) setBlock(x,y);
    }
  }
}

// Toggle rect fill mode (outline ‚Üî filled)
function toggleRectFill(){
  rectFillMode=!rectFillMode;
  const btn=document.getElementById('btnRectFill');
  if(btn){
    btn.textContent=rectFillMode?'‚ñ™ Fill':'‚ñ≠ Outline';
    btn.style.background=rectFillMode?'var(--accent-light)':'var(--card)';
    btn.style.borderColor=rectFillMode?'var(--accent)':'var(--border)';
    btn.style.color=rectFillMode?'var(--accent)':'var(--text-muted)';
  }
  showToast(rectFillMode?'‚ñ™ Rect: ‡πÅ‡∏ö‡∏ö‡∏ó‡∏∂‡∏ö':'‚ñ≠ Rect: ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏ö','info');
}

// Gradient fill ‚Äî flood fill ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏µ‡πÑ‡∏•‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö
function pxGradientFill(sc, sr, targetColor, color1, color2){
  const layer=pxLayers[pxCurrentLayerIndex];
  // BFS to find all connected pixels with targetColor
  const visited=new Uint8Array(pxCols*pxRows);
  const queue=[[sc,sr]];
  const region=[];
  visited[sr*pxCols+sc]=1;
  while(queue.length){
    const[x,y]=queue.shift();
    if(x<0||x>=pxCols||y<0||y>=pxRows) continue;
    if(layer.pixels[y*pxCols+x]!==targetColor) continue;
    region.push([x,y]);
    for(const[nx,ny] of[[x+1,y],[x-1,y],[x,y+1],[x,y-1]]){
      if(nx>=0&&nx<pxCols&&ny>=0&&ny<pxRows&&!visited[ny*pxCols+nx]&&layer.pixels[ny*pxCols+nx]===targetColor){
        visited[ny*pxCols+nx]=1;
        queue.push([nx,ny]);
      }
    }
  }
  if(!region.length) return;
  // Find bounding box for gradient direction (top‚Üíbottom)
  const minY=Math.min(...region.map(([,y])=>y));
  const maxY=Math.max(...region.map(([,y])=>y));
  const range=Math.max(1,maxY-minY);
  // Parse colors
  function hexToRgb(h){const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return[r,g,b];}
  function lerpColor(c1,c2,t){return c1.map((v,i)=>Math.round(v+(c2[i]-v)*t));}
  function rgbToHex([r,g,b]){return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}
  const rgb1=hexToRgb(color1), rgb2=hexToRgb(color2);
  for(const[x,y] of region){
    const t=(y-minY)/range;
    layer.pixels[y*pxCols+x]=rgbToHex(lerpColor(rgb1,rgb2,t));
  }
}

// Fullscreen toggle for pixel editor
function pxToggleFullscreen(){
  const editor=document.getElementById('pxEditor');
  if(!document.fullscreenElement){
    editor.requestFullscreen().then(()=>{
      document.getElementById('btnFullscreen').textContent='‚úï';
      showToast('‚õ∂ ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏î ESC ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å)','info');
    }).catch(()=>{
      // Fallback: CSS fullscreen
      editor.classList.toggle('px-editor-fullscreen');
      const isFs=editor.classList.contains('px-editor-fullscreen');
      document.getElementById('btnFullscreen').textContent=isFs?'‚úï':'‚õ∂';
      showToast(isFs?'‚õ∂ ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß':'‚Ü© ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠','info');
    });
  } else {
    document.exitFullscreen();
    document.getElementById('btnFullscreen').textContent='‚õ∂';
    showToast('‚Ü© ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠','info');
  }
}
document.addEventListener('fullscreenchange',()=>{
  if(!document.fullscreenElement){
    const btn=document.getElementById('btnFullscreen');
    if(btn) btn.textContent='‚õ∂';
  }
});

// Bottom Tab Functions
function showBottomTab(tab){
  closeBottomPanel();
  const panel=document.getElementById(`panel${tab.charAt(0).toUpperCase()}${tab.slice(1)}`);
  if(panel){
    panel.classList.add('visible');
    document.getElementById(`tab${tab.charAt(0).toUpperCase()}${tab.slice(1)}`).classList.add('active');
  }
}

function closeBottomPanel(){
  document.getElementById('panelLayers').classList.remove('visible');
  document.getElementById('panelSettings').classList.remove('visible');
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
}

// Update tool icons on selection
function updateToolIcons(){
  document.querySelectorAll('.tool-icon').forEach(btn=>{
    btn.classList.remove('active');
  });
  const toolMap={pen:'toolPen',erase:'toolErase',fill:'toolFill',pick:'toolPick',pan:'toolPan',line:'toolLine',circle:'toolCircle',rect:'toolRect',gradient:'toolGradient'};
  if(toolMap[pxCurrentTool]){
    document.getElementById(toolMap[pxCurrentTool]).classList.add('active');
  }
}

// Mouse/touch handlers
document.addEventListener('DOMContentLoaded',function(){
  const canvas=document.getElementById('pxCanvasEl');
  if(!canvas) return;
  let lastCell=null;
  let rafPending=false; // RAF throttle flag
  let pendingCell=null; // latest cell waiting to be drawn

  function onDown(e){
    e.preventDefault(); if(!pxCanvasReady) return;
    const clientX=e.touches?e.touches[0].clientX:e.clientX;
    const clientY=e.touches?e.touches[0].clientY:e.clientY;
    const cell=pxGetCell(e);
    pxIsDrawing=true;
    lastCell=cell;
    
    if(pxCurrentTool==='pan'){
      pxPanStartX=clientX;
      pxPanStartY=clientY;
      document.querySelector('.px-viewport').classList.add('panning');
      return;
    }
    
    if(!cell) return;
    
    if(pxCurrentTool==='pen'){pxSaveHistory();pxDrawPixel(cell,pxCurrentColor);pxRenderAll();}
    else if(pxCurrentTool==='erase'){pxSaveHistory();pxEraseBlock(cell);pxRenderAll();}
    else if(pxCurrentTool==='dither'){pxSaveHistory();pxDither(cell,pxCurrentColor,pxColor2);pxRenderAll();}
    else if(pxCurrentTool==='fill'){pxSaveHistory();const tc=pxLayers[pxCurrentLayerIndex].pixels[cell.r*pxCols+cell.c];pxFill(cell.c,cell.r,tc,pxCurrentColor);pxRenderAll();}
    else if(pxCurrentTool==='pick'){const color=pxLayers[pxCurrentLayerIndex].pixels[cell.r*pxCols+cell.c];if(color){setPxColor(color);document.getElementById('pxColorPicker').value=color;showToast('üíâ '+color,'info');}}
    else if(pxCurrentTool==='line'){
      lineStartCell=cell;
      linePreviewSnapshot=pxLayers[pxCurrentLayerIndex].pixels.slice();
    }
    else if(pxCurrentTool==='circle'){
      circleStartCell=cell;
      circlePreviewSnapshot=pxLayers[pxCurrentLayerIndex].pixels.slice();
    }
    else if(pxCurrentTool==='rect'){
      rectStartCell=cell;
      rectPreviewSnapshot=pxLayers[pxCurrentLayerIndex].pixels.slice();
    }
    else if(pxCurrentTool==='gradient'){
      pxSaveHistory();
      const tc=pxLayers[pxCurrentLayerIndex].pixels[cell.r*pxCols+cell.c];
      pxGradientFill(cell.c,cell.r,tc,pxCurrentColor,pxColor2);
      pxRenderAll();
    }
  }
  
  function onMove(e){
    e.preventDefault();
    const clientX=e.touches?e.touches[0].clientX:e.clientX;
    const clientY=e.touches?e.touches[0].clientY:e.clientY;
    const cell=pxGetCell(e);
    pxMouseCell=cell;
    if(pxCanvasReady&&cell) document.getElementById('pxCoordInfo').textContent=`(${cell.c},${cell.r})`;
    if(!pxIsDrawing) {
      if(pxCanvasReady&&!rafPending){
        rafPending=true;
        requestAnimationFrame(()=>{pxRenderAll();rafPending=false;});
      }
      return;
    }
    
    // Pan tool: scroll canvas
    if(pxCurrentTool==='pan'){
      const viewport=document.querySelector('.px-viewport');
      const dx=clientX-pxPanStartX;
      const dy=clientY-pxPanStartY;
      viewport.scrollLeft-=dx;
      viewport.scrollTop-=dy;
      pxPanStartX=clientX;
      pxPanStartY=clientY;
      return;
    }
    
    if(!cell) {
      if(pxCanvasReady) pxRenderAll();
      return;
    }
    
    if(pxCurrentTool==='pen'||pxCurrentTool==='erase'||pxCurrentTool==='dither'){
      // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤ cell ‡πÄ‡∏î‡∏¥‡∏° ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πâ‡∏≠‡∏á render
      if(lastCell&&lastCell.c===cell.c&&lastCell.r===cell.r) return;
      if(lastCell){
        if(pxCurrentTool==='pen') pxBresenhamLineWithBrush(lastCell.c,lastCell.r,cell.c,cell.r,pxCurrentColor);
        else if(pxCurrentTool==='erase') pxBresenhamLineErase(lastCell.c,lastCell.r,cell.c,cell.r);
        else pxDither(cell,pxCurrentColor,pxColor2);
      } else {
        if(pxCurrentTool==='pen') pxDrawPixel(cell,pxCurrentColor);
        else if(pxCurrentTool==='erase') pxEraseBlock(cell);
        else pxDither(cell,pxCurrentColor,pxColor2);
      }
      lastCell=cell;
      if(!rafPending){rafPending=true;requestAnimationFrame(()=>{pxRenderAll();rafPending=false;});}
      return;
    }

    // Line tool: live preview ‚Äî throttle with RAF
    if(pxCurrentTool==='line'&&lineStartCell&&linePreviewSnapshot){
      const layer=pxLayers[pxCurrentLayerIndex];
      layer.pixels=linePreviewSnapshot.slice();
      pxBresenhamLineOnPixels(layer.pixels,lineStartCell.c,lineStartCell.r,cell.c,cell.r,pxCurrentColor);
      if(pxMirrorMode) pxBresenhamLineOnPixels(layer.pixels,pxCols-1-lineStartCell.c,lineStartCell.r,pxCols-1-cell.c,cell.r,pxCurrentColor);
      if(!rafPending){rafPending=true;requestAnimationFrame(()=>{pxRenderAll();rafPending=false;});}
      return;
    }

    // Circle tool: live preview
    if(pxCurrentTool==='circle'&&circleStartCell&&circlePreviewSnapshot){
      const layer=pxLayers[pxCurrentLayerIndex];
      layer.pixels=circlePreviewSnapshot.slice();
      const dx=cell.c-circleStartCell.c,dy=cell.r-circleStartCell.r;
      const radius=Math.round(Math.sqrt(dx*dx+dy*dy));
      pxDrawCircleOnPixels(layer.pixels,circleStartCell.c,circleStartCell.r,radius,pxCurrentColor);
      if(pxMirrorMode) pxDrawCircleOnPixels(layer.pixels,pxCols-1-circleStartCell.c,circleStartCell.r,radius,pxCurrentColor);
      if(!rafPending){rafPending=true;requestAnimationFrame(()=>{pxRenderAll();rafPending=false;});}
      return;
    }

    // Rect tool: live preview
    if(pxCurrentTool==='rect'&&rectStartCell&&rectPreviewSnapshot){
      const layer=pxLayers[pxCurrentLayerIndex];
      layer.pixels=rectPreviewSnapshot.slice();
      pxDrawRectOnPixels(layer.pixels, rectStartCell.c, rectStartCell.r, cell.c, cell.r, pxCurrentColor, rectFillMode);
      if(pxMirrorMode){
        pxDrawRectOnPixels(layer.pixels, pxCols-1-rectStartCell.c, rectStartCell.r, pxCols-1-cell.c, cell.r, pxCurrentColor, rectFillMode);
      }
      if(!rafPending){rafPending=true;requestAnimationFrame(()=>{pxRenderAll();rafPending=false;});}
      return;
    }
  }
  function onUp(e){
    if(!pxIsDrawing) return;
    // Commit line on mouse up
    if(pxCurrentTool==='line'&&lineStartCell&&linePreviewSnapshot){
      const cell=pxMouseCell||lineStartCell;
      const layer=pxLayers[pxCurrentLayerIndex];
      layer.pixels=linePreviewSnapshot.slice();
      pxSaveHistory();
      layer.pixels=linePreviewSnapshot.slice();
      pxBresenhamLineOnPixels(layer.pixels, lineStartCell.c,lineStartCell.r,cell.c,cell.r,pxCurrentColor);
      if(pxMirrorMode){
        pxBresenhamLineOnPixels(layer.pixels, pxCols-1-lineStartCell.c,lineStartCell.r,pxCols-1-cell.c,cell.r,pxCurrentColor);
      }
      lineStartCell=null;
      linePreviewSnapshot=null;
      pxRenderAll();
    }
    // Commit circle on mouse up
    if(pxCurrentTool==='circle'&&circleStartCell&&circlePreviewSnapshot){
      const cell=pxMouseCell||circleStartCell;
      const layer=pxLayers[pxCurrentLayerIndex];
      layer.pixels=circlePreviewSnapshot.slice();
      pxSaveHistory();
      layer.pixels=circlePreviewSnapshot.slice();
      const dx=cell.c-circleStartCell.c;
      const dy=cell.r-circleStartCell.r;
      const radius=Math.round(Math.sqrt(dx*dx+dy*dy));
      pxDrawCircleOnPixels(layer.pixels, circleStartCell.c, circleStartCell.r, radius, pxCurrentColor);
      if(pxMirrorMode){
        pxDrawCircleOnPixels(layer.pixels, pxCols-1-circleStartCell.c, circleStartCell.r, radius, pxCurrentColor);
      }
      circleStartCell=null;
      circlePreviewSnapshot=null;
      pxRenderAll();
    }
    // Commit rect on mouse up
    if(pxCurrentTool==='rect'&&rectStartCell&&rectPreviewSnapshot){
      const cell=pxMouseCell||rectStartCell;
      const layer=pxLayers[pxCurrentLayerIndex];
      layer.pixels=rectPreviewSnapshot.slice();
      pxSaveHistory();
      layer.pixels=rectPreviewSnapshot.slice();
      pxDrawRectOnPixels(layer.pixels, rectStartCell.c, rectStartCell.r, cell.c, cell.r, pxCurrentColor, rectFillMode);
      if(pxMirrorMode){
        pxDrawRectOnPixels(layer.pixels, pxCols-1-rectStartCell.c, rectStartCell.r, pxCols-1-cell.c, cell.r, pxCurrentColor, rectFillMode);
      }
      rectStartCell=null;
      rectPreviewSnapshot=null;
      pxRenderAll();
    }
    pxIsDrawing=false;
    lastCell=null;
    document.querySelector('.px-viewport').classList.remove('panning');
  }
  function onLeave(e){
    if(pxCanvasReady) document.getElementById('pxCoordInfo').textContent='-';
    pxMouseCell=null;
    // If drawing a line and mouse leaves, restore snapshot (cancel preview but keep start)
    if(pxCurrentTool==='line'&&pxIsDrawing&&linePreviewSnapshot){
      pxLayers[pxCurrentLayerIndex].pixels=linePreviewSnapshot.slice();
    }
    if(pxCurrentTool==='circle'&&pxIsDrawing&&circlePreviewSnapshot){
      pxLayers[pxCurrentLayerIndex].pixels=circlePreviewSnapshot.slice();
    }
    if(pxCurrentTool==='rect'&&pxIsDrawing&&rectPreviewSnapshot){
      pxLayers[pxCurrentLayerIndex].pixels=rectPreviewSnapshot.slice();
    }
    pxRenderAll();
    onUp(e);
  }
  canvas.addEventListener('mousedown',onDown);
  canvas.addEventListener('mousemove',onMove);
  canvas.addEventListener('mouseup',onUp);
  canvas.addEventListener('mouseleave',onLeave);
  canvas.addEventListener('touchstart',onDown,{passive:false});
  canvas.addEventListener('touchmove',onMove,{passive:false});
  canvas.addEventListener('touchend',onUp,{passive:false});

  // Zoom with mouse wheel
  canvas.addEventListener('wheel',function(e){
    if(!pxCanvasReady) return;
    e.preventDefault();
    pxZoom(e.deltaY>0?-1:1);
  },{passive:false});

  // Zoom with pinch on touch devices (less sensitive)
  let lastTouchDistance=0;
  let pinchThreshold=30;
  canvas.addEventListener('touchmove',function(e){
    if(e.touches.length===2){
      const dx=e.touches[0].clientX-e.touches[1].clientX;
      const dy=e.touches[0].clientY-e.touches[1].clientY;
      const distance=Math.sqrt(dx*dx+dy*dy);
      if(lastTouchDistance>0){
        const delta=distance-lastTouchDistance;
        if(Math.abs(delta)>=pinchThreshold){
          pxZoom(delta>0?1:-1);
          lastTouchDistance=distance;
        }
      } else {
        lastTouchDistance=distance;
      }
    }
  },{passive:false});

  canvas.addEventListener('touchend',function(e){
    if(e.touches.length<2){
      lastTouchDistance=0;
    }
  },{passive:false});

  // Keyboard shortcuts
  document.addEventListener('keydown',function(e){
    if(!pxCanvasReady) return;
    if(document.getElementById('panel-pixel').style.display==='none'||!document.getElementById('panel-pixel').classList.contains('active')) return;
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
    
    // Pan tool: Space
    if(e.code==='Space'){
      e.preventDefault();
      if(pxCurrentTool!=='pan'){
        pxCurrentTool='pan';
        updateToolIcons();
        updatePanModeBar(true);
        showToast('‚úã ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô','info');
      }
      return;
    }
    
    const k=e.key.toLowerCase();
    
    // Zoom: +/- or =/- keys
    if(k==='+'||k==='='||k==='-'){
      if(k==='+'||k==='='){pxZoom(1);}
      else if(k==='-'){pxZoom(-1);}
      return;
    }
    
    // Tools: P=Pen, E=Erase, F=Fill, K=Pick, L=Line, C=Circle, R=Rect, G=Gradient
    const toolMap={p:'pen',e:'erase',f:'fill',k:'pick',l:'line',c:'circle',r:'rect',g:'gradient'};
    if(toolMap[k]){
      setPxTool(toolMap[k],null);
      updatePanModeBar(false);
      return;
    }
    
    // Mirror: M
    if(k==='m'){toggleMirror();return;}
  });
  
  // Release pan tool on spacebar up
  document.addEventListener('keyup',function(e){
    if(e.code==='Space'&&pxCurrentTool==='pan'){
      setPxTool('pen',null);
      updatePanModeBar(false);
    }
  });

  renderPalette();
  setPxColor('#000000');
});

function setPxTool(t,btn){
  pxCurrentTool=t;
  document.querySelectorAll('.px-tool-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  updateToolIcons();
  updatePanModeBar(t==='pan');
  // Update canvas cursor
  const canvas=document.getElementById('pxCanvasEl');
  if(canvas){
    if(t==='pan') canvas.style.cursor='grab';
    else canvas.style.cursor='crosshair';
  }
  // Show/hide color2 for gradient & dither
  const c2=document.getElementById('color2Wrap');
  if(c2){
    if(t==='gradient'||t==='dither'){c2.style.opacity='1';c2.style.pointerEvents='auto';}
    else{c2.style.opacity='0.4';c2.style.pointerEvents='none';}
  }
  // dither button active state
  const ditherBtn=document.getElementById('toolDither');
  if(ditherBtn) ditherBtn.classList.toggle('active',t==='dither');
  const names={pen:'‚úèÔ∏è',erase:'üßπ',fill:'ü™£',pick:'üíâ',pan:'‚úã',line:'üìè',rect:'‚ñ≠',circle:'‚≠ï',gradient:'üåà',dither:'‚ñ¶'};
  const infoEl=document.getElementById('pxInfoTool');
  if(infoEl) infoEl.textContent=names[t]||t;
}
function toggleMirror(){
  pxMirrorMode=!pxMirrorMode;
  const btn=document.getElementById('toolMirror');
  if(btn) btn.classList.toggle('active',pxMirrorMode);
  showToast(pxMirrorMode?'ü™û Mirror ON':'ü™û Mirror OFF',pxMirrorMode?'success':'info');
}
function setPxColor(hex){
  pxCurrentColor=hex;
  const box1=document.getElementById('pxCurColorBox');
  const box2=document.getElementById('pxCurColorBoxBar');
  if(box1) box1.style.background=hex;
  if(box2) box2.style.background=hex;
  const hex1=document.getElementById('pxColorHex');
  const hex2=document.getElementById('pxColorHexBar');
  if(hex1) hex1.textContent=hex;
  if(hex2) hex2.textContent=hex;
  document.querySelectorAll('.px-color-swatch').forEach(s=>s.classList.toggle('active',s.dataset.color===hex));
}
function setPxColor2(hex){
  pxColor2=hex;
  const box=document.getElementById('pxColor2Box');
  const hexEl=document.getElementById('pxColor2Hex');
  if(box) box.style.background=hex;
  if(hexEl) hexEl.textContent=hex;
}
function pxZoom(dir){
  const steps=[1,2,3,4,5,6,8,10,12,14,16,20,24,32,40,48,64];
  let idx=steps.indexOf(pxZoomLevel);
  if(idx===-1){idx=0;for(let i=0;i<steps.length;i++){if(steps[i]>=pxZoomLevel){idx=i;break;}}}
  idx=Math.max(0,Math.min(steps.length-1,idx+dir));
  pxZoomLevel=steps[idx]; if(pxCanvasReady) pxRenderAll(); pxUpdateInfo();
}

// Brush size
let pxBrushSize=1;
function changeBrushSize(dir){
  pxBrushSize=Math.max(1,Math.min(8,pxBrushSize+dir));
  const el=document.getElementById('brushSizeLabel');
  if(el) el.textContent=pxBrushSize;
}

// Grid toggle
let pxShowGrid=true;
function toggleGrid(){
  pxShowGrid=!pxShowGrid;
  const btn=document.getElementById('btnGrid');
  if(btn){btn.style.background=pxShowGrid?'var(--accent-light)':'var(--card)';btn.style.borderColor=pxShowGrid?'var(--accent)':'var(--border)';btn.style.color=pxShowGrid?'var(--accent)':'var(--text-muted)';}
  if(pxCanvasReady) pxRenderAll();
  showToast(pxShowGrid?'‚äû Grid ON':'‚äû Grid OFF','info');
}

// Layer move up/down
function pxMoveLayerUp(){
  if(!pxCanvasReady||pxCurrentLayerIndex>=pxLayers.length-1){showToast('‚ö†Ô∏è ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß','info');return;}
  const i=pxCurrentLayerIndex;
  [pxLayers[i],pxLayers[i+1]]=[pxLayers[i+1],pxLayers[i]];
  [pxLayerOffscreenCanvases[i],pxLayerOffscreenCanvases[i+1]]=[pxLayerOffscreenCanvases[i+1],pxLayerOffscreenCanvases[i]];
  pxCurrentLayerIndex++;
  pxRenderLayerList();pxRenderAll();
  showToast('‚¨ÜÔ∏è ‡∏¢‡πâ‡∏≤‡∏¢ Layer ‡∏Ç‡∏∂‡πâ‡∏ô','info');
}
function pxMoveLayerDown(){
  if(!pxCanvasReady||pxCurrentLayerIndex<=0){showToast('‚ö†Ô∏è ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß','info');return;}
  const i=pxCurrentLayerIndex;
  [pxLayers[i],pxLayers[i-1]]=[pxLayers[i-1],pxLayers[i]];
  [pxLayerOffscreenCanvases[i],pxLayerOffscreenCanvases[i-1]]=[pxLayerOffscreenCanvases[i-1],pxLayerOffscreenCanvases[i]];
  pxCurrentLayerIndex--;
  pxRenderLayerList();pxRenderAll();
  showToast('‚¨áÔ∏è ‡∏¢‡πâ‡∏≤‡∏¢ Layer ‡∏•‡∏á','info');
}

// Pan mode indicator
function updatePanModeBar(isPan){
  const bar=document.getElementById('panModeBar');
  if(bar) bar.classList.toggle('visible',isPan);
}

// Undo/Redo state buttons
function updateUndoRedoState(){
  const u=document.getElementById('btnUndo');
  const r=document.getElementById('btnRedo');
  if(u){u.style.opacity=pxHistory.length>0?'1':'0.35';u.style.cursor=pxHistory.length>0?'pointer':'default';}
  if(r){r.style.opacity=pxFuture.length>0?'1':'0.35';r.style.cursor=pxFuture.length>0?'pointer':'default';}
}

// Export menu
function toggleExportMenu(){
  const m=document.getElementById('exportMenu');
  if(m) m.style.display=m.style.display==='none'?'block':'none';
  event.stopPropagation();
}
document.addEventListener('click',function(e){
  const m=document.getElementById('exportMenu');
  if(m&&m.style.display!=='none'){
    if(!e.target.closest('#exportMenu')&&!e.target.closest('[onclick*="toggleExportMenu"]')){
      m.style.display='none';
    }
  }
});

function pxSaveAs(fmt){
  document.getElementById('exportMenu').style.display='none';
  if(!pxCanvasReady||!pxLayers.length){showToast('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö','error');return;}
  const out=document.createElement('canvas');
  out.width=pxCols; out.height=pxRows;
  const ctx=out.getContext('2d');
  if(fmt==='jpeg'){ctx.fillStyle='#ffffff';ctx.fillRect(0,0,pxCols,pxRows);}
  for(let layerIdx=0;layerIdx<pxLayers.length;layerIdx++){
    const layer=pxLayers[layerIdx];
    if(!layer.visible) continue;
    ctx.globalAlpha=layer.opacity;
    for(let i=0;i<layer.pixels.length;i++){
      if(!layer.pixels[i]) continue;
      ctx.fillStyle=layer.pixels[i];
      ctx.fillRect(i%pxCols,Math.floor(i/pxCols),1,1);
    }
    ctx.globalAlpha=1.0;
  }
  const mimeType=fmt==='jpeg'?'image/jpeg':'image/png';
  const ext=fmt==='jpeg'?'jpg':'png';
  out.toBlob(blob=>{
    const now=new Date();const pad=n=>String(n).padStart(2,'0');
    const filename=`TR_Pixel_${pxCols}x${pxRows}_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.${ext}`;
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();
    statsDownloads++;updateStats();
    showToast('üíæ Export '+ext.toUpperCase()+' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!','success');
  },mimeType,fmt==='jpeg'?0.9:undefined);
}

function pxSaveAsGif(){
  document.getElementById('exportMenu').style.display='none';
  // Create a simple GIF by downloading PNG with .gif extension + warning
  showToast('‚ÑπÔ∏è GIF export: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PNG (1 frame) ‡πÅ‡∏ó‡∏ô','info');
  pxSaveAs('png');
}

function pxSendToRemoveBg(){
  document.getElementById('exportMenu').style.display='none';
  if(!pxCanvasReady||!pxLayers.length){showToast('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö','error');return;}
  // Build flat canvas
  const out=document.createElement('canvas');
  out.width=pxCols; out.height=pxRows;
  const ctx=out.getContext('2d');
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,pxCols,pxRows);
  for(let layerIdx=0;layerIdx<pxLayers.length;layerIdx++){
    const layer=pxLayers[layerIdx];
    if(!layer.visible) continue;
    ctx.globalAlpha=layer.opacity;
    for(let i=0;i<layer.pixels.length;i++){
      if(!layer.pixels[i]) continue;
      ctx.fillStyle=layer.pixels[i];
      ctx.fillRect(i%pxCols,Math.floor(i/pxCols),1,1);
    }
    ctx.globalAlpha=1.0;
  }
  out.toBlob(blob=>{
    const filename=getTRFilename('Pixel_'+pxCols+'x'+pxRows);
    // Convert blob to File and load into remove-bg
    const file=new File([blob],filename,{type:'image/png'});
    // Switch to remove-bg panel
    showPanel('remove-bg');
    // Update sidebar/bottomnav active state
    document.querySelectorAll('.nav-item').forEach(el=>{
      el.classList.remove('active');
      if(el.getAttribute('onclick')&&el.getAttribute('onclick').includes('remove-bg')) el.classList.add('active');
    });
    document.querySelectorAll('.bnav-item').forEach(el=>{
      el.classList.remove('active');
      if(el.dataset.panel==='remove-bg') el.classList.add('active');
    });
    // Load image into remove-bg
    const dt=new DataTransfer(); dt.items.add(file);
    const fakeInput={files:dt.files};
    loadImageForBg(fakeInput);
    addLog('‡∏™‡πà‡∏á Pixel Art ‡πÑ‡∏õ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á','info');
    showToast('‚úÇÔ∏è ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß!','success');
  },'image/png');
}
function pxUpdateInfo(){
  document.getElementById('pxInfoSize').textContent=pxCols+'√ó'+pxRows;
  document.getElementById('pxZoomLabel').textContent='√ó'+pxZoomLevel;
}
function pxClear(){
  if(!pxCanvasReady) return;
  if(!confirm('‡∏•‡πâ‡∏≤‡∏á Layer ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏´‡∏°?')) return;
  pxSaveHistory();
  pxLayers[pxCurrentLayerIndex].pixels=new Array(pxCols*pxRows).fill(null);
  pxRenderAll();
  showToast('üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á Layer ‡πÅ‡∏•‡πâ‡∏ß','info');
}
function pxSave(){
  if(!pxCanvasReady||!pxLayers.length){showToast('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö','error');return;}
  const out=document.createElement('canvas');
  out.width=pxCols; out.height=pxRows;
  const ctx=out.getContext('2d');
  
  // Render all layers
  for(let layerIdx=0;layerIdx<pxLayers.length;layerIdx++){
    const layer=pxLayers[layerIdx];
    if(!layer.visible) continue;
    
    ctx.globalAlpha=layer.opacity;
    for(let i=0;i<layer.pixels.length;i++){
      if(!layer.pixels[i]) continue;
      ctx.fillStyle=layer.pixels[i];
      ctx.fillRect(i%pxCols,Math.floor(i/pxCols),1,1);
    }
    ctx.globalAlpha=1.0;
  }
  
  out.toBlob(blob=>{
    const filename=getTRFilename('Pixel_'+pxCols+'x'+pxRows);
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    const reader=new FileReader();
    reader.onloadend=()=>addToGallery(reader.result,filename,'pixel');
    reader.readAsDataURL(blob);
    statsDownloads++; addLog('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Pixel Art '+pxCols+'√ó'+pxRows,'success'); updateStats();
    showToast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Pixel Art ‡πÅ‡∏•‡πâ‡∏ß!','success');
  },'image/png');
}
function pxUploadImg(){document.getElementById('pxImgInput').click();}
function pxLoadImage(input){
  const file=input.files[0]; if(!file) return;
  const img=new Image();
  img.onload=function(){
    pxCols=Math.min(256,img.width); pxRows=Math.min(256,img.height);
    document.getElementById('pxW').value=pxCols; document.getElementById('pxH').value=pxRows;
    document.getElementById('pxW2').value=pxCols; document.getElementById('pxH2').value=pxRows;
    const maxDim=Math.max(pxCols,pxRows);
    if(maxDim<=8)pxZoomLevel=40;else if(maxDim<=16)pxZoomLevel=24;
    else if(maxDim<=32)pxZoomLevel=14;else if(maxDim<=64)pxZoomLevel=8;
    else if(maxDim<=128)pxZoomLevel=4;else pxZoomLevel=2;
    const tmp=document.createElement('canvas'); tmp.width=pxCols; tmp.height=pxRows;
    tmp.getContext('2d').drawImage(img,0,0,pxCols,pxRows);
    const id=tmp.getContext('2d').getImageData(0,0,pxCols,pxRows);
    
    const pixels=[];
    for(let i=0;i<pxCols*pxRows;i++){
      const r=id.data[i*4],g=id.data[i*4+1],b=id.data[i*4+2],a=id.data[i*4+3];
      pixels.push(a<30?null:'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''));
    }
    
    // Initialize layers
    if(!pxCanvasReady){
      pxLayers=[];
      pxLayerOffscreenCanvases=[];
      const firstLayer=new PxLayer(pxCols,pxRows,'Layer 1');
      firstLayer.pixels=pixels;
      pxLayers.push(firstLayer);
      pxCurrentLayerIndex=0;
      
      const offscreenCanvas=document.createElement('canvas');
      offscreenCanvas.width=pxCols;
      offscreenCanvas.height=pxRows;
      pxLayerOffscreenCanvases.push(offscreenCanvas);
    } else {
      const layer=new PxLayer(pxCols,pxRows,`Layer ${pxLayers.length+1}`);
      layer.pixels=pixels;
      pxLayers.push(layer);
      
      const offscreenCanvas=document.createElement('canvas');
      offscreenCanvas.width=pxCols;
      offscreenCanvas.height=pxRows;
      pxLayerOffscreenCanvases.push(offscreenCanvas);
      
      pxCurrentLayerIndex=pxLayers.length-1;
    }
    
    pxHistory=[]; pxFuture=[]; pxCanvasReady=true;
    document.getElementById('pxStart').style.display='none';
    document.getElementById('pxEditor').classList.add('visible');
    pxRenderLayerList(); pxRenderAll(); pxUpdateInfo();
    addLog('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏π‡∏õ: '+file.name+' ‚Üí '+pxCols+'√ó'+pxRows,'success');
    showToast('‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏π‡∏õ '+pxCols+'√ó'+pxRows+' pixels','success');
  };
  img.src=URL.createObjectURL(file); input.value='';
}

function renderPalette(){
  const grid=document.getElementById('pxPaletteGrid'); if(!grid) return;
  grid.innerHTML='';
  pxPalette.forEach((color,index)=>{
    const sw=document.createElement('div');
    sw.className='px-color-swatch'; sw.style.background=color; sw.dataset.color=color; sw.title=color; sw.draggable=true;
    sw.onclick=e=>{if(e.target.classList.contains('del'))return;setPxColor(color);document.getElementById('pxColorPicker').value=color;};
    const del=document.createElement('div'); del.className='del'; del.textContent='√ó';
    del.onclick=e=>{e.stopPropagation();pxPalette.splice(index,1);renderPalette();showToast('üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏µ‡πÅ‡∏•‡πâ‡∏ß','info');};
    sw.appendChild(del);
    sw.addEventListener('dragstart',()=>{draggedSwatch=index;sw.style.opacity='0.5';});
    sw.addEventListener('dragend',()=>{sw.style.opacity='1';draggedSwatch=null;});
    sw.addEventListener('dragover',e=>{e.preventDefault();sw.style.transform='scale(1.1)';});
    sw.addEventListener('dragleave',()=>{sw.style.transform='scale(1)';});
    sw.addEventListener('drop',e=>{
      e.preventDefault(); sw.style.transform='scale(1)';
      if(draggedSwatch!==null&&draggedSwatch!==index){
        const temp=pxPalette[draggedSwatch]; pxPalette[draggedSwatch]=pxPalette[index]; pxPalette[index]=temp;
        renderPalette(); showToast('üîÑ ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà','info');
      }
    });
    grid.appendChild(sw);
  });
}
function addColorToPalette(){
  if(pxPalette.indexOf(pxCurrentColor)===-1){pxPalette.push(pxCurrentColor);renderPalette();showToast('‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡πÅ‡∏•‡πâ‡∏ß','success');}
  else showToast('‚ÑπÔ∏è ‡∏°‡∏µ‡∏™‡∏µ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß','info');
}
function resetPalette(){pxPalette=DEFAULT_PALETTE.slice();renderPalette();showToast('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏≤‡πÄ‡∏•‡∏ó','info');}

// ============================================================
// LAYER MANAGEMENT
// ============================================================
function pxAddLayer(){
  if(!pxCanvasReady) return;
  const layer=new PxLayer(pxCols,pxRows,`Layer ${pxLayers.length+1}`);
  pxLayers.push(layer);
  
  const offscreenCanvas=document.createElement('canvas');
  offscreenCanvas.width=pxCols;
  offscreenCanvas.height=pxRows;
  pxLayerOffscreenCanvases.push(offscreenCanvas);
  
  pxCurrentLayerIndex=pxLayers.length-1;
  pxRenderLayerList();
  pxRenderAll();
  showToast('‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà','success');
}

function pxDeleteLayer(){
  if(!pxCanvasReady||pxLayers.length<=1) {
    showToast('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡∏±‡πâ‡∏ô','warning');
    return;
  }
  pxLayers.splice(pxCurrentLayerIndex,1);
  pxLayerOffscreenCanvases.splice(pxCurrentLayerIndex,1);
  pxCurrentLayerIndex=Math.max(0,pxCurrentLayerIndex-1);
  pxRenderLayerList();
  pxRenderAll();
  showToast('üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß','success');
}

function pxSelectLayer(idx){
  pxCurrentLayerIndex=idx;
  pxRenderLayerList();
  pxRenderAll();
}

function pxToggleLayerVisibility(idx){
  pxLayers[idx].visible=!pxLayers[idx].visible;
  pxRenderLayerList();
  pxRenderAll();
}

function pxSetLayerOpacity(idx,opacity){
  pxLayers[idx].opacity=opacity;
  pxRenderAll();
}

function pxRenderLayerList(){
  const list=document.getElementById('pxLayerList');
  if(!list) return;
  list.innerHTML='';
  
  for(let i=pxLayers.length-1;i>=0;i--){
    const layer=pxLayers[i];
    const isActive=i===pxCurrentLayerIndex;
    const item=document.createElement('div');
    item.style.cssText='display:flex;align-items:center;gap:6px;padding:6px;background:'+(isActive?'var(--accent-light)':'var(--card)')+';border:1px solid '+(isActive?'var(--accent)':'var(--border)')+';border-radius:6px;cursor:pointer;';
    
    const eyeBtn=document.createElement('button');
    eyeBtn.innerHTML=layer.visible?'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
    eyeBtn.style.cssText='background:none;border:none;cursor:pointer;color:var(--text-muted);padding:2px 4px;display:flex;align-items:center;';
    eyeBtn.title=layer.visible?'‡∏ã‡πà‡∏≠‡∏ô Layer':'‡πÅ‡∏™‡∏î‡∏á Layer';
    eyeBtn.onclick=(e)=>{e.stopPropagation();pxToggleLayerVisibility(i);};
    
    const label=document.createElement('span');
    label.textContent=layer.name;
    label.style.cssText='flex:1;font-size:12px;color:'+(isActive?'var(--accent)':'var(--text)')+';font-weight:'+(isActive?'700':'600')+';';
    
    const opacitySlider=document.createElement('input');
    opacitySlider.type='range';
    opacitySlider.min='0';
    opacitySlider.max='100';
    opacitySlider.value=layer.opacity*100;
    opacitySlider.style.cssText='width:40px;height:20px;cursor:pointer;';
    opacitySlider.title='‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö: '+Math.round(layer.opacity*100)+'%';
    opacitySlider.onchange=(e)=>{pxSetLayerOpacity(i,parseInt(e.target.value)/100);};
    
    item.onclick=()=>pxSelectLayer(i);
    item.appendChild(eyeBtn);
    item.appendChild(label);
    item.appendChild(opacitySlider);
    list.appendChild(item);
  }

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï layer indicator ‡πÉ‡∏ô topbar
  const indicator=document.getElementById('pxLayerIndicator');
  const indName=document.getElementById('pxLayerIndicatorName');
  const indNum=document.getElementById('pxLayerIndicatorNum');
  if(indicator&&pxLayers.length>0){
    indicator.style.display='flex';
    indName.textContent=pxLayers[pxCurrentLayerIndex]?.name||'Layer';
    indNum.textContent=(pxCurrentLayerIndex+1)+'/'+pxLayers.length;
  }
}

// ============================================================
// ZOOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
// ============================================================
const zoomState={orig:100, result:100};
const zoomSteps=[25,50,75,100,125,150,200,300,400];

function zoomImg(target, dir){
  if(dir===0){
    zoomState[target]=100;
  } else {
    const steps=zoomSteps;
    let idx=steps.findIndex(s=>s>=zoomState[target]);
    if(idx===-1) idx=steps.length-1;
    idx=Math.max(0,Math.min(steps.length-1, idx+dir));
    zoomState[target]=steps[idx];
  }
  const pct=zoomState[target];
  const label=pct+'%';

  if(target==='orig'){
    document.getElementById('origZoomPct').textContent=label;
    const img=document.querySelector('#originalPreview img');
    if(img){
      img.style.width=pct+'%';
      img.style.height='auto';
      img.style.maxWidth='none';
      img.style.maxHeight='none';
      img.style.transform='';
    }
  } else {
    document.getElementById('resultZoomPct').textContent=label;
    const canvas=document.getElementById('rmbgResultCanvas');
    if(canvas){
      canvas.style.width=pct+'%';
      canvas.style.height='auto';
      canvas.style.maxWidth='none';
      canvas.style.maxHeight='none';
      canvas.style.transform='';
    }
  }
}

addLog('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','success');

// ============================================================
// THEME TOGGLE
// ============================================================
function toggleTheme(){
  const isLight=document.body.classList.toggle('light-mode');
  document.getElementById('themeToggleBtn').textContent=isLight?'‚òÄÔ∏è':'üåô';
  localStorage.setItem('trTheme',isLight?'light':'dark');
}
(function initTheme(){
  if(localStorage.getItem('trTheme')==='light'){
    document.body.classList.add('light-mode');
    const btn=document.getElementById('themeToggleBtn');
    if(btn) btn.textContent='‚òÄÔ∏è';
  }
})();

// ============================================================
// DRAG & DROP ‚Äî ‡∏ó‡∏±‡πâ‡∏á Remove BG ‡πÅ‡∏•‡∏∞ Pixel Art
// ============================================================
(function initDragDrop(){
  const overlay=document.getElementById('dropOverlay');
  const sub=document.getElementById('dropOverlaySub');
  let dragCounter=0;

  document.addEventListener('dragenter',e=>{
    e.preventDefault();
    dragCounter++;
    const panel=document.querySelector('.panel.active');
    const pid=panel?panel.id:'';
    if(pid==='panel-pixel') sub.textContent='‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ Pixel Art Editor';
    else if(pid==='panel-remove-bg') sub.textContent='‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á';
    else sub.textContent='‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà';
    overlay.classList.add('active');
  });
  document.addEventListener('dragleave',e=>{
    dragCounter--;
    if(dragCounter<=0){dragCounter=0;overlay.classList.remove('active');}
  });
  document.addEventListener('dragover',e=>e.preventDefault());
  document.addEventListener('drop',e=>{
    e.preventDefault();
    dragCounter=0;
    overlay.classList.remove('active');
    const file=e.dataTransfer.files[0];
    if(!file||!file.type.startsWith('image/')) return;
    const panel=document.querySelector('.panel.active');
    const pid=panel?panel.id:'';
    if(pid==='panel-pixel'){
      // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ pixel art
      const dt=new DataTransfer(); dt.items.add(file);
      const fakeInput={files:dt.files};
      pxLoadImage(fakeInput);
      showToast('üéÆ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤ Pixel Art ‡πÅ‡∏•‡πâ‡∏ß','success');
    } else {
      // default: ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ remove bg
      if(pid!=='panel-remove-bg') showPanel('remove-bg');
      const reader=new FileReader();
      reader.onload=ev=>{
        originalImage=ev.target.result;
        const preview=document.getElementById('originalPreview');
        preview.innerHTML=`<img src="${originalImage}" alt="Original" style="width:100%;height:auto;max-width:none;max-height:none;">`;
        document.getElementById('resultPlaceholder').style.display='flex';
        document.getElementById('rmbgResultCanvas').style.display='none';
        document.getElementById('rmbgToolbar').style.display='none';
      };
      reader.readAsDataURL(file);
      showToast('‚úÇÔ∏è ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß','success');
    }
  });
})();

// ============================================================
// DITHER TOOL
// ============================================================
function pxDither(cell, color1, color2){
  const layer=pxLayers[pxCurrentLayerIndex];
  const half=Math.floor(pxBrushSize/2);
  for(let dr=-half;dr<=half;dr++){
    for(let dc=-half;dc<=half;dc++){
      const nc=cell.c+dc, nr=cell.r+dr;
      if(nc<0||nc>=pxCols||nr<0||nr>=pxRows) continue;
      // checkerboard pattern
      const color=(nc+nr)%2===0 ? color1 : color2;
      layer.pixels[nr*pxCols+nc]=color;
      if(pxMirrorMode) layer.pixels[nr*pxCols+(pxCols-1-nc)]=color;
    }
  }
}

// keyboard shortcut for D key (dither)
document.addEventListener('keydown',function(e){
  if(!pxCanvasReady) return;
  if(document.activeElement&&['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if(e.key==='d'||e.key==='D') setPxTool('dither');
});

// ============================================================
// ANIMATION FRAMES
// ============================================================
let animFrames=[];       // each frame = deep copy of pxLayers
let animCurrentFrame=0;
let animPlayInterval=null;
let animPlaying=true;

function animSnapshotLayers(){
  return pxLayers.map(l=>({...l, pixels:l.pixels.slice()}));
}

function animRenderStrip(){
  const strip=document.getElementById('animFrameStrip');
  if(!strip) return;
  strip.innerHTML='';
  animFrames.forEach((frame,idx)=>{
    const thumb=document.createElement('canvas');
    thumb.width=pxCols; thumb.height=pxRows;
    thumb.className='anim-frame-thumb'+(idx===animCurrentFrame?' active':'');
    thumb.title='‡πÄ‡∏ü‡∏£‡∏° '+(idx+1);
    // render frame
    const ctx=thumb.getContext('2d');
    frame.forEach(layer=>{
      if(!layer.visible) return;
      ctx.globalAlpha=layer.opacity;
      layer.pixels.forEach((c,i)=>{
        if(!c) return;
        ctx.fillStyle=c;
        ctx.fillRect(i%pxCols,Math.floor(i/pxCols),1,1);
      });
      ctx.globalAlpha=1;
    });
    const num=document.createElement('span');
    num.className='frame-num'; num.textContent=idx+1;
    const wrap=document.createElement('div');
    wrap.style.cssText='position:relative;flex-shrink:0;';
    wrap.appendChild(thumb);
    wrap.appendChild(num);
    wrap.onclick=()=>animSelectFrame(idx);
    strip.appendChild(wrap);
  });
  // add button
  const addBtn=document.createElement('button');
  addBtn.className='anim-frame-add'; addBtn.textContent='+';
  addBtn.title='‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ü‡∏£‡∏°'; addBtn.onclick=animAddFrame;
  strip.appendChild(addBtn);
}

function animSaveCurrentToFrame(){
  if(animFrames.length===0) return;
  animFrames[animCurrentFrame]=animSnapshotLayers();
}

function animAddFrame(){
  if(!pxCanvasReady){showToast('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö','error');return;}
  animSaveCurrentToFrame();
  // new empty frame
  const newFrame=pxLayers.map(l=>({...l,pixels:new Array(pxCols*pxRows).fill(null)}));
  animFrames.push(newFrame);
  animCurrentFrame=animFrames.length-1;
  // load new frame
  pxLayers=animFrames[animCurrentFrame].map(l=>({...l,pixels:l.pixels.slice()}));
  pxRenderAll();
  animRenderStrip();
  showToast('‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ü‡∏£‡∏° '+(animFrames.length),'success');
}

function animSelectFrame(idx){
  if(idx===animCurrentFrame) return;
  animSaveCurrentToFrame();
  animCurrentFrame=idx;
  pxLayers=animFrames[animCurrentFrame].map(l=>({...l,pixels:l.pixels.slice()}));
  pxRenderAll();
  animRenderStrip();
  showToast('üìë ‡πÄ‡∏ü‡∏£‡∏° '+(idx+1)+' / '+animFrames.length,'info');
}

function animDeleteFrame(){
  if(animFrames.length<=1){showToast('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏ü‡∏£‡∏°','warning');return;}
  animFrames.splice(animCurrentFrame,1);
  animCurrentFrame=Math.max(0,animCurrentFrame-1);
  pxLayers=animFrames[animCurrentFrame].map(l=>({...l,pixels:l.pixels.slice()}));
  pxRenderAll();
  animRenderStrip();
  showToast('üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏ü‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß','info');
}

function openAnimPreview(){
  if(!pxCanvasReady||animFrames.length===0){showToast('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ü‡∏£‡∏°‡∏Å‡πà‡∏≠‡∏ô','error');return;}
  animSaveCurrentToFrame();
  document.getElementById('animPreviewModal').classList.add('show');
  animPlayLoop();
}
function closeAnimPreview(){
  document.getElementById('animPreviewModal').classList.remove('show');
  clearInterval(animPlayInterval); animPlayInterval=null;
}

let _animPlayIdx=0;
function animPlayLoop(){
  clearInterval(animPlayInterval);
  const fps=parseInt(document.getElementById('animFpsSlider').value)||6;
  animPlayInterval=setInterval(()=>{
    _animPlayIdx=(_animPlayIdx+1)%animFrames.length;
    renderAnimPreviewFrame(_animPlayIdx);
  },1000/fps);
  renderAnimPreviewFrame(_animPlayIdx);
}
function renderAnimPreviewFrame(idx){
  const c=document.getElementById('animPreviewCanvas');
  const scale=Math.min(280/pxCols,280/pxRows,8);
  c.width=pxCols*scale; c.height=pxRows*scale;
  const ctx=c.getContext('2d');
  ctx.imageSmoothingEnabled=false;
  const frame=animFrames[idx]||animFrames[0];
  frame.forEach(layer=>{
    if(!layer.visible) return;
    ctx.globalAlpha=layer.opacity;
    layer.pixels.forEach((col,i)=>{
      if(!col) return;
      ctx.fillStyle=col;
      ctx.fillRect((i%pxCols)*scale,Math.floor(i/pxCols)*scale,scale,scale);
    });
    ctx.globalAlpha=1;
  });
}
function updateAnimFps(v){
  document.getElementById('animFpsLabel').textContent=v;
  if(animPlayInterval) animPlayLoop();
}
function toggleAnimPlay(){
  if(animPlayInterval){clearInterval(animPlayInterval);animPlayInterval=null;document.querySelector('[onclick="toggleAnimPlay()"]').textContent='‚ñ∂Ô∏è';}
  else{animPlayLoop();document.querySelector('[onclick="toggleAnimPlay()"]').textContent='‚è∏Ô∏è';}
}

function saveAnimAs(fmt){
  closeAnimPreview();
  animSaveCurrentToFrame();
  if(fmt==='png'||animFrames.length===1){
    // save current frame as PNG
    pxSave();
    return;
  }
  // GIF ‚Äî use manual pixel-by-pixel encoder
  showToast('üéûÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á GIF...','info');
  setTimeout(()=>{
    try{
      const fps=parseInt(document.getElementById('animFpsSlider').value)||6;
      const delay=Math.round(100/fps);
      const gif=new GIFEncoder(pxCols,pxRows);
      gif.setRepeat(0); gif.setDelay(delay*10); gif.start();
      animFrames.forEach(frame=>{
        const tmp=document.createElement('canvas');
        tmp.width=pxCols; tmp.height=pxRows;
        const ctx=tmp.getContext('2d');
        frame.forEach(layer=>{
          if(!layer.visible) return;
          ctx.globalAlpha=layer.opacity;
          layer.pixels.forEach((c,i)=>{if(c){ctx.fillStyle=c;ctx.fillRect(i%pxCols,Math.floor(i/pxCols),1,1);}});
          ctx.globalAlpha=1;
        });
        gif.addFrame(ctx);
      });
      gif.finish();
      const blob=new Blob([gif.stream().getData()],{type:'image/gif'});
      const now=new Date();const pad=n=>String(n).padStart(2,'0');
      const fn=`TR_Anim_${pxCols}x${pxRows}_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.gif`;
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fn;a.click();
      statsDownloads++;updateStats();
      showToast('üéûÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å GIF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ('+animFrames.length+' ‡πÄ‡∏ü‡∏£‡∏°)','success');
    }catch(err){
      // fallback: save PNG sprite sheet
      showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á GIF ‡πÑ‡∏î‡πâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PNG ‡πÅ‡∏ó‡∏ô','warning');
      pxSave();
    }
  },100);
}

// Minimal GIF encoder
function GIFEncoder(w,h){
  this.w=w;this.h=h;this.frames=[];this.repeat=0;this.delay=100;
  this.start=function(){};
  this.setRepeat=function(r){this.repeat=r;};
  this.setDelay=function(d){this.delay=d;};
  this.addFrame=function(ctx){this.frames.push(ctx.getImageData(0,0,this.w,this.h));};
  this.finish=function(){this._build();};
  this.stream=function(){return{getData:()=>this._data};};
  this._build=function(){
    // Build GIF89a binary
    const w=this.w,h=this.h;
    const bytes=[];
    const push=(b)=>{if(Array.isArray(b))b.forEach(x=>bytes.push(x));else bytes.push(b);};
    const pushStr=(s)=>{for(let i=0;i<s.length;i++)bytes.push(s.charCodeAt(i));};
    const pushWord=(v)=>{bytes.push(v&0xff);bytes.push((v>>8)&0xff);};
    // GIF header
    pushStr('GIF89a');
    pushWord(w);pushWord(h);
    push(0x80|0x70);// global color table flag, 8bpp
    push(0);push(0);// bg, aspect
    // Build global color table from first frame
    const {palette,indexMap}=buildPalette(this.frames[0]);
    const ctSize=256;
    for(let i=0;i<ctSize;i++){
      const c=palette[i]||[0,0,0];
      push(c[0]);push(c[1]);push(c[2]);
    }
    // Netscape loop extension
    pushStr('\x21\xff\x0bNETSCAPE2.0\x03\x01');
    pushWord(this.repeat);push(0);
    // Frames
    this.frames.forEach((frame)=>{
      const {palette:fp,indexMap:fim}=buildPalette(frame);
      // Graphic control
      push(0x21);push(0xf9);push(4);
      push(0x08);// dispose=2
      pushWord(this.delay);push(0);push(0);
      // Image descriptor
      push(0x2c);
      pushWord(0);pushWord(0);pushWord(w);pushWord(h);
      push(0x80|0x07);// local color table, 8bpp
      for(let i=0;i<256;i++){const c=fp[i]||[0,0,0];push(c[0]);push(c[1]);push(c[2]);}
      // LZW compressed pixels
      const pixels=[];
      for(let i=0;i<w*h;i++){
        const r=frame.data[i*4],g=frame.data[i*4+1],b=frame.data[i*4+2],a=frame.data[i*4+3];
        if(a<128) pixels.push(0);
        else pixels.push(fim[`${r},${g},${b}`]||0);
      }
      const lzw=lzwEncode(pixels,8);
      push(8);// LZW min code size
      // write in blocks
      let off=0;
      while(off<lzw.length){
        const chunk=Math.min(255,lzw.length-off);
        push(chunk);
        for(let i=0;i<chunk;i++)push(lzw[off+i]);
        off+=chunk;
      }
      push(0);// block terminator
    });
    push(0x3b);// trailer
    this._data=new Uint8Array(bytes);
  };
}
function buildPalette(imageData){
  const colorMap={};const palette=[];const indexMap={};
  for(let i=0;i<imageData.data.length;i+=4){
    const r=imageData.data[i],g=imageData.data[i+1],b=imageData.data[i+2],a=imageData.data[i+3];
    if(a<128){continue;}
    // quantize to 6-bit per channel
    const qr=r&0xfc,qg=g&0xfc,qb=b&0xfc;
    const key=`${qr},${qg},${qb}`;
    if(!colorMap[key]&&palette.length<255){
      colorMap[key]=palette.length;
      palette.push([qr,qg,qb]);
      indexMap[key]=palette.length-1;
    }
  }
  while(palette.length<256) palette.push([0,0,0]);
  return{palette,indexMap:colorMap};
}
function lzwEncode(pixels,minCodeSize){
  const clearCode=1<<minCodeSize;
  const eoi=clearCode+1;
  let codeSize=minCodeSize+1;
  let nextCode=eoi+1;
  const table={};
  const output=[];
  let bits=0,bitBuf=0;
  function emit(code){
    bitBuf|=code<<bits;bits+=codeSize;
    while(bits>=8){output.push(bitBuf&0xff);bitBuf>>=8;bits-=8;}
  }
  function initTable(){
    const t={};for(let i=0;i<clearCode;i++)t[String(i)]=i;return t;}
  let tbl=initTable();nextCode=eoi+1;codeSize=minCodeSize+1;
  emit(clearCode);
  let index=0;
  let buf=String(pixels[index]);
  for(let i=1;i<pixels.length;i++){
    const c=String(pixels[i]);
    const nc=buf+','+c;
    if(tbl[nc]!==undefined){buf=nc;}
    else{
      emit(tbl[buf]);
      if(nextCode<4096){tbl[nc]=nextCode++;if(nextCode>(1<<codeSize)&&codeSize<12)codeSize++;}
      else{emit(clearCode);tbl=initTable();nextCode=eoi+1;codeSize=minCodeSize+1;}
      buf=c;
    }
  }
  emit(tbl[buf]);
  emit(eoi);
  if(bits>0)output.push(bitBuf&0xff);
  return output;
}

// ============================================================
// SMART EDGE DETECT ‚Äî ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ
// ============================================================

function smartEdgeErase(sx,sy){
  if(!rmbgCtx||!rmbgCanvas) return;
  const sensitivity=parseInt(document.getElementById('rmbgEdgeSensitivity').value)||30;
  const id=rmbgCtx.getImageData(0,0,rmbgCanvas.width,rmbgCanvas.height);
  const data=id.data,w=rmbgCanvas.width,h=rmbgCanvas.height;
  const si=(sy*w+sx)*4;
  const tR=data[si],tG=data[si+1],tB=data[si+2];
  if(data[si+3]===0) return; // already transparent

  function colorDiff(i,j){
    return Math.sqrt(
      Math.pow(data[j]-data[i],2)+
      Math.pow(data[j+1]-data[i+1],2)+
      Math.pow(data[j+2]-data[i+2],2)
    );
  }

  const visited=new Uint8Array(w*h);
  const queue=[[sx,sy]];
  visited[sy*w+sx]=1;
  while(queue.length){
    const[x,y]=queue.shift();
    const i=(y*w+x)*4;
    if(data[i+3]===0) continue;
    data[i+3]=0;
    for(const[nx,ny] of[[x+1,y],[x-1,y],[x,y+1],[x,y-1]]){
      if(nx<0||ny<0||nx>=w||ny>=h||visited[ny*w+nx]) continue;
      visited[ny*w+nx]=1;
      const ni=(ny*w+nx)*4;
      if(data[ni+3]===0) continue;
      // check diff from seed color
      const diffFromSeed=Math.abs(data[ni]-tR)+Math.abs(data[ni+1]-tG)+Math.abs(data[ni+2]-tB);
      // check gradient (edge detection) ‚Äî diff from neighbor
      const diffFromNeighbor=colorDiff(i,ni);
      // ‡∏ñ‡πâ‡∏≤‡∏™‡∏µ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô sensitivity ‡∏´‡∏£‡∏∑‡∏≠ gradient ‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å = ‡∏´‡∏¢‡∏∏‡∏î
      if(diffFromSeed<sensitivity*3 && diffFromNeighbor<sensitivity*1.5){
        queue.push([nx,ny]);
      }
    }
  }
  rmbgCtx.putImageData(id,0,0);
}

function updateEdgeLabel(v){document.getElementById('rmbgEdgeLabel').textContent=v;}

</script>
</body>
</html>
